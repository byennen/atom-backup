
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _require = require('./utils');

var log = _require.log;
var base64Decode = _require.base64Decode;

var _require2 = require('./ObjectId');

var remoteObjectIdOfObjectId = _require2.remoteObjectIdOfObjectId;
var pagedObjectId = _require2.pagedObjectId;
var singlePageObjectId = _require2.singlePageObjectId;

/**
 * Converts a dbgp value to a Chrome RemoteObject.
 */
function convertValue(contextId, dbgpProperty) {
  switch (dbgpProperty.$.type) {
    case 'string':
      return convertStringValue(dbgpProperty);
    case 'int':
      return convertIntValue(dbgpProperty);
    case 'float':
      return convertFloatValue(dbgpProperty);
    case 'bool':
      return convertBoolValue(dbgpProperty);
    case 'null':
      return convertNullValue(dbgpProperty);
    case 'array':
      return convertArrayValue(contextId, dbgpProperty);
    case 'object':
      return convertObjectValue(contextId, dbgpProperty);
    default:
      // TODO: Remaining property types - closure, hashmap, ...
      return convertUnknownValue(dbgpProperty);
  }
}

function convertStringValue(dbgpProperty) {
  var value;
  if (dbgpProperty.hasOwnProperty('_')) {
    value = dbgpProperty.$.encoding === 'base64' ? base64Decode(dbgpProperty._) : 'TODO: Non-base64 encoded string: ' + JSON.stringify(dbgpProperty);
  } else {
    // zero length strings have no dbgpProperty._ property
    value = '';
  }

  return {
    type: 'string',
    value: value
  };
}

function convertIntValue(dbgpProperty) {
  var value = dbgpProperty.$.encoding === 'base64' ? 'TODO: Base64 encoded int: ' + JSON.stringify(dbgpProperty) : Number(dbgpProperty._);
  return {
    type: 'number',
    value: value
  };
}

function convertFloatValue(dbgpProperty) {
  var value = dbgpProperty.$.encoding === 'base64' ? 'TODO: Base64 encoded float: ' + JSON.stringify(dbgpProperty) : Number(dbgpProperty._);
  return {
    type: 'number',
    value: value
  };
}

function convertBoolValue(dbgpProperty) {
  var value = dbgpProperty.$.encoding === 'base64' ? 'TODO: Base64 encoded bool: ' + JSON.stringify(dbgpProperty) : toBool(dbgpProperty._);
  return {
    type: 'boolean',
    value: value
  };
}

function convertNullValue(dbgpProperty) {
  return {
    type: 'undefined',
    subtype: 'null',
    value: null
  };
}

function convertArrayValue(contextId, dbgpProperty) {
  var remoteId = getAggregateRemoteObjectId(contextId, dbgpProperty);
  return {
    description: 'Array[' + dbgpProperty.$.numchildren + ']',
    type: 'object',
    subtype: 'array',
    objectId: remoteId
  };
}

function convertObjectValue(contextId, dbgpProperty) {
  var remoteId = getAggregateRemoteObjectId(contextId, dbgpProperty);
  return {
    description: dbgpProperty.$.classname,
    type: 'object',
    objectId: remoteId
  };
}

function getAggregateRemoteObjectId(contextId, dbgpProperty) {
  var numchildren = Number(dbgpProperty.$.numchildren);
  var pagesize = Number(dbgpProperty.$.pagesize);
  var pageCount = Math.trunc((numchildren + pagesize - 1) / pagesize);
  log('numchildren: ' + numchildren + ' pagesize: ' + pagesize + ' pageCount ' + pageCount);
  if (pageCount > 1) {
    var elementRange = {
      pagesize: pagesize,
      startIndex: 0,
      count: numchildren
    };
    return remoteObjectIdOfObjectId(pagedObjectId(contextId, dbgpProperty.$.fullname, elementRange));
  } else {
    return remoteObjectIdOfObjectId(singlePageObjectId(contextId, dbgpProperty.$.fullname, 0));
  }
}

function convertUnknownValue(dbgpProperty) {
  return {
    type: 'string',
    value: 'TODO: unknown: ' + JSON.stringify(dbgpProperty)
  };
}

function toBool(value) {
  switch (value) {
    case '0':
      return false;
    case '1':
      return true;
    default:
      return 'Unexpected bool value: ' + value;
  }
}

module.exports = { convertValue: convertValue };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL3ZhbHVlcy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUM7Ozs7Ozs7Ozs7ZUFZYyxPQUFPLENBQUMsU0FBUyxDQUFDOztJQUF2QyxHQUFHLFlBQUgsR0FBRztJQUFFLFlBQVksWUFBWixZQUFZOztnQkFLbEIsT0FBTyxDQUFDLFlBQVksQ0FBQzs7SUFIdkIsd0JBQXdCLGFBQXhCLHdCQUF3QjtJQUN4QixhQUFhLGFBQWIsYUFBYTtJQUNiLGtCQUFrQixhQUFsQixrQkFBa0I7Ozs7O0FBUXBCLFNBQVMsWUFBWSxDQUFDLFNBQW1CLEVBQUUsWUFBMEIsRUFBZ0I7QUFDbkYsVUFBUSxZQUFZLENBQUMsQ0FBQyxDQUFDLElBQUk7QUFDM0IsU0FBSyxRQUFRO0FBQ1gsYUFBTyxrQkFBa0IsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUFBLEFBQzFDLFNBQUssS0FBSztBQUNSLGFBQU8sZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQUEsQUFDdkMsU0FBSyxPQUFPO0FBQ1YsYUFBTyxpQkFBaUIsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUFBLEFBQ3pDLFNBQUssTUFBTTtBQUNULGFBQU8sZ0JBQWdCLENBQUMsWUFBWSxDQUFDLENBQUM7QUFBQSxBQUN4QyxTQUFLLE1BQU07QUFDVCxhQUFPLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQUEsQUFDeEMsU0FBSyxPQUFPO0FBQ1YsYUFBTyxpQkFBaUIsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFBQSxBQUNwRCxTQUFLLFFBQVE7QUFDWCxhQUFPLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxZQUFZLENBQUMsQ0FBQztBQUFBLEFBQ3JEOztBQUVFLGFBQU8sbUJBQW1CLENBQUMs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L2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1kZWJ1Z2dlci1oaHZtLXByb3h5L2xpYi92YWx1ZXMuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5cbnZhciB7bG9nLCBiYXNlNjREZWNvZGV9ID0gcmVxdWlyZSgnLi91dGlscycpO1xudmFyIHtcbiAgcmVtb3RlT2JqZWN0SWRPZk9iamVjdElkLFxuICBwYWdlZE9iamVjdElkLFxuICBzaW5nbGVQYWdlT2JqZWN0SWQsXG59ID0gcmVxdWlyZSgnLi9PYmplY3RJZCcpO1xuXG5cblxuLyoqXG4gKiBDb252ZXJ0cyBhIGRiZ3AgdmFsdWUgdG8gYSBDaHJvbWUgUmVtb3RlT2JqZWN0LlxuICovXG5mdW5jdGlvbiBjb252ZXJ0VmFsdWUoY29udGV4dElkOiBPYmplY3RJZCwgZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3Qge1xuICBzd2l0Y2ggKGRiZ3BQcm9wZXJ0eS4kLnR5cGUpIHtcbiAgY2FzZSAnc3RyaW5nJzpcbiAgICByZXR1cm4gY29udmVydFN0cmluZ1ZhbHVlKGRiZ3BQcm9wZXJ0eSk7XG4gIGNhc2UgJ2ludCc6XG4gICAgcmV0dXJuIGNvbnZlcnRJbnRWYWx1ZShkYmdwUHJvcGVydHkpO1xuICBjYXNlICdmbG9hdCc6XG4gICAgcmV0dXJuIGNvbnZlcnRGbG9hdFZhbHVlKGRiZ3BQcm9wZXJ0eSk7XG4gIGNhc2UgJ2Jvb2wnOlxuICAgIHJldHVybiBjb252ZXJ0Qm9vbFZhbHVlKGRiZ3BQcm9wZXJ0eSk7XG4gIGNhc2UgJ251bGwnOlxuICAgIHJldHVybiBjb252ZXJ0TnVsbFZhbHVlKGRiZ3BQcm9wZXJ0eSk7XG4gIGNhc2UgJ2FycmF5JzpcbiAgICByZXR1cm4gY29udmVydEFycmF5VmFsdWUoY29udGV4dElkLCBkYmdwUHJvcGVydHkpO1xuICBjYXNlICdvYmplY3QnOlxuICAgIHJldHVybiBjb252ZXJ0T2JqZWN0VmFsdWUoY29udGV4dElkLCBkYmdwUHJvcGVydHkpO1xuICBkZWZhdWx0OlxuICAgIC8vIFRPRE86IFJlbWFpbmluZyBwcm9wZXJ0eSB0eXBlcyAtIGNsb3N1cmUsIGhhc2htYXAsIC4uLlxuICAgIHJldHVybiBjb252ZXJ0VW5rbm93blZhbHVlKGRiZ3BQcm9wZXJ0eSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydFN0cmluZ1ZhbHVlKGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgdmFyIHZhbHVlO1xuICBpZiAoZGJncFByb3BlcnR5Lmhhc093blByb3BlcnR5KCdfJykpIHtcbiAgICB2YWx1ZSA9IGRiZ3BQcm9wZXJ0eS4kLmVuY29kaW5nID09PSAnYmFzZTY0JyA/IGJhc2U2NERlY29kZShkYmdwUHJvcGVydHkuXykgOlxuICAgICAgYFRPRE86IE5vbi1iYXNlNjQgZW5jb2RlZCBzdHJpbmc6ICR7SlNPTi5zdHJpbmdpZnkoZGJncFByb3BlcnR5KX1gO1xuICB9IGVsc2Uge1xuICAgIC8vIHplcm8gbGVuZ3RoIHN0cmluZ3MgaGF2ZSBubyBkYmdwUHJvcGVydHkuXyBwcm9wZXJ0eVxuICAgIHZhbHVlID0gJyc7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHR5cGU6ICdzdHJpbmcnLFxuICAgIHZhbHVlLFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0SW50VmFsdWUoZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3Qge1xuICB2YXIgdmFsdWUgPSBkYmdwUHJvcGVydHkuJC5lbmNvZGluZyA9PT0gJ2Jhc2U2NCcgPyBgVE9ETzogQmFzZTY0IGVuY29kZWQgaW50OiAke0pTT04uc3RyaW5naWZ5KGRiZ3BQcm9wZXJ0eSl9YFxuICAgIDogTnVtYmVyKGRiZ3BQcm9wZXJ0eS5fKTtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnbnVtYmVyJyxcbiAgICB2YWx1ZSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gY29udmVydEZsb2F0VmFsdWUoZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3Qge1xuICB2YXIgdmFsdWUgPSBkYmdwUHJvcGVydHkuJC5lbmNvZGluZyA9PT0gJ2Jhc2U2NCcgPyBgVE9ETzogQmFzZTY0IGVuY29kZWQgZmxvYXQ6ICR7SlNPTi5zdHJpbmdpZnkoZGJncFByb3BlcnR5KX1gXG4gICAgOiBOdW1iZXIoZGJncFByb3BlcnR5Ll8pO1xuICByZXR1cm4ge1xuICAgIHR5cGU6ICdudW1iZXInLFxuICAgIHZhbHVlLFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0Qm9vbFZhbHVlKGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgdmFyIHZhbHVlID0gZGJncFByb3BlcnR5LiQuZW5jb2RpbmcgPT09ICdiYXNlNjQnID8gYFRPRE86IEJhc2U2NCBlbmNvZGVkIGJvb2w6ICR7SlNPTi5zdHJpbmdpZnkoZGJncFByb3BlcnR5KX1gXG4gICAgOiB0b0Jvb2woZGJncFByb3BlcnR5Ll8pO1xuICByZXR1cm4ge1xuICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICB2YWx1ZSxcbiAgfTtcbn1cblxuZnVuY3Rpb24gY29udmVydE51bGxWYWx1ZShkYmdwUHJvcGVydHk6IERiZ3BQcm9wZXJ0eSk6IFJlbW90ZU9iamVjdCB7XG4gIHJldHVybiB7XG4gICAgdHlwZTogJ3VuZGVmaW5lZCcsXG4gICAgc3VidHlwZTogJ251bGwnLFxuICAgIHZhbHVlOiBudWxsLFxuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0QXJyYXlWYWx1ZShjb250ZXh0SWQ6IE9iamVjdElkLCBkYmdwUHJvcGVydHk6IERiZ3BQcm9wZXJ0eSk6IFJlbW90ZU9iamVjdCB7XG4gIHZhciByZW1vdGVJZCA9IGdldEFnZ3JlZ2F0ZVJlbW90ZU9iamVjdElkKGNvbnRleHRJZCwgZGJncFByb3BlcnR5KTtcbiAgcmV0dXJuIHtcbiAgICBkZXNjcmlwdGlvbjogYEFycmF5WyR7ZGJncFByb3BlcnR5LiQubnVtY2hpbGRyZW59XWAsXG4gICAgdHlwZTogJ29iamVjdCcsXG4gICAgc3VidHlwZTogJ2FycmF5JyxcbiAgICBvYmplY3RJZDogcmVtb3RlSWQsXG4gIH07XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRPYmplY3RWYWx1ZShjb250ZXh0SWQ6IE9iamVjdElkLCBkYmdwUHJvcGVydHk6IERiZ3BQcm9wZXJ0eSk6IFJlbW90ZU9iamVjdCB7XG4gIHZhciByZW1vdGVJZCA9IGdldEFnZ3JlZ2F0ZVJlbW90ZU9iamVjdElkKGNvbnRleHRJZCwgZGJncFByb3BlcnR5KTtcbiAgcmV0dXJuIHtcbiAgICBkZXNjcmlwdGlvbjogZGJncFByb3BlcnR5LiQuY2xhc3NuYW1lLFxuICAgIHR5cGU6ICdvYmplY3QnLFxuICAgIG9iamVjdElkOiByZW1vdGVJZCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gZ2V0QWdncmVnYXRlUmVtb3RlT2JqZWN0SWQoY29udGV4dElkOiBPYmplY3RJZCwgZGJncFByb3BlcnR5OiBEYmdwUHJvcGVydHkpOiBSZW1vdGVPYmplY3RJZCB7XG4gIHZhciBudW1jaGlsZHJlbiA9IE51bWJlcihkYmdwUHJvcGVydHkuJC5udW1jaGlsZHJlbik7XG4gIHZhciBwYWdlc2l6ZSA9IE51bWJlcihkYmdwUHJvcGVydHkuJC5wYWdlc2l6ZSk7XG4gIHZhciBwYWdlQ291bnQgPSBNYXRoLnRydW5jKChudW1jaGlsZHJlbiArIHBhZ2VzaXplIC0gMSkgLyBwYWdlc2l6ZSk7XG4gIGxvZyhgbnVtY2hpbGRyZW46ICR7bnVtY2hpbGRyZW59IHBhZ2VzaXplOiAke3BhZ2VzaXplfSBwYWdlQ291bnQgJHtwYWdlQ291bnR9YClcbiAgaWYgKHBhZ2VDb3VudCA+IDEpIHtcbiAgICB2YXIgZWxlbWVudFJhbmdlID0ge1xuICAgICAgcGFnZXNpemUsXG4gICAgICBzdGFydEluZGV4OiAwLFxuICAgICAgY291bnQ6IG51bWNoaWxkcmVuLFxuICAgIH07XG4gICAgcmV0dXJuIHJlbW90ZU9iamVjdElkT2ZPYmplY3RJZChwYWdlZE9iamVjdElkKGNvbnRleHRJZCwgZGJncFByb3BlcnR5LiQuZnVsbG5hbWUsIGVsZW1lbnRSYW5nZSkpO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiByZW1vdGVPYmplY3RJZE9mT2JqZWN0SWQoc2luZ2xlUGFnZU9iamVjdElkKGNvbnRleHRJZCwgZGJncFByb3BlcnR5LiQuZnVsbG5hbWUsIDApKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjb252ZXJ0VW5rbm93blZhbHVlKGRiZ3BQcm9wZXJ0eTogRGJncFByb3BlcnR5KTogUmVtb3RlT2JqZWN0IHtcbiAgcmV0dXJuIHtcbiAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICB2YWx1ZTogJ1RPRE86IHVua25vd246ICcgKyBKU09OLnN0cmluZ2lmeShkYmdwUHJvcGVydHkpLFxuICB9O1xufVxuXG5mdW5jdGlvbiB0b0Jvb2wodmFsdWU6IHN0cmluZyk6IG1peGVkIHtcbiAgc3dpdGNoICh2YWx1ZSkge1xuICBjYXNlICcwJzogcmV0dXJuIGZhbHNlO1xuICBjYXNlICcxJzogcmV0dXJuIHRydWU7XG4gIGRlZmF1bHQ6IHJldHVybiAnVW5leHBlY3RlZCBib29sIHZhbHVlOiAnICsgdmFsdWU7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7Y29udmVydFZhbHVlfTtcbiJdfQ==
