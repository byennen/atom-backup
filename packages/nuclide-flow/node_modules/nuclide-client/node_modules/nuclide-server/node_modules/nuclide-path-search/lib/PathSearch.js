
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var QueryItem = require('./QueryItem');

var PathSet;
var PATH_SEARCH_TIMEOUT_MS = 60 * 1000;

/**
 * Manages multiple simultaneous queries against a PathSet. The PathSearch is
 * responsible for deciding which queries to cancel based on newer queries.
 */

var PathSearch = (function () {

  /**
   * @param pathSet that keeps itself in sync with whatever directory it
   *     represents.
   */

  function PathSearch(pathSet) {
    _classCallCheck(this, PathSearch);

    this._pathSet = pathSet;
    this._activeQueries = {};
    this._queryItemForPath = {}; // It might be more efficient to store this in PathSet.
  }

  /**
   * @param query Is expected to be what the user has typed in a path-matching
   *     typeahead UI.
   * @return Promise that resolves to an empty ResultSet if it is canceled.
   */

  _createClass(PathSearch, [{
    key: 'doQuery',
    value: function doQuery(query) {
      var _this = this;

      // Note that currently, if the query is the empty string, all of the files
      // in the underlying PathSet will be returned. This may not be desirable.

      // See if a request for this query is already in flight.
      var activeQuery = this._activeQueries[query];
      if (activeQuery) {
        return activeQuery;
      }

      // If any of the existing queries are a prefix of this new query, cancel
      // them. Here, we are assuming this is used to power a typeahead, so the
      // results of the old queries will no longer be of interest.
      var keysToRemove = [];
      for (var key in this._activeQueries) {
        if (query.startsWith(key)) {
          keysToRemove.push(key);
        }
      }

      // Because cancelJob() will call removePromise(), which will modify
      // this._activeQueries, we cannot call cancelJob() while iterating
      // this._activeQueries in the for/in loop above because that could interfere
      // with the iteration.
      if (keysToRemove.length) {
        keysToRemove.forEach(function (key) {
          return _this._activeQueries[key].cancelJob();
        });
      }

      // TODO(mbolin): It would be more complicated, but not completely insane,
      // for the new processor to start by filtering what the prefix query had
      // already found thus far.

      var TopScores = require('./TopScores');
      var topScores = new TopScores( /* capacity */50);

      var processor = function processor(path) {
        var queryItem = _this._queryItemForPath[path];
        if (!queryItem) {
          queryItem = new QueryItem(path);
          // Currently, nothing is ever removed from _queryItemForPath. It's
          // unclear if the additional complexity in bookkeeping effort would
          // merit the memory savings.
          _this._queryItemForPath[path] = queryItem;
        }
        var score = queryItem.score(query);
        if (score !== null) {
          topScores.insert(score);
        }
      };

      // This is helpful for debugging.
      processor.toString = function () {
        return query;
      };

      var promise = this._pathSet.submit(processor);

      var promiseForQuery;
      var removePromise = function removePromise() {
        var entry = _this._activeQueries[query];
        // Remove the entry only if it has not been replaced by a more recent one.
        if (entry === promiseForQuery) {
          delete _this._activeQueries[query];
        }
      };

      promiseForQuery = promise.then(function () {
        var results = topScores.getTopScores();
        // Do the deletion in a timeout in case the user types backspace,
        // effectively asking for the previous results again.
        setTimeout(removePromise, PATH_SEARCH_TIMEOUT_MS);
        return { query: query, results: results };
      }, function (error) {
        removePromise();
        PathSet = PathSet || require('./PathSet');
        if (error.errorCode === PathSet.ERROR_CODE_CANCELED) {
          // This request was canceled: resolve to an empty ResultSet.
          return {
            query: query,
            results: []
          };
        } else {
          throw error;
        }
      });
      promiseForQuery.cancelJob = promise.cancelJob;
      this._activeQueries[query] = promiseForQuery;
      return promiseForQuery;
    }
  }]);

  return PathSearch;
})();

module.exports = PathSearch;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXBhdGgtc2VhcmNoL2xpYi9QYXRoU2VhcmNoLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7QUFXWixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7O0FBT3ZDLElBQUksT0FBTyxDQUFDO0FBQ1osSUFBSSxzQkFBc0IsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDOzs7Ozs7O0lBTWpDLFVBQVU7Ozs7Ozs7QUFTSCxXQVRQLFVBQVUsQ0FTRixPQUFnQixFQUFFOzBCQVQxQixVQUFVOztBQVVaLFFBQUksQ0FBQyxRQUFRLEdBQUcsT0FBTyxDQUFDO0FBQ3hCLFFBQUksQ0FBQyxjQUFjLEdBQUcsRUFBRSxDQUFDO0FBQ3pCLFFBQUksQ0FBQyxpQkFBaUIsR0FBRyxFQUFFLENBQUM7R0FDN0I7Ozs7Ozs7O2VBYkcsVUFBVTs7V0FvQlAsaUJBQUMsS0FBYSxFQUFzQjs7Ozs7OztBQUt6QyxVQUFJLFdBQVcsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzdDLFVBQUksV0FBVyxFQUFFO0FBQ2YsZUFBTyxXQUFXLENBQUM7T0FDcEI7Ozs7O0FBS0QsVUFBSSxZQUFZLEdBQUcsRUFBRSxDQUFDO0FBQ3RCLFdBQUssSUFBSSxHQUFHLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtBQUNuQyxZQUFJLEtBQUssQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLEVBQUU7QUFDekIsc0JBQVksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDeEI7T0FDRjs7Ozs7O0FBTUQsVUFBSSxZQUFZLENBQUMsTUFBTSxFQUFFO0FBQ3ZCLG9CQUFZLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRztpQkFBSSxNQUFLLGNBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxTQUFTLEVBQUU7U0FBQSxDQUFDLENBQUM7T0FDbkU7Ozs7OztBQU1ELFVBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN2QyxVQUFJLFNBQVMsR0FBRyxJQUFJLFNBQVMsZ0JBQWdCLEVBQUUsQ0FBQyxDQUFDOztBQUVqRCxVQUFJLFNBQVMsR0FBRyxTQUFaLFNBQVMsQ0FBSSxJQUFJLEVBQWE7QUFDaEMsWUFBSSxTQUFTLEdBQUcsTUFBSyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUM3QyxZQUFJLENBQUMsU0FBUyxFQUFFO0FBQ2QsbUJBQVMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQzs7OztBQUloQyxnQkFBSyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxTQUFTLENBQUM7U0FDMUM7QUFDRCxZQUFJLEtBQUssR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQ25DLFlBQUksS0FBSyxLQUFLLElBQUksRUFBRTtBQUNsQixtQkFBUyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUN6QjtPQUNGLENBQUM7OztBQUdGLGVBQVMsQ0FBQyxRQUFRLEdBQUc7ZUFBTSxLQUFLO09BQUEsQ0FBQzs7QUFFakMsVUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7O0FBRTlDLFVBQUksZUFBZSxDQUFDO0FBQ3BCLFVBQUksYUFBYSxHQUFHLFNBQWhCLGFBQWEsR0FBUztBQUN4QixZQUFJLEtBQUssR0FBRyxNQUFLLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFdkMsWUFBSSxLQUFLLEtBQUssZUFBZSxFQUFFO0FBQzdCLGlCQUFPLE1BQUssY0FBYyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ25DO09BQ0YsQ0FBQzs7QUFFRixxQkFBZSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsWUFBTTtBQUNuQyxZQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUM7OztBQUd2QyxrQkFBVSxDQUFDLGFBQWEsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0FBQ2xELGVBQU8sRUFBQyxLQUFLLEVBQUwsS0FBSyxFQUFFLE9BQU8sRUFBUCxPQUFPLEVBQUMsQ0FBQztPQUN6QixFQUFFLFVBQUMsS0FBSyxFQUFZO0FBQ25CLHFCQUFhLEVBQUUsQ0FBQztBQUNoQixlQUFPLEdBQUcsT0FBTyxJQUFJLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUMxQyxZQUFJLEtBQUssQ0FBQyxTQUFTLEtBQUssT0FBTyxDQUFDLG1CQUFtQixFQUFFOztBQUVuRCxpQkFBTztBQUNMLGlCQUFLLEVBQUwsS0FBSztBQUNMLG1CQUFPLEVBQUUsRUFBRTtXQUNaLENBQUM7U0FDSCxNQUFNO0FBQ0wsZ0JBQU0sS0FBSyxDQUFDO1NBQ2I7T0FDRixDQUFDLENBQUM7QUFDSCxxQkFBZSxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDO0FBQzlDLFVBQUksQ0FBQyxjQUFjLENBQUMsS0FBSyxDQUFDLEdBQUcsZUFBZSxDQUFDO0FBQzdDLGFBQU8sZUFBZSxDQUFDO0tBQ3hCOzs7U0ExR0csVUFBVTs7O0FBNkdoQixNQUFNLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1wYXRoLXNlYXJjaC9saWIvUGF0aFNlYXJjaC5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbnZhciBRdWVyeUl0ZW0gPSByZXF1aXJlKCcuL1F1ZXJ5SXRlbScpO1xuXG50eXBlIFJlc3VsdFNldCA9IHtcbiAgcXVlcnk6IHN0cmluZztcbiAgcmVzdWx0czogQXJyYXk8UXVlcnlTY29yZT47XG59O1xuXG52YXIgUGF0aFNldDtcbnZhciBQQVRIX1NFQVJDSF9USU1FT1VUX01TID0gNjAgKiAxMDAwO1xuXG4vKipcbiAqIE1hbmFnZXMgbXVsdGlwbGUgc2ltdWx0YW5lb3VzIHF1ZXJpZXMgYWdhaW5zdCBhIFBhdGhTZXQuIFRoZSBQYXRoU2VhcmNoIGlzXG4gKiByZXNwb25zaWJsZSBmb3IgZGVjaWRpbmcgd2hpY2ggcXVlcmllcyB0byBjYW5jZWwgYmFzZWQgb24gbmV3ZXIgcXVlcmllcy5cbiAqL1xuY2xhc3MgUGF0aFNlYXJjaCB7XG4gIF9wYXRoU2V0OiBQYXRoU2V0O1xuICBfYWN0aXZlUXVlcmllczoge1trZXk6IHN0cmluZ106IFByb21pc2U8UmVzdWx0U2V0Pn07XG4gIF9xdWVyeUl0ZW1Gb3JQYXRoOiB7W2tleTogc3RyaW5nXTogUXVlcnlJdGVtfTtcblxuICAvKipcbiAgICogQHBhcmFtIHBhdGhTZXQgdGhhdCBrZWVwcyBpdHNlbGYgaW4gc3luYyB3aXRoIHdoYXRldmVyIGRpcmVjdG9yeSBpdFxuICAgKiAgICAgcmVwcmVzZW50cy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHBhdGhTZXQ6IFBhdGhTZXQpIHtcbiAgICB0aGlzLl9wYXRoU2V0ID0gcGF0aFNldDtcbiAgICB0aGlzLl9hY3RpdmVRdWVyaWVzID0ge307XG4gICAgdGhpcy5fcXVlcnlJdGVtRm9yUGF0aCA9IHt9OyAvLyBJdCBtaWdodCBiZSBtb3JlIGVmZmljaWVudCB0byBzdG9yZSB0aGlzIGluIFBhdGhTZXQuXG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHF1ZXJ5IElzIGV4cGVjdGVkIHRvIGJlIHdoYXQgdGhlIHVzZXIgaGFzIHR5cGVkIGluIGEgcGF0aC1tYXRjaGluZ1xuICAgKiAgICAgdHlwZWFoZWFkIFVJLlxuICAgKiBAcmV0dXJuIFByb21pc2UgdGhhdCByZXNvbHZlcyB0byBhbiBlbXB0eSBSZXN1bHRTZXQgaWYgaXQgaXMgY2FuY2VsZWQuXG4gICAqL1xuICBkb1F1ZXJ5KHF1ZXJ5OiBzdHJpbmcpOiBQcm9taXNlPFJlc3VsdFNldD4ge1xuICAgIC8vIE5vdGUgdGhhdCBjdXJyZW50bHksIGlmIHRoZSBxdWVyeSBpcyB0aGUgZW1wdHkgc3RyaW5nLCBhbGwgb2YgdGhlIGZpbGVzXG4gICAgLy8gaW4gdGhlIHVuZGVybHlpbmcgUGF0aFNldCB3aWxsIGJlIHJldHVybmVkLiBUaGlzIG1heSBub3QgYmUgZGVzaXJhYmxlLlxuXG4gICAgLy8gU2VlIGlmIGEgcmVxdWVzdCBmb3IgdGhpcyBxdWVyeSBpcyBhbHJlYWR5IGluIGZsaWdodC5cbiAgICB2YXIgYWN0aXZlUXVlcnkgPSB0aGlzLl9hY3RpdmVRdWVyaWVzW3F1ZXJ5XTtcbiAgICBpZiAoYWN0aXZlUXVlcnkpIHtcbiAgICAgIHJldHVybiBhY3RpdmVRdWVyeTtcbiAgICB9XG5cbiAgICAvLyBJZiBhbnkgb2YgdGhlIGV4aXN0aW5nIHF1ZXJpZXMgYXJlIGEgcHJlZml4IG9mIHRoaXMgbmV3IHF1ZXJ5LCBjYW5jZWxcbiAgICAvLyB0aGVtLiBIZXJlLCB3ZSBhcmUgYXNzdW1pbmcgdGhpcyBpcyB1c2VkIHRvIHBvd2VyIGEgdHlwZWFoZWFkLCBzbyB0aGVcbiAgICAvLyByZXN1bHRzIG9mIHRoZSBvbGQgcXVlcmllcyB3aWxsIG5vIGxvbmdlciBiZSBvZiBpbnRlcmVzdC5cbiAgICB2YXIga2V5c1RvUmVtb3ZlID0gW107XG4gICAgZm9yICh2YXIga2V5IGluIHRoaXMuX2FjdGl2ZVF1ZXJpZXMpIHtcbiAgICAgIGlmIChxdWVyeS5zdGFydHNXaXRoKGtleSkpIHtcbiAgICAgICAga2V5c1RvUmVtb3ZlLnB1c2goa2V5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBCZWNhdXNlIGNhbmNlbEpvYigpIHdpbGwgY2FsbCByZW1vdmVQcm9taXNlKCksIHdoaWNoIHdpbGwgbW9kaWZ5XG4gICAgLy8gdGhpcy5fYWN0aXZlUXVlcmllcywgd2UgY2Fubm90IGNhbGwgY2FuY2VsSm9iKCkgd2hpbGUgaXRlcmF0aW5nXG4gICAgLy8gdGhpcy5fYWN0aXZlUXVlcmllcyBpbiB0aGUgZm9yL2luIGxvb3AgYWJvdmUgYmVjYXVzZSB0aGF0IGNvdWxkIGludGVyZmVyZVxuICAgIC8vIHdpdGggdGhlIGl0ZXJhdGlvbi5cbiAgICBpZiAoa2V5c1RvUmVtb3ZlLmxlbmd0aCkge1xuICAgICAga2V5c1RvUmVtb3ZlLmZvckVhY2goa2V5ID0+IHRoaXMuX2FjdGl2ZVF1ZXJpZXNba2V5XS5jYW5jZWxKb2IoKSk7XG4gICAgfVxuXG4gICAgLy8gVE9ETyhtYm9saW4pOiBJdCB3b3VsZCBiZSBtb3JlIGNvbXBsaWNhdGVkLCBidXQgbm90IGNvbXBsZXRlbHkgaW5zYW5lLFxuICAgIC8vIGZvciB0aGUgbmV3IHByb2Nlc3NvciB0byBzdGFydCBieSBmaWx0ZXJpbmcgd2hhdCB0aGUgcHJlZml4IHF1ZXJ5IGhhZFxuICAgIC8vIGFscmVhZHkgZm91bmQgdGh1cyBmYXIuXG5cbiAgICB2YXIgVG9wU2NvcmVzID0gcmVxdWlyZSgnLi9Ub3BTY29yZXMnKTtcbiAgICB2YXIgdG9wU2NvcmVzID0gbmV3IFRvcFNjb3JlcygvKiBjYXBhY2l0eSAqLyA1MCk7XG5cbiAgICB2YXIgcHJvY2Vzc29yID0gKHBhdGg6IHN0cmluZykgPT4ge1xuICAgICAgdmFyIHF1ZXJ5SXRlbSA9IHRoaXMuX3F1ZXJ5SXRlbUZvclBhdGhbcGF0aF07XG4gICAgICBpZiAoIXF1ZXJ5SXRlbSkge1xuICAgICAgICBxdWVyeUl0ZW0gPSBuZXcgUXVlcnlJdGVtKHBhdGgpO1xuICAgICAgICAvLyBDdXJyZW50bHksIG5vdGhpbmcgaXMgZXZlciByZW1vdmVkIGZyb20gX3F1ZXJ5SXRlbUZvclBhdGguIEl0J3NcbiAgICAgICAgLy8gdW5jbGVhciBpZiB0aGUgYWRkaXRpb25hbCBjb21wbGV4aXR5IGluIGJvb2trZWVwaW5nIGVmZm9ydCB3b3VsZFxuICAgICAgICAvLyBtZXJpdCB0aGUgbWVtb3J5IHNhdmluZ3MuXG4gICAgICAgIHRoaXMuX3F1ZXJ5SXRlbUZvclBhdGhbcGF0aF0gPSBxdWVyeUl0ZW07XG4gICAgICB9XG4gICAgICB2YXIgc2NvcmUgPSBxdWVyeUl0ZW0uc2NvcmUocXVlcnkpO1xuICAgICAgaWYgKHNjb3JlICE9PSBudWxsKSB7XG4gICAgICAgIHRvcFNjb3Jlcy5pbnNlcnQoc2NvcmUpO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBUaGlzIGlzIGhlbHBmdWwgZm9yIGRlYnVnZ2luZy5cbiAgICBwcm9jZXNzb3IudG9TdHJpbmcgPSAoKSA9PiBxdWVyeTtcblxuICAgIHZhciBwcm9taXNlID0gdGhpcy5fcGF0aFNldC5zdWJtaXQocHJvY2Vzc29yKTtcblxuICAgIHZhciBwcm9taXNlRm9yUXVlcnk7XG4gICAgdmFyIHJlbW92ZVByb21pc2UgPSAoKSA9PiB7XG4gICAgICB2YXIgZW50cnkgPSB0aGlzLl9hY3RpdmVRdWVyaWVzW3F1ZXJ5XTtcbiAgICAgIC8vIFJlbW92ZSB0aGUgZW50cnkgb25seSBpZiBpdCBoYXMgbm90IGJlZW4gcmVwbGFjZWQgYnkgYSBtb3JlIHJlY2VudCBvbmUuXG4gICAgICBpZiAoZW50cnkgPT09IHByb21pc2VGb3JRdWVyeSkge1xuICAgICAgICBkZWxldGUgdGhpcy5fYWN0aXZlUXVlcmllc1txdWVyeV07XG4gICAgICB9XG4gICAgfTtcblxuICAgIHByb21pc2VGb3JRdWVyeSA9IHByb21pc2UudGhlbigoKSA9PiB7XG4gICAgICB2YXIgcmVzdWx0cyA9IHRvcFNjb3Jlcy5nZXRUb3BTY29yZXMoKTtcbiAgICAgIC8vIERvIHRoZSBkZWxldGlvbiBpbiBhIHRpbWVvdXQgaW4gY2FzZSB0aGUgdXNlciB0eXBlcyBiYWNrc3BhY2UsXG4gICAgICAvLyBlZmZlY3RpdmVseSBhc2tpbmcgZm9yIHRoZSBwcmV2aW91cyByZXN1bHRzIGFnYWluLlxuICAgICAgc2V0VGltZW91dChyZW1vdmVQcm9taXNlLCBQQVRIX1NFQVJDSF9USU1FT1VUX01TKTtcbiAgICAgIHJldHVybiB7cXVlcnksIHJlc3VsdHN9O1xuICAgIH0sIChlcnJvcjogRXJyb3IpID0+IHtcbiAgICAgIHJlbW92ZVByb21pc2UoKTtcbiAgICAgIFBhdGhTZXQgPSBQYXRoU2V0IHx8IHJlcXVpcmUoJy4vUGF0aFNldCcpO1xuICAgICAgaWYgKGVycm9yLmVycm9yQ29kZSA9PT0gUGF0aFNldC5FUlJPUl9DT0RFX0NBTkNFTEVEKSB7XG4gICAgICAgIC8vIFRoaXMgcmVxdWVzdCB3YXMgY2FuY2VsZWQ6IHJlc29sdmUgdG8gYW4gZW1wdHkgUmVzdWx0U2V0LlxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHF1ZXJ5LFxuICAgICAgICAgIHJlc3VsdHM6IFtdLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcHJvbWlzZUZvclF1ZXJ5LmNhbmNlbEpvYiA9IHByb21pc2UuY2FuY2VsSm9iO1xuICAgIHRoaXMuX2FjdGl2ZVF1ZXJpZXNbcXVlcnldID0gcHJvbWlzZUZvclF1ZXJ5O1xuICAgIHJldHVybiBwcm9taXNlRm9yUXVlcnk7XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBQYXRoU2VhcmNoO1xuIl19
