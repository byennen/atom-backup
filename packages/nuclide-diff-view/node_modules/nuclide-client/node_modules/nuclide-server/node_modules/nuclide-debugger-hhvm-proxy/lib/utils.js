
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

function log(message) {
  var logger = require('nuclide-logging').getLogger();
  logger.info('hhvm debugger: ' + message);
}

function logError(message) {
  var logger = require('nuclide-logging').getLogger();
  logger.error('hhvm debugger: ' + message);
}

function logErrorAndThrow(message) {
  logError(message);
  logError(new Error().stack);
  throw new Error(message);
}

/**
 * Convert xml to JS. Uses the xml2js package.
 * xml2js has a rather ... unique ... callback based API for a
 * synchronous operation. This functions purpose is to give a reasonable API.
 *
 * Format of the result:
 * Children become fields.
 * Multiple children of the same name become arrays.
 * Attributes become children of the '$' member
 * Body becomes either a string (if no attributes or children)
 * or the '_' member.
 * CDATA becomes an array containing a string, or just a string.
 *
 * Throws if the input is not valid xml.
 */
function parseXml(xml) {
  var errorValue;
  var resultValue;
  require('xml2js').parseString(xml, function (error, result) {
    errorValue = error;
    resultValue = result;
  });
  if (errorValue !== null) {
    throw new Error('Error ' + JSON.stringify(errorValue) + ' parsing xml: ' + xml);
  }
  return resultValue;
}

function base64Decode(value) {
  return new Buffer(value, 'base64').toString();
}

/**
 * Dbgp messages are formatted as a string containing:
 * length <NULL> xml-blob <NULL>
 *
 * A single message from the server may contain
 * multiple Dbgp messages.
 *
 * Returns an array containing the xml-blobs converted to JS objects.
 *
 * Throws if the message is malformatted.
 */
function parseDbgpMessages(message) {
  var result = [];
  var components = message.split('\x00');
  while (components.length >= 3) {
    var length = Number(components.shift());
    var value = components.shift();
    if (value.length !== length) {
      throw new Error('Error: Server message expected length ' + length + ' got length ' + value.length);
    }

    var json = parseXml(value);
    log('Translating server message result json: ' + JSON.stringify(json));
    result.push(json);
  }
  if (components.length !== 1) {
    logError('Mismatched number of components in server message.');
  }

  return result;
}

function makeDbgpMessage(message) {
  return String(message.length) + '\x00' + message + '\x00';
}

function pathToUri(path) {
  return 'file://' + path;
}

function uriToPath(uri) {
  var components = require('url').parse(uri);
  if (components.protocol !== 'file:') {
    logErrorAndThrow('unexpected file protocol. Got: ' + components.protocol);
  }
  return components.pathname;
}

var DUMMY_FRAME_ID = 'Frame.0';

module.exports = {
  log: log,
  logError: logError,
  logErrorAndThrow: logErrorAndThrow,
  makeDbgpMessage: makeDbgpMessage,
  parseDbgpMessages: parseDbgpMessages,
  parseXml: parseXml,
  base64Decode: base64Decode,
  pathToUri: pathToUri,
  uriToPath: uriToPath,
  DUMMY_FRAME_ID: DUMMY_FRAME_ID
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL3V0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7OztBQVlaLFNBQVMsR0FBRyxDQUFDLE9BQWUsRUFBRTtBQUM1QixNQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUNwRCxRQUFNLENBQUMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxDQUFDO0NBQzFDOztBQUVELFNBQVMsUUFBUSxDQUFDLE9BQWUsRUFBRTtBQUNqQyxNQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUNwRCxRQUFNLENBQUMsS0FBSyxDQUFDLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxDQUFDO0NBQzNDOztBQUVELFNBQVMsZ0JBQWdCLENBQUMsT0FBZSxFQUFFO0FBQ3pDLFVBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNsQixVQUFRLENBQUMsSUFBSSxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUM1QixRQUFNLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0NBQzFCOzs7Ozs7Ozs7Ozs7Ozs7OztBQWlCRCxTQUFTLFFBQVEsQ0FBQyxHQUFXLEVBQVM7QUFDcEMsTUFBSSxVQUFVLENBQUM7QUFDZixNQUFJLFdBQVcsQ0FBQztBQUNoQixTQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxVQUFDLEtBQUssRUFBRSxNQUFNLEVBQUs7QUFDcEQsY0FBVSxHQUFHLEtBQUssQ0FBQztBQUNuQixlQUFXLEdBQUcsTUFBTSxDQUFDO0dBQ3RCLENBQUMsQ0FBQztBQUNILE1BQUksVUFBVSxLQUFLLElBQUksRUFBRTtBQUN2QixVQUFNLElBQUksS0FBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLGdCQUFnQixHQUFHLEdBQUcsQ0FBQyxDQUFDO0dBQ2pGO0FBQ0QsU0FBTyxXQUFXLENBQUM7Q0FDcEI7O0FBRUQsU0FBUyxZQUFZLENBQUMsS0FBYSxFQUFVO0FBQzNDLFNBQU8sSUFBSSxNQUFNLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0NBQy9DOzs7Ozs7Ozs7Ozs7O0FBYUQsU0FBUyxpQkFBaUIsQ0FBQyxPQUFlLEVBQWlCO0FBQ3pELE1BQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztBQUNoQixNQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3ZDLFNBQU8sVUFBVSxDQUFDLE1BQU0sSUFBSSxDQUFDLEVBQUU7QUFDN0IsUUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0FBQ3hDLFFBQUksS0FBSyxHQUFHLFVBQVUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUMvQixRQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssTUFBTSxFQUFFO0FBQzNCLFlBQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLEdBQUcsTUFBTSxHQUFHLGNBQWMsR0FDaEYsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0tBQ2pCOztBQUVELFFBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUMzQixPQUFHLENBQUMsMENBQTBDLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0FBQ3ZFLFVBQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7R0FDbkI7QUFDRCxNQUFJLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO0FBQzNCLFlBQVEsQ0FBQyxvREFBb0QsQ0FBQyxDQUFDO0dBQ2hFOztBQUVELFNBQU8sTUFBTSxDQUFDO0NBQ2Y7O0FBRUQsU0FBUyxlQUFlLENBQUMsT0FBZSxFQUFVO0FBQ2hELFNBQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxNQUFNLEdBQUcsT0FBTyxHQUFHLE1BQU0sQ0FBQztDQUMzRDs7QUFFRCxTQUFTLFNBQVMsQ0FBQyxJQUFZLEVBQVU7QUFDdkMsU0FBTyxTQUFTLEdBQUcsSUFBSSxDQUFDO0NBQ3pCOztBQUVELFNBQVMsU0FBUyxDQUFDLEdBQVcsRUFBVTtBQUN0QyxNQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzNDLE1BQUksVUFBVSxDQUFDLFFBQVEsS0FBSyxPQUFPLEVBQUU7QUFDbkMsb0JBQWdCLENBQUMsaUNBQWlDLEdBQUcsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0dBQzNFO0FBQ0QsU0FBTyxVQUFVLENBQUMsUUFBUSxDQUFDO0NBQzVCOztBQUVELElBQUksY0FBYyxHQUFHLFNBQVMsQ0FBQzs7QUFFL0IsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLEtBQUcsRUFBSCxHQUFHO0FBQ0gsVUFBUSxFQUFSLFFBQVE7QUFDUixrQkFBZ0IsRUFBaEIsZ0JBQWdCO0FBQ2hCLGlCQUFlLEVBQWYsZUFBZTtBQUNmLG1CQUFpQixFQUFqQixpQkFBaUI7QUFDakIsVUFBUSxFQUFSLFFBQVE7QUFDUixjQUFZLEVBQVosWUFBWTtBQUNaLFdBQVMsRUFBVCxTQUFTO0FBQ1QsV0FBUyxFQUFULFNBQVM7QUFDVCxnQkFBYyxFQUFkLGNBQWM7Q0FDZixDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL3V0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuXG5mdW5jdGlvbiBsb2cobWVzc2FnZTogc3RyaW5nKSB7XG4gIHZhciBsb2dnZXIgPSByZXF1aXJlKCdudWNsaWRlLWxvZ2dpbmcnKS5nZXRMb2dnZXIoKTtcbiAgbG9nZ2VyLmluZm8oJ2hodm0gZGVidWdnZXI6ICcgKyBtZXNzYWdlKTtcbn1cblxuZnVuY3Rpb24gbG9nRXJyb3IobWVzc2FnZTogc3RyaW5nKSB7XG4gIHZhciBsb2dnZXIgPSByZXF1aXJlKCdudWNsaWRlLWxvZ2dpbmcnKS5nZXRMb2dnZXIoKTtcbiAgbG9nZ2VyLmVycm9yKCdoaHZtIGRlYnVnZ2VyOiAnICsgbWVzc2FnZSk7XG59XG5cbmZ1bmN0aW9uIGxvZ0Vycm9yQW5kVGhyb3cobWVzc2FnZTogc3RyaW5nKSB7XG4gIGxvZ0Vycm9yKG1lc3NhZ2UpO1xuICBsb2dFcnJvcihuZXcgRXJyb3IoKS5zdGFjayk7XG4gIHRocm93IG5ldyBFcnJvcihtZXNzYWdlKTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0IHhtbCB0byBKUy4gVXNlcyB0aGUgeG1sMmpzIHBhY2thZ2UuXG4gKiB4bWwyanMgaGFzIGEgcmF0aGVyIC4uLiB1bmlxdWUgLi4uIGNhbGxiYWNrIGJhc2VkIEFQSSBmb3IgYVxuICogc3luY2hyb25vdXMgb3BlcmF0aW9uLiBUaGlzIGZ1bmN0aW9ucyBwdXJwb3NlIGlzIHRvIGdpdmUgYSByZWFzb25hYmxlIEFQSS5cbiAqXG4gKiBGb3JtYXQgb2YgdGhlIHJlc3VsdDpcbiAqIENoaWxkcmVuIGJlY29tZSBmaWVsZHMuXG4gKiBNdWx0aXBsZSBjaGlsZHJlbiBvZiB0aGUgc2FtZSBuYW1lIGJlY29tZSBhcnJheXMuXG4gKiBBdHRyaWJ1dGVzIGJlY29tZSBjaGlsZHJlbiBvZiB0aGUgJyQnIG1lbWJlclxuICogQm9keSBiZWNvbWVzIGVpdGhlciBhIHN0cmluZyAoaWYgbm8gYXR0cmlidXRlcyBvciBjaGlsZHJlbilcbiAqIG9yIHRoZSAnXycgbWVtYmVyLlxuICogQ0RBVEEgYmVjb21lcyBhbiBhcnJheSBjb250YWluaW5nIGEgc3RyaW5nLCBvciBqdXN0IGEgc3RyaW5nLlxuICpcbiAqIFRocm93cyBpZiB0aGUgaW5wdXQgaXMgbm90IHZhbGlkIHhtbC5cbiAqL1xuZnVuY3Rpb24gcGFyc2VYbWwoeG1sOiBzdHJpbmcpOiBtaXhlZCB7XG4gIHZhciBlcnJvclZhbHVlO1xuICB2YXIgcmVzdWx0VmFsdWU7XG4gIHJlcXVpcmUoJ3htbDJqcycpLnBhcnNlU3RyaW5nKHhtbCwgKGVycm9yLCByZXN1bHQpID0+IHtcbiAgICBlcnJvclZhbHVlID0gZXJyb3I7XG4gICAgcmVzdWx0VmFsdWUgPSByZXN1bHQ7XG4gIH0pO1xuICBpZiAoZXJyb3JWYWx1ZSAhPT0gbnVsbCkge1xuICAgIHRocm93IG5ldyBFcnJvcignRXJyb3IgJyArIEpTT04uc3RyaW5naWZ5KGVycm9yVmFsdWUpICsgJyBwYXJzaW5nIHhtbDogJyArIHhtbCk7XG4gIH1cbiAgcmV0dXJuIHJlc3VsdFZhbHVlO1xufVxuXG5mdW5jdGlvbiBiYXNlNjREZWNvZGUodmFsdWU6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBuZXcgQnVmZmVyKHZhbHVlLCAnYmFzZTY0JykudG9TdHJpbmcoKTtcbn1cblxuLyoqXG4gKiBEYmdwIG1lc3NhZ2VzIGFyZSBmb3JtYXR0ZWQgYXMgYSBzdHJpbmcgY29udGFpbmluZzpcbiAqIGxlbmd0aCA8TlVMTD4geG1sLWJsb2IgPE5VTEw+XG4gKlxuICogQSBzaW5nbGUgbWVzc2FnZSBmcm9tIHRoZSBzZXJ2ZXIgbWF5IGNvbnRhaW5cbiAqIG11bHRpcGxlIERiZ3AgbWVzc2FnZXMuXG4gKlxuICogUmV0dXJucyBhbiBhcnJheSBjb250YWluaW5nIHRoZSB4bWwtYmxvYnMgY29udmVydGVkIHRvIEpTIG9iamVjdHMuXG4gKlxuICogVGhyb3dzIGlmIHRoZSBtZXNzYWdlIGlzIG1hbGZvcm1hdHRlZC5cbiAqL1xuZnVuY3Rpb24gcGFyc2VEYmdwTWVzc2FnZXMobWVzc2FnZTogc3RyaW5nKTogQXJyYXk8c3RyaW5nPiB7XG4gIHZhciByZXN1bHQgPSBbXTtcbiAgdmFyIGNvbXBvbmVudHMgPSBtZXNzYWdlLnNwbGl0KCdcXHgwMCcpO1xuICB3aGlsZSAoY29tcG9uZW50cy5sZW5ndGggPj0gMykge1xuICAgIHZhciBsZW5ndGggPSBOdW1iZXIoY29tcG9uZW50cy5zaGlmdCgpKTtcbiAgICB2YXIgdmFsdWUgPSBjb21wb25lbnRzLnNoaWZ0KCk7XG4gICAgaWYgKHZhbHVlLmxlbmd0aCAhPT0gbGVuZ3RoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0Vycm9yOiBTZXJ2ZXIgbWVzc2FnZSBleHBlY3RlZCBsZW5ndGggJyArIGxlbmd0aCArICcgZ290IGxlbmd0aCAnICtcbiAgICAgICAgdmFsdWUubGVuZ3RoKTtcbiAgICB9XG5cbiAgICB2YXIganNvbiA9IHBhcnNlWG1sKHZhbHVlKTtcbiAgICBsb2coJ1RyYW5zbGF0aW5nIHNlcnZlciBtZXNzYWdlIHJlc3VsdCBqc29uOiAnICsgSlNPTi5zdHJpbmdpZnkoanNvbikpO1xuICAgIHJlc3VsdC5wdXNoKGpzb24pO1xuICB9XG4gIGlmIChjb21wb25lbnRzLmxlbmd0aCAhPT0gMSkge1xuICAgIGxvZ0Vycm9yKCdNaXNtYXRjaGVkIG51bWJlciBvZiBjb21wb25lbnRzIGluIHNlcnZlciBtZXNzYWdlLicpO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gbWFrZURiZ3BNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZyk6IHN0cmluZyB7XG4gIHJldHVybiBTdHJpbmcobWVzc2FnZS5sZW5ndGgpICsgJ1xceDAwJyArIG1lc3NhZ2UgKyAnXFx4MDAnO1xufVxuXG5mdW5jdGlvbiBwYXRoVG9VcmkocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuICdmaWxlOi8vJyArIHBhdGg7XG59XG5cbmZ1bmN0aW9uIHVyaVRvUGF0aCh1cmk6IHN0cmluZyk6IHN0cmluZyB7XG4gIHZhciBjb21wb25lbnRzID0gcmVxdWlyZSgndXJsJykucGFyc2UodXJpKTtcbiAgaWYgKGNvbXBvbmVudHMucHJvdG9jb2wgIT09ICdmaWxlOicpIHtcbiAgICBsb2dFcnJvckFuZFRocm93KCd1bmV4cGVjdGVkIGZpbGUgcHJvdG9jb2wuIEdvdDogJyArIGNvbXBvbmVudHMucHJvdG9jb2wpO1xuICB9XG4gIHJldHVybiBjb21wb25lbnRzLnBhdGhuYW1lO1xufVxuXG52YXIgRFVNTVlfRlJBTUVfSUQgPSAnRnJhbWUuMCc7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBsb2csXG4gIGxvZ0Vycm9yLFxuICBsb2dFcnJvckFuZFRocm93LFxuICBtYWtlRGJncE1lc3NhZ2UsXG4gIHBhcnNlRGJncE1lc3NhZ2VzLFxuICBwYXJzZVhtbCxcbiAgYmFzZTY0RGVjb2RlLFxuICBwYXRoVG9VcmksXG4gIHVyaVRvUGF0aCxcbiAgRFVNTVlfRlJBTUVfSUQsXG59O1xuIl19
