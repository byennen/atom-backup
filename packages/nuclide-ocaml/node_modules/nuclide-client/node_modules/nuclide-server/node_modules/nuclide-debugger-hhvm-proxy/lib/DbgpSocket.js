
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _require = require('./utils');

var log = _require.log;
var logError = _require.logError;
var parseDbgpMessages = _require.parseDbgpMessages;

// Responses to the 'satus' command
var STATUS_STARTING = 'starting';
var STATUS_STOPPING = 'stopping';
var STATUS_STOPPED = 'stopped';
var STATUS_RUNNING = 'running';
var STATUS_BREAK = 'break';

// Valid continuation commands
var COMMAND_RUN = 'run';
var COMMAND_STEP_INTO = 'step_into';
var COMMAND_STEP_OVER = 'step_over';
var COMMAND_STEP_OUT = 'step_out';
var COMMAND_STOP = 'stop';

/**
 * Handles sending and recieving dbgp messages over a net Socket.
 * Dbgp documentation can be found at http://xdebug.org/docs-dbgp.php
 */

var DbgpSocket = (function () {
  function DbgpSocket(socket) {
    _classCallCheck(this, DbgpSocket);

    this._socket = socket;
    this._transactionId = 0;
    this._calls = new Map();

    this._socket.on('data', this._onData.bind(this));
  }

  _createClass(DbgpSocket, [{
    key: '_onData',
    value: function _onData(data) {
      var _this = this;

      var message = data.toString();
      log('Recieved data: ' + message);
      var responses = parseDbgpMessages(message);
      responses.forEach(function (r) {
        var response = r.response;
        if (response) {
          var responseAttributes = response.$;
          var command = responseAttributes.command;
          var transaction_id = responseAttributes.transaction_id;

          var transactionId = Number(transaction_id);
          var call = _this._calls.get(transactionId);
          if (!call) {
            logError('Missing call for response: ' + message);
            return;
          }
          _this._calls['delete'](transactionId);

          if (call.command !== command) {
            logError('Bad command in response. Found ' + command + '. expected ' + call.command);
            return;
          }
          try {
            log('Completing call: ' + message);
            call.complete(response);
          } catch (e) {
            logError('Exception: ' + e.toString() + ' handling call: ' + message);
          }
        } else {
          logError('Unexpected socket message: ' + message);
        }
      });
    }
  }, {
    key: 'getStackFrames',
    value: function getStackFrames() {
      return this._callDebugger('stack_get');
    }
  }, {
    key: 'getContextsForFrame',
    value: _asyncToGenerator(function* (frameIndex) {
      var result = yield this._callDebugger('context_names', '-d ' + frameIndex);
      return result.context.map(function (context) {
        return context.$;
      });
    })
  }, {
    key: 'getContextProperties',
    value: _asyncToGenerator(function* (frameIndex, contextId) {
      var result = yield this._callDebugger('context_get', '-d ' + frameIndex + ' -c ' + contextId);
      // 0 results yields missing 'property' member
      return result.property || [];
    })
  }, {
    key: 'getPropertiesByFullname',
    value: _asyncToGenerator(function* (frameIndex, contextId, fullname, page) {
      var result = yield this._callDebugger('property_value', '-d ' + frameIndex + ' -c ' + contextId + ' -n ' + fullname + ' -p ' + page);
      // property_value returns the outer property, we want the children ...
      // 0 results yields missing 'property' member
      return result.property[0].property || [];
    })

    // Returns one of:
    //  starting, stopping, stopped, running, break
  }, {
    key: 'getStatus',
    value: _asyncToGenerator(function* () {
      var response = yield this._callDebugger('status');
      // TODO: Do we ever care about response.$.reason?
      return response.$.status;
    })

    // Continuation commands get a response, but that response
    // is a status message which occurs after execution stops.
    // TODO: Convert the status reply to an event.
  }, {
    key: 'sendContinuationCommand',
    value: _asyncToGenerator(function* (command) {
      var response = yield this._callDebugger(command);
      return response.$.status;
    })
  }, {
    key: 'sendBreakCommand',
    value: _asyncToGenerator(function* () {
      var response = yield this._callDebugger('break');
      return response.$.success !== '0';
    })

    /**
     * Returns a breakpoint id
     */
  }, {
    key: 'setBreakpoint',
    value: _asyncToGenerator(function* (filename, lineNumber) {
      var response = yield this._callDebugger('breakpoint_set', '-t line -f ' + filename + ' -n ' + lineNumber);
      if (response.error) {
        throw new Error('Error setting breakpoint: ' + JSON.stringify(response));
      }
      // TODO: Validate that response.$.state === 'enabled'
      return response.$.id;
    })
  }, {
    key: 'removeBreakpoint',
    value: _asyncToGenerator(function* (breakpointId) {
      var response = yield this._callDebugger('breakpoint_remove', '-d ' + breakpointId);
      if (response.error) {
        throw new Error('Error removing breakpoint: ' + JSON.stringify(response));
      }
    })

    // Sends command to hhvm.
    // Returns an object containing the resulting attributes.
  }, {
    key: '_callDebugger',
    value: function _callDebugger(command, params) {
      var _this2 = this;

      var transactionId = this._sendCommand(command, params);
      return new Promise(function (resolve, reject) {
        _this2._calls.set(transactionId, {
          command: command,
          complete: function complete(result) {
            return resolve(result);
          }
        });
      });
    }
  }, {
    key: '_sendCommand',
    value: function _sendCommand(command, params) {
      var id = ++this._transactionId;
      var message = command + ' -i ' + id;
      if (params) {
        message += ' ' + params;
      }
      this._sendMessage(message);
      return id;
    }
  }, {
    key: '_sendMessage',
    value: function _sendMessage(message) {
      if (this._socket) {
        log('Sending message: ' + message);
        this._socket.write(message + '\x00');
      } else {
        logError('Attempt to send message after dispose: ' + message);
      }
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      if (this._socket) {
        // end - Sends the FIN packet and closes writing.
        // destroy - closes for reading and writing.
        this._socket.end();
        this._socket.destroy();
        this._socket = null;
      }
    }
  }]);

  return DbgpSocket;
})();

module.exports = {
  DbgpSocket: DbgpSocket,
  STATUS_STARTING: STATUS_STARTING,
  STATUS_STOPPING: STATUS_STOPPING,
  STATUS_STOPPED: STATUS_STOPPED,
  STATUS_RUNNING: STATUS_RUNNING,
  STATUS_BREAK: STATUS_BREAK,
  COMMAND_RUN: COMMAND_RUN,
  COMMAND_STEP_INTO: COMMAND_STEP_INTO,
  COMMAND_STEP_OVER: COMMAND_STEP_OVER,
  COMMAND_STEP_OUT: COMMAND_STEP_OUT,
  COMMAND_STOP: COMMAND_STOP
};

// array or object

// string

// Value if present, subject to encoding if present

// array or object members

// Maps from transactionId -> call
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL0RiZ3BTb2NrZXQuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7Ozs7O2VBWTZCLE9BQU8sQ0FBQyxTQUFTLENBQUM7O0lBQXRELEdBQUcsWUFBSCxHQUFHO0lBQUUsUUFBUSxZQUFSLFFBQVE7SUFBRSxpQkFBaUIsWUFBakIsaUJBQWlCOzs7QUFHckMsSUFBTSxlQUFlLEdBQUcsVUFBVSxDQUFDO0FBQ25DLElBQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQztBQUNuQyxJQUFNLGNBQWMsR0FBRyxTQUFTLENBQUM7QUFDakMsSUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDO0FBQ2pDLElBQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQzs7O0FBRzdCLElBQU0sV0FBVyxHQUFHLEtBQUssQ0FBQztBQUMxQixJQUFNLGlCQUFpQixHQUFHLFdBQVcsQ0FBQztBQUN0QyxJQUFNLGlCQUFpQixHQUFHLFdBQVcsQ0FBQztBQUN0QyxJQUFNLGdCQUFnQixHQUFHLFVBQVUsQ0FBQztBQUNwQyxJQUFNLFlBQVksR0FBRyxNQUFNLENBQUM7Ozs7Ozs7SUFvQ3RCLFVBQVU7QUFNSCxXQU5QLFVBQVUsQ0FNRixNQUFjLEVBQUU7MEJBTnhCLFVBQVU7O0FBT1osUUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7QUFDdEIsUUFBSSxDQUFDLGNBQWMsR0FBRyxDQUFDLENBQUM7QUFDeEIsUUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDOztBQUV4QixRQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztHQUNsRDs7ZUFaRyxVQUFVOztXQWNQLGlCQUFDLElBQXFCLEVBQVE7OztBQUNuQyxVQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7QUFDOUIsU0FBRyxDQUFDLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxDQUFDO0FBQ2pDLFVBQUksU0FBUyxHQUFHLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNDLGVBQVMsQ0FBQyxPQUFPLENBQUMsVUFBQSxDQUFDLEVBQUk7QUFDckIsWUFBSSxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQztBQUMxQixZQUFJLFFBQVEsRUFBRTtBQUNaLGNBQUksa0JBQWtCLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQztjQUMvQixPQUFPLEdBQW9CLGtCQUFrQixDQUE3QyxPQUFPO2NBQUUsY0FBYyxHQUFJLGtCQUFrQixDQUFwQyxjQUFjOztBQUM1QixjQUFJLGFBQWEsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDM0MsY0FBSSxJQUFJLEdBQUcsTUFBSyxNQUFNLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQzFDLGNBQUksQ0FBQyxJQUFJLEVBQUU7QUFDVCxvQkFBUSxDQUFDLDZCQUE2QixHQUFHLE9BQU8sQ0FBQyxDQUFDO0FBQ2xELG1CQUFPO1dBQ1I7QUFDRCxnQkFBSyxNQUFNLFVBQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQzs7QUFFbEMsY0FBSSxJQUFJLENBQUMsT0FBTyxLQUFLLE9BQU8sRUFBRTtBQUM1QixvQkFBUSxDQUFDLGlDQUFpQyxHQUFHLE9BQU8sR0FBRyxhQUFhLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3JGLG1CQUFPO1dBQ1I7QUFDRCxjQUFJO0FBQ0YsZUFBRyxDQUFDLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxDQUFDO0FBQ25DLGdCQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1dBQ3pCLENBQUMsT0FBTyxDQUFDLEVBQUU7QUFDVixvQkFBUSxDQUFDLGFBQWEsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEdBQUcsa0JBQWtCLEdBQUcsT0FBTyxDQUFDLENBQUM7V0FDdkU7U0FDRixNQUFNO0FBQ0wsa0JBQVEsQ0FBQyw2QkFBNkIsR0FBRyxPQUFPLENBQUMsQ0FBQztTQUNuRDtPQUNGLENBQUMsQ0FBQztLQUNKOzs7V0FFYSwwQkFBMkI7QUFDdkMsYUFBTyxJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0tBQ3hDOzs7NkJBRXdCLFdBQUMsVUFBa0IsRUFBK0I7QUFDekUsVUFBSSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLGVBQWUsVUFBUSxVQUFVLENBQUcsQ0FBQztBQUMzRSxhQUFPLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsT0FBTztlQUFJLE9BQU8sQ0FBQyxDQUFDO09BQUEsQ0FBQyxDQUFDO0tBQ2pEOzs7NkJBRXlCLFdBQUMsVUFBa0IsRUFBRSxTQUFpQixFQUFnQztBQUM5RixVQUFJLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxVQUFRLFVBQVUsWUFBTyxTQUFTLENBQUcsQ0FBQzs7QUFFekYsYUFBTyxNQUFNLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztLQUM5Qjs7OzZCQUU0QixXQUFDLFVBQWtCLEVBQUUsU0FBaUIsRUFBRSxRQUFnQixFQUNqRixJQUFZLEVBQWdDO0FBQzlDLFVBQUksTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FDbkMsZ0JBQWdCLFVBQVEsVUFBVSxZQUFPLFNBQVMsWUFBTyxRQUFRLFlBQU8sSUFBSSxDQUFHLENBQUM7OztBQUdsRixhQUFPLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxJQUFJLEVBQUUsQ0FBQztLQUMxQzs7Ozs7OzZCQUljLGFBQW9CO0FBQ2pDLFVBQUksUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQzs7QUFFbEQsYUFBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQztLQUMxQjs7Ozs7Ozs2QkFLNEIsV0FBQyxPQUFlLEVBQW1CO0FBQzlELFVBQUksUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNqRCxhQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0tBQzFCOzs7NkJBRXFCLGFBQXFCO0FBQ3pDLFVBQUksUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNqRCxhQUFPLFFBQVEsQ0FBQyxDQUFDLENBQUMsT0FBTyxLQUFLLEdBQUcsQ0FBQztLQUNuQzs7Ozs7Ozs2QkFLa0IsV0FBQyxRQUFnQixFQUFFLFVBQWtCLEVBQW1CO0FBQ3pFLFVBQUksUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsQ0FBQyxnQkFBZ0Isa0JBQWdCLFFBQVEsWUFBTyxVQUFVLENBQUcsQ0FBQztBQUNyRyxVQUFJLFFBQVEsQ0FBQyxLQUFLLEVBQUU7QUFDbEIsY0FBTSxJQUFJLEtBQUssQ0FBQyw0QkFBNEIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7T0FDMUU7O0FBRUQsYUFBTyxRQUFRLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztLQUN0Qjs7OzZCQUVxQixXQUFDLFlBQW9CLEVBQVc7QUFDcEQsVUFBSSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxDQUFDLG1CQUFtQixVQUFRLFlBQVksQ0FBRyxDQUFDO0FBQ25GLFVBQUksUUFBUSxDQUFDLEtBQUssRUFBRTtBQUNsQixjQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztPQUMzRTtLQUNGOzs7Ozs7V0FJWSx1QkFBQyxPQUFlLEVBQUUsTUFBZSxFQUFtQjs7O0FBQy9ELFVBQUksYUFBYSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3ZELGFBQU8sSUFBSSxPQUFPLENBQUMsVUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFLO0FBQ3RDLGVBQUssTUFBTSxDQUFDLEdBQUcsQ0FBQyxhQUFhLEVBQUU7QUFDN0IsaUJBQU8sRUFBUCxPQUFPO0FBQ1Asa0JBQVEsRUFBRSxrQkFBQSxNQUFNO21CQUFJLE9BQU8sQ0FBQyxNQUFNLENBQUM7V0FBQTtTQUNwQyxDQUFDLENBQUM7T0FDSixDQUFDLENBQUM7S0FDSjs7O1dBRVcsc0JBQUMsT0FBZSxFQUFFLE1BQWUsRUFBVTtBQUNyRCxVQUFJLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxjQUFjLENBQUM7QUFDL0IsVUFBSSxPQUFPLEdBQU0sT0FBTyxZQUFPLEVBQUUsQUFBRSxDQUFDO0FBQ3BDLFVBQUksTUFBTSxFQUFFO0FBQ1YsZUFBTyxJQUFJLEdBQUcsR0FBRyxNQUFNLENBQUM7T0FDekI7QUFDRCxVQUFJLENBQUMsWUFBWSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQzNCLGFBQU8sRUFBRSxDQUFDO0tBQ1g7OztXQUVXLHNCQUFDLE9BQWUsRUFBUTtBQUNsQyxVQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7QUFDaEIsV0FBRyxDQUFDLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxDQUFDO0FBQ25DLFlBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQztPQUN0QyxNQUFNO0FBQ0wsZ0JBQVEsQ0FBQyx5Q0FBeUMsR0FBRyxPQUFPLENBQUMsQ0FBQztPQUMvRDtLQUNGOzs7V0FFTSxtQkFBUztBQUNkLFVBQUksSUFBSSxDQUFDLE9BQU8sRUFBRTs7O0FBR2hCLFlBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLENBQUM7QUFDbkIsWUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN2QixZQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztPQUNyQjtLQUNGOzs7U0F0SkcsVUFBVTs7O0FBeUpoQixNQUFNLENBQUMsT0FBTyxHQUFHO0FBQ2YsWUFBVSxFQUFWLFVBQVU7QUFDVixpQkFBZSxFQUFmLGVBQWU7QUFDZixpQkFBZSxFQUFmLGVBQWU7QUFDZixnQkFBYyxFQUFkLGNBQWM7QUFDZCxnQkFBYyxFQUFkLGNBQWM7QUFDZCxjQUFZLEVBQVosWUFBWTtBQUNaLGFBQVcsRUFBWCxXQUFXO0FBQ1gsbUJBQWlCLEVBQWpCLGlCQUFpQjtBQUNqQixtQkFBaUIsRUFBakIsaUJBQWlCO0FBQ2pCLGtCQUFnQixFQUFoQixnQkFBZ0I7QUFDaEIsY0FBWSxFQUFaLFlBQVk7Q0FDYixDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL0RiZ3BTb2NrZXQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG5cbnZhciB7bG9nLCBsb2dFcnJvciwgcGFyc2VEYmdwTWVzc2FnZXN9ID0gcmVxdWlyZSgnLi91dGlscycpO1xuXG4vLyBSZXNwb25zZXMgdG8gdGhlICdzYXR1cycgY29tbWFuZFxuY29uc3QgU1RBVFVTX1NUQVJUSU5HID0gJ3N0YXJ0aW5nJztcbmNvbnN0IFNUQVRVU19TVE9QUElORyA9ICdzdG9wcGluZyc7XG5jb25zdCBTVEFUVVNfU1RPUFBFRCA9ICdzdG9wcGVkJztcbmNvbnN0IFNUQVRVU19SVU5OSU5HID0gJ3J1bm5pbmcnO1xuY29uc3QgU1RBVFVTX0JSRUFLID0gJ2JyZWFrJztcblxuLy8gVmFsaWQgY29udGludWF0aW9uIGNvbW1hbmRzXG5jb25zdCBDT01NQU5EX1JVTiA9ICdydW4nO1xuY29uc3QgQ09NTUFORF9TVEVQX0lOVE8gPSAnc3RlcF9pbnRvJztcbmNvbnN0IENPTU1BTkRfU1RFUF9PVkVSID0gJ3N0ZXBfb3Zlcic7XG5jb25zdCBDT01NQU5EX1NURVBfT1VUID0gJ3N0ZXBfb3V0JztcbmNvbnN0IENPTU1BTkRfU1RPUCA9ICdzdG9wJztcblxudHlwZSBEYmdwQ29udGV4dCA9IHtcbiAgbmFtZTogc3RyaW5nO1xuICBpZDogc3RyaW5nO1xufTtcblxudHlwZSBEYmdwUHJvcGVydHkgPSB7XG4gICQ6IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgZnVsbG5hbWU6IHN0cmluZztcbiAgICBhZGRyZXNzOiBzdHJpbmc7XG4gICAgdHlwZTogc3RyaW5nO1xuXG4gICAgLy8gYXJyYXkgb3Igb2JqZWN0XG4gICAgY2hpbGRyZW4/OiBib29sZWFuO1xuICAgIG51bUNoaWxkcmVuPzogbnVtYmVyO1xuICAgIHBhZ2U/OiBudW1iZXI7XG4gICAgcGFnZXNpemU/OiBudW1iZXI7XG5cbiAgICAvLyBzdHJpbmdcbiAgICBzaXplPzogbnVtYmVyO1xuICAgIGVuY29kaW5nPzogc3RyaW5nO1xuICB9O1xuXG4gIC8vIFZhbHVlIGlmIHByZXNlbnQsIHN1YmplY3QgdG8gZW5jb2RpbmcgaWYgcHJlc2VudFxuICBfPzogc3RyaW5nO1xuXG4gIC8vIGFycmF5IG9yIG9iamVjdCBtZW1iZXJzXG4gIHByb3BlcnR5PzogQXJyYXk8RGJncFByb3BlcnR5Pjtcbn07XG5cbi8qKlxuICogSGFuZGxlcyBzZW5kaW5nIGFuZCByZWNpZXZpbmcgZGJncCBtZXNzYWdlcyBvdmVyIGEgbmV0IFNvY2tldC5cbiAqIERiZ3AgZG9jdW1lbnRhdGlvbiBjYW4gYmUgZm91bmQgYXQgaHR0cDovL3hkZWJ1Zy5vcmcvZG9jcy1kYmdwLnBocFxuICovXG5jbGFzcyBEYmdwU29ja2V0IHtcbiAgX3NvY2tldDogU29ja2V0O1xuICBfdHJhbnNhY3Rpb25JZDogbnVtYmVyO1xuICAvLyBNYXBzIGZyb20gdHJhbnNhY3Rpb25JZCAtPiBjYWxsXG4gIF9jYWxsczogTWFwPG51bWJlciwge2NvbW1hbmQ6IHN0cmluZzsgY29tcGxldGU6IChyZXN1bHRzOiBPYmplY3QpID0+IHZvaWR9PjtcblxuICBjb25zdHJ1Y3Rvcihzb2NrZXQ6IFNvY2tldCkge1xuICAgIHRoaXMuX3NvY2tldCA9IHNvY2tldDtcbiAgICB0aGlzLl90cmFuc2FjdGlvbklkID0gMDtcbiAgICB0aGlzLl9jYWxscyA9IG5ldyBNYXAoKTtcblxuICAgIHRoaXMuX3NvY2tldC5vbignZGF0YScsIHRoaXMuX29uRGF0YS5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIF9vbkRhdGEoZGF0YTogQnVmZmVyIHwgc3RyaW5nKTogdm9pZCB7XG4gICAgdmFyIG1lc3NhZ2UgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgbG9nKCdSZWNpZXZlZCBkYXRhOiAnICsgbWVzc2FnZSk7XG4gICAgdmFyIHJlc3BvbnNlcyA9IHBhcnNlRGJncE1lc3NhZ2VzKG1lc3NhZ2UpO1xuICAgIHJlc3BvbnNlcy5mb3JFYWNoKHIgPT4ge1xuICAgICAgdmFyIHJlc3BvbnNlID0gci5yZXNwb25zZTtcbiAgICAgIGlmIChyZXNwb25zZSkge1xuICAgICAgICB2YXIgcmVzcG9uc2VBdHRyaWJ1dGVzID0gcmVzcG9uc2UuJDtcbiAgICAgICAgdmFyIHtjb21tYW5kLCB0cmFuc2FjdGlvbl9pZH0gPSByZXNwb25zZUF0dHJpYnV0ZXM7XG4gICAgICAgIHZhciB0cmFuc2FjdGlvbklkID0gTnVtYmVyKHRyYW5zYWN0aW9uX2lkKTtcbiAgICAgICAgdmFyIGNhbGwgPSB0aGlzLl9jYWxscy5nZXQodHJhbnNhY3Rpb25JZCk7XG4gICAgICAgIGlmICghY2FsbCkge1xuICAgICAgICAgIGxvZ0Vycm9yKCdNaXNzaW5nIGNhbGwgZm9yIHJlc3BvbnNlOiAnICsgbWVzc2FnZSk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX2NhbGxzLmRlbGV0ZSh0cmFuc2FjdGlvbklkKTtcblxuICAgICAgICBpZiAoY2FsbC5jb21tYW5kICE9PSBjb21tYW5kKSB7XG4gICAgICAgICAgbG9nRXJyb3IoJ0JhZCBjb21tYW5kIGluIHJlc3BvbnNlLiBGb3VuZCAnICsgY29tbWFuZCArICcuIGV4cGVjdGVkICcgKyBjYWxsLmNvbW1hbmQpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgIGxvZygnQ29tcGxldGluZyBjYWxsOiAnICsgbWVzc2FnZSk7XG4gICAgICAgICAgY2FsbC5jb21wbGV0ZShyZXNwb25zZSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICBsb2dFcnJvcignRXhjZXB0aW9uOiAnICsgZS50b1N0cmluZygpICsgJyBoYW5kbGluZyBjYWxsOiAnICsgbWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZ0Vycm9yKCdVbmV4cGVjdGVkIHNvY2tldCBtZXNzYWdlOiAnICsgbWVzc2FnZSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBnZXRTdGFja0ZyYW1lcygpOiBQcm9taXNlPEFycmF5PE9iamVjdD4+IHtcbiAgICByZXR1cm4gdGhpcy5fY2FsbERlYnVnZ2VyKCdzdGFja19nZXQnKTtcbiAgfVxuXG4gIGFzeW5jIGdldENvbnRleHRzRm9yRnJhbWUoZnJhbWVJbmRleDogbnVtYmVyKTogUHJvbWlzZTxBcnJheTxEYmdwQ29udGV4dD4+IHtcbiAgICB2YXIgcmVzdWx0ID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKCdjb250ZXh0X25hbWVzJywgYC1kICR7ZnJhbWVJbmRleH1gKTtcbiAgICByZXR1cm4gcmVzdWx0LmNvbnRleHQubWFwKGNvbnRleHQgPT4gY29udGV4dC4kKTtcbiAgfVxuXG4gIGFzeW5jIGdldENvbnRleHRQcm9wZXJ0aWVzKGZyYW1lSW5kZXg6IG51bWJlciwgY29udGV4dElkOiBzdHJpbmcpOiBQcm9taXNlPEFycmF5PERiZ3BQcm9wZXJ0eT4+IHtcbiAgICB2YXIgcmVzdWx0ID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKCdjb250ZXh0X2dldCcsIGAtZCAke2ZyYW1lSW5kZXh9IC1jICR7Y29udGV4dElkfWApO1xuICAgIC8vIDAgcmVzdWx0cyB5aWVsZHMgbWlzc2luZyAncHJvcGVydHknIG1lbWJlclxuICAgIHJldHVybiByZXN1bHQucHJvcGVydHkgfHwgW107XG4gIH1cblxuICBhc3luYyBnZXRQcm9wZXJ0aWVzQnlGdWxsbmFtZShmcmFtZUluZGV4OiBudW1iZXIsIGNvbnRleHRJZDogc3RyaW5nLCBmdWxsbmFtZTogc3RyaW5nLFxuICAgICAgcGFnZTogbnVtYmVyKTogUHJvbWlzZTxBcnJheTxEYmdwUHJvcGVydHk+PiB7XG4gICAgdmFyIHJlc3VsdCA9IGF3YWl0IHRoaXMuX2NhbGxEZWJ1Z2dlcihcbiAgICAgICdwcm9wZXJ0eV92YWx1ZScsIGAtZCAke2ZyYW1lSW5kZXh9IC1jICR7Y29udGV4dElkfSAtbiAke2Z1bGxuYW1lfSAtcCAke3BhZ2V9YCk7XG4gICAgLy8gcHJvcGVydHlfdmFsdWUgcmV0dXJucyB0aGUgb3V0ZXIgcHJvcGVydHksIHdlIHdhbnQgdGhlIGNoaWxkcmVuIC4uLlxuICAgIC8vIDAgcmVzdWx0cyB5aWVsZHMgbWlzc2luZyAncHJvcGVydHknIG1lbWJlclxuICAgIHJldHVybiByZXN1bHQucHJvcGVydHlbMF0ucHJvcGVydHkgfHwgW107XG4gIH1cblxuICAvLyBSZXR1cm5zIG9uZSBvZjpcbiAgLy8gIHN0YXJ0aW5nLCBzdG9wcGluZywgc3RvcHBlZCwgcnVubmluZywgYnJlYWtcbiAgYXN5bmMgZ2V0U3RhdHVzKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdmFyIHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKCdzdGF0dXMnKTtcbiAgICAvLyBUT0RPOiBEbyB3ZSBldmVyIGNhcmUgYWJvdXQgcmVzcG9uc2UuJC5yZWFzb24/XG4gICAgcmV0dXJuIHJlc3BvbnNlLiQuc3RhdHVzO1xuICB9XG5cbiAgLy8gQ29udGludWF0aW9uIGNvbW1hbmRzIGdldCBhIHJlc3BvbnNlLCBidXQgdGhhdCByZXNwb25zZVxuICAvLyBpcyBhIHN0YXR1cyBtZXNzYWdlIHdoaWNoIG9jY3VycyBhZnRlciBleGVjdXRpb24gc3RvcHMuXG4gIC8vIFRPRE86IENvbnZlcnQgdGhlIHN0YXR1cyByZXBseSB0byBhbiBldmVudC5cbiAgYXN5bmMgc2VuZENvbnRpbnVhdGlvbkNvbW1hbmQoY29tbWFuZDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB2YXIgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9jYWxsRGVidWdnZXIoY29tbWFuZCk7XG4gICAgcmV0dXJuIHJlc3BvbnNlLiQuc3RhdHVzO1xuICB9XG5cbiAgYXN5bmMgc2VuZEJyZWFrQ29tbWFuZCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICB2YXIgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9jYWxsRGVidWdnZXIoJ2JyZWFrJyk7XG4gICAgcmV0dXJuIHJlc3BvbnNlLiQuc3VjY2VzcyAhPT0gJzAnO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybnMgYSBicmVha3BvaW50IGlkXG4gICAqL1xuICBhc3luYyBzZXRCcmVha3BvaW50KGZpbGVuYW1lOiBzdHJpbmcsIGxpbmVOdW1iZXI6IG51bWJlcik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdmFyIHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fY2FsbERlYnVnZ2VyKCdicmVha3BvaW50X3NldCcsIGAtdCBsaW5lIC1mICR7ZmlsZW5hbWV9IC1uICR7bGluZU51bWJlcn1gKTtcbiAgICBpZiAocmVzcG9uc2UuZXJyb3IpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRXJyb3Igc2V0dGluZyBicmVha3BvaW50OiAnICsgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICB9XG4gICAgLy8gVE9ETzogVmFsaWRhdGUgdGhhdCByZXNwb25zZS4kLnN0YXRlID09PSAnZW5hYmxlZCdcbiAgICByZXR1cm4gcmVzcG9uc2UuJC5pZDtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZUJyZWFrcG9pbnQoYnJlYWtwb2ludElkOiBzdHJpbmcpOiBQcm9taXNlIHtcbiAgICB2YXIgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLl9jYWxsRGVidWdnZXIoJ2JyZWFrcG9pbnRfcmVtb3ZlJywgYC1kICR7YnJlYWtwb2ludElkfWApO1xuICAgIGlmIChyZXNwb25zZS5lcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciByZW1vdmluZyBicmVha3BvaW50OiAnICsgSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UpKTtcbiAgICB9XG4gIH1cblxuICAvLyBTZW5kcyBjb21tYW5kIHRvIGhodm0uXG4gIC8vIFJldHVybnMgYW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIHJlc3VsdGluZyBhdHRyaWJ1dGVzLlxuICBfY2FsbERlYnVnZ2VyKGNvbW1hbmQ6IHN0cmluZywgcGFyYW1zOiA/c3RyaW5nKTogUHJvbWlzZTxPYmplY3Q+IHtcbiAgICB2YXIgdHJhbnNhY3Rpb25JZCA9IHRoaXMuX3NlbmRDb21tYW5kKGNvbW1hbmQsIHBhcmFtcyk7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHRoaXMuX2NhbGxzLnNldCh0cmFuc2FjdGlvbklkLCB7XG4gICAgICAgIGNvbW1hbmQsXG4gICAgICAgIGNvbXBsZXRlOiByZXN1bHQgPT4gcmVzb2x2ZShyZXN1bHQpLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBfc2VuZENvbW1hbmQoY29tbWFuZDogc3RyaW5nLCBwYXJhbXM6ID9zdHJpbmcpOiBudW1iZXIge1xuICAgIHZhciBpZCA9ICsrdGhpcy5fdHJhbnNhY3Rpb25JZDtcbiAgICB2YXIgbWVzc2FnZSA9IGAke2NvbW1hbmR9IC1pICR7aWR9YDtcbiAgICBpZiAocGFyYW1zKSB7XG4gICAgICBtZXNzYWdlICs9ICcgJyArIHBhcmFtcztcbiAgICB9XG4gICAgdGhpcy5fc2VuZE1lc3NhZ2UobWVzc2FnZSk7XG4gICAgcmV0dXJuIGlkO1xuICB9XG5cbiAgX3NlbmRNZXNzYWdlKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9zb2NrZXQpIHtcbiAgICAgIGxvZygnU2VuZGluZyBtZXNzYWdlOiAnICsgbWVzc2FnZSk7XG4gICAgICB0aGlzLl9zb2NrZXQud3JpdGUobWVzc2FnZSArICdcXHgwMCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2dFcnJvcignQXR0ZW1wdCB0byBzZW5kIG1lc3NhZ2UgYWZ0ZXIgZGlzcG9zZTogJyArIG1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIGRpc3Bvc2UoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3NvY2tldCkge1xuICAgICAgLy8gZW5kIC0gU2VuZHMgdGhlIEZJTiBwYWNrZXQgYW5kIGNsb3NlcyB3cml0aW5nLlxuICAgICAgLy8gZGVzdHJveSAtIGNsb3NlcyBmb3IgcmVhZGluZyBhbmQgd3JpdGluZy5cbiAgICAgIHRoaXMuX3NvY2tldC5lbmQoKTtcbiAgICAgIHRoaXMuX3NvY2tldC5kZXN0cm95KCk7XG4gICAgICB0aGlzLl9zb2NrZXQgPSBudWxsO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgRGJncFNvY2tldCxcbiAgU1RBVFVTX1NUQVJUSU5HLFxuICBTVEFUVVNfU1RPUFBJTkcsXG4gIFNUQVRVU19TVE9QUEVELFxuICBTVEFUVVNfUlVOTklORyxcbiAgU1RBVFVTX0JSRUFLLFxuICBDT01NQU5EX1JVTixcbiAgQ09NTUFORF9TVEVQX0lOVE8sXG4gIENPTU1BTkRfU1RFUF9PVkVSLFxuICBDT01NQU5EX1NURVBfT1VULFxuICBDT01NQU5EX1NUT1AsXG59O1xuIl19
