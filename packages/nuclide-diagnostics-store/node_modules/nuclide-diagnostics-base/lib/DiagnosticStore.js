var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

'use babel';

var _require = require('atom');

var Disposable = _require.Disposable;
var Emitter = _require.Emitter;

var PROJECT_MESSAGE_CHANGE_EVENT = 'messages-changed-for-project';
var ALL_CHANGE_EVENT = 'messages-changed';

var DiagnosticStore = (function () {
  function DiagnosticStore() {
    _classCallCheck(this, DiagnosticStore);

    this._providerToFileToMessages = new Map();
    this._fileToProviders = new Map();
    this._providerToProjectDiagnostics = new Map();

    this._fileChangeEmitter = new Emitter();
    this._nonFileChangeEmitter = new Emitter();
    this._fileToListenersCount = new Map();
    this._projectListenersCount = 0;
    this._allMessagesListenersCount = 0;
  }

  _createClass(DiagnosticStore, [{
    key: 'dispose',
    value: function dispose() {
      this._providerToFileToMessages.clear();
      this._fileToProviders.clear();
      this._providerToProjectDiagnostics.clear();
      this._fileChangeEmitter.dispose();
      this._nonFileChangeEmitter.dispose();
      this._fileToListenersCount.clear();
    }

    /**
     * Section: Methods to modify the store.
     */

    /**
     * Update the messages from the given provider.
     * If the update contains messages at a scope that already has messages from
     * this provider in the store, the existing messages will be overwritten by the
     * new messages.
     * @param diagnosticProvider The diagnostic provider that these messages come from.
     * @param updates Set of updates to apply.
     */
  }, {
    key: 'updateMessages',
    value: function updateMessages(diagnosticProvider, updates) {
      if (updates.filePathToMessages) {
        this._updateFileMessages(diagnosticProvider, updates.filePathToMessages);
      }
      if (updates.projectMessages) {
        this._updateProjectMessages(diagnosticProvider, updates.projectMessages);
      }
      if (updates.filePathToMessages || updates.projectMessages) {
        this._emitAllMessages();
      }
    }
  }, {
    key: '_updateFileMessages',
    value: function _updateFileMessages(diagnosticProvider, newFilePathsToMessages) {
      var _this = this;

      var fileToMessages = this._providerToFileToMessages.get(diagnosticProvider);
      if (!fileToMessages) {
        fileToMessages = new Map();
        this._providerToFileToMessages.set(diagnosticProvider, fileToMessages);
      }
      newFilePathsToMessages.forEach(function (newMessagesForPath, filePath) {
        // Update _providerToFileToMessages.
        fileToMessages.set(filePath, newMessagesForPath);
        // Update _fileToProviders.
        var providers = _this._fileToProviders.get(filePath);
        if (!providers) {
          providers = new Set();
          _this._fileToProviders.set(filePath, providers);
        }
        providers.add(diagnosticProvider);

        _this._emitFileMessages(filePath);
      });
    }
  }, {
    key: '_updateProjectMessages',
    value: function _updateProjectMessages(diagnosticProvider, projectMessages) {
      this._providerToProjectDiagnostics.set(diagnosticProvider, projectMessages);
      this._emitProjectMessages();
    }

    /**
     * Clear the messages from the given provider, according to the options.
     * @param options An Object of the form:
     *   * scope: Can be 'file', 'project', or 'all'.
     *       * 'file': The 'filePaths' option determines which files' messages to clear
     *       * 'project': all 'project' scope messages are cleared.
     *       * 'all': all messages are cleared.
     *   * filePaths: Array of absolute file paths (NuclideUri) to clear messages for.
     */
  }, {
    key: 'invalidateMessages',
    value: function invalidateMessages(diagnosticProvider, invalidationMessage) {
      if (invalidationMessage.scope === 'file') {
        this._invalidateFileMessagesForProvider(diagnosticProvider, invalidationMessage.filePaths);
        this._emitAllMessages();
      } else if (invalidationMessage.scope === 'project') {
        this._invalidateProjectMessagesForProvider(diagnosticProvider);
        this._emitAllMessages();
      } else if (invalidationMessage.scope === 'all') {
        this._invalidateAllMessagesForProvider(diagnosticProvider);
      }
    }
  }, {
    key: '_invalidateFileMessagesForProvider',
    value: function _invalidateFileMessagesForProvider(diagnosticProvider, pathsToRemove) {
      var fileToDiagnostics = this._providerToFileToMessages.get(diagnosticProvider);
      for (var filePath of pathsToRemove) {
        // Update _providerToFileToMessages.
        if (fileToDiagnostics) {
          fileToDiagnostics['delete'](filePath);
        }
        // Update _fileToProviders.
        var providers = this._fileToProviders.get(filePath);
        if (providers) {
          providers['delete'](diagnosticProvider);
        }
        this._emitFileMessages(filePath);
      }
    }
  }, {
    key: '_invalidateProjectMessagesForProvider',
    value: function _invalidateProjectMessagesForProvider(diagnosticProvider) {
      this._providerToProjectDiagnostics['delete'](diagnosticProvider);
      this._emitProjectMessages();
    }
  }, {
    key: '_invalidateAllMessagesForProvider',
    value: function _invalidateAllMessagesForProvider(diagnosticProvider) {
      // Invalidate all file messages.
      var filesToDiagnostics = this._providerToFileToMessages.get(diagnosticProvider);
      if (filesToDiagnostics) {
        var allFilePaths = filesToDiagnostics.keys();
        this._invalidateFileMessagesForProvider(diagnosticProvider, allFilePaths);
      }
      // Invalidate all project messages.
      this._invalidateProjectMessagesForProvider(diagnosticProvider);

      this._emitAllMessages();
    }

    /**
     * Section: Methods to read from the store.
     */

    /**
     * Call the callback when the filePath's messages have changed.
     * In addition, the Store will immediately invoke the callback with the data
     * currently in the Store, iff there is any.
     * @param callback The function to message when any of the filePaths' messages
     *   change. The array of messages is meant to completely replace any previous
     *   messages for this file path.
     */
  }, {
    key: 'onFileMessagesDidUpdate',
    value: function onFileMessagesDidUpdate(callback, filePath) {
      var _this2 = this;

      // Use the filePath as the event name.
      var emitterDisposable = this._fileChangeEmitter.on(filePath, callback);
      this._incrementFileListenerCount(filePath);

      var fileMessages = this._getFileMessages(filePath);
      if (fileMessages.length) {
        callback({ filePath: filePath, messages: fileMessages });
      }
      return new Disposable(function () {
        emitterDisposable.dispose();
        _this2._decrementFileListenerCount(filePath);
      });
    }
  }, {
    key: '_incrementFileListenerCount',
    value: function _incrementFileListenerCount(filePath) {
      var currentCount = this._fileToListenersCount.get(filePath) || 0;
      this._fileToListenersCount.set(filePath, currentCount + 1);
    }
  }, {
    key: '_decrementFileListenerCount',
    value: function _decrementFileListenerCount(filePath) {
      var currentCount = this._fileToListenersCount.get(filePath) || 0;
      if (currentCount > 0) {
        this._fileToListenersCount.set(filePath, currentCount - 1);
      }
    }

    /**
     * Call the callback when project-scope messages change.
     * In addition, the Store will immediately invoke the callback with the data
     * currently in the Store, iff there is any.
     * @param callback The function to message when the project-scope messages
     *   change. The array of messages is meant to completely replace any previous
     *   project-scope messages.
     */
  }, {
    key: 'onProjectMessagesDidUpdate',
    value: function onProjectMessagesDidUpdate(callback) {
      var _this3 = this;

      var emitterDisposable = this._nonFileChangeEmitter.on(PROJECT_MESSAGE_CHANGE_EVENT, callback);
      this._projectListenersCount += 1;

      var projectMessages = this._getProjectMessages();
      if (projectMessages.length) {
        callback(projectMessages);
      }
      return new Disposable(function () {
        emitterDisposable.dispose();
        _this3._projectListenersCount -= 1;
      });
    }

    /**
     * Call the callback when any messages change.
     * In addition, the Store will immediately invoke the callback with data
     * currently in the Store, iff there is any.
     * @param callback The function to message when any messages change. The array
     *   of messages is meant to completely replace any previous messages.
     */
  }, {
    key: 'onAllMessagesDidUpdate',
    value: function onAllMessagesDidUpdate(callback) {
      var _this4 = this;

      var emitterDisposable = this._nonFileChangeEmitter.on(ALL_CHANGE_EVENT, callback);
      this._allMessagesListenersCount += 1;

      var allMessages = this._getAllMessages();
      if (allMessages.length) {
        callback(allMessages);
      }
      return new Disposable(function () {
        emitterDisposable.dispose();
        _this4._allMessagesListenersCount -= 1;
      });
    }

    /**
     * Gets the current diagnostic messages for the file.
     * Prefer to get updates via ::onFileMessagesDidUpdate.
     */
  }, {
    key: '_getFileMessages',
    value: function _getFileMessages(filePath) {
      var allFileMessages = [];
      var relevantProviders = this._fileToProviders.get(filePath);
      if (relevantProviders) {
        for (var provider of relevantProviders) {
          var messages = this._providerToFileToMessages.get(provider).get(filePath);
          allFileMessages = allFileMessages.concat(messages);
        }
      }
      return allFileMessages;
    }

    /**
     * Gets the current project-scope diagnostic messages.
     * Prefer to get updates via ::onProjectMessagesDidUpdate.
     */
  }, {
    key: '_getProjectMessages',
    value: function _getProjectMessages() {
      var allProjectMessages = [];
      for (var messages of this._providerToProjectDiagnostics.values()) {
        allProjectMessages = allProjectMessages.concat(messages);
      }
      return allProjectMessages;
    }

    /**
     * Gets all current diagnostic messages.
     * Prefer to get updates via ::onAllMessagesDidUpdate.
     */
  }, {
    key: '_getAllMessages',
    value: function _getAllMessages() {
      var allMessages = [];
      // Get all file messages.
      for (var fileToMessages of this._providerToFileToMessages.values()) {
        for (var messages of fileToMessages.values()) {
          allMessages = allMessages.concat(messages);
        }
      }
      // Get all project messages.
      allMessages = allMessages.concat(this._getProjectMessages());
      return allMessages;
    }

    /**
     * Section: Event Emitting
     */

  }, {
    key: '_emitFileMessages',
    value: function _emitFileMessages(filePath) {
      if (this._fileToListenersCount.get(filePath)) {
        this._fileChangeEmitter.emit(filePath, { filePath: filePath, messages: this._getFileMessages(filePath) });
      }
    }
  }, {
    key: '_emitProjectMessages',
    value: function _emitProjectMessages() {
      if (this._projectListenersCount) {
        this._nonFileChangeEmitter.emit(PROJECT_MESSAGE_CHANGE_EVENT, this._getProjectMessages());
      }
    }
  }, {
    key: '_emitAllMessages',
    value: function _emitAllMessages() {
      if (this._allMessagesListenersCount) {
        this._nonFileChangeEmitter.emit(ALL_CHANGE_EVENT, this._getAllMessages());
      }
    }
  }]);

  return DiagnosticStore;
})();

module.exports = DiagnosticStore;

// A map from each diagnostic provider to:
// a map from each file it has messages for to the array of messages for that file.

// A map from each file that has messages from any diagnostic provider
// to the set of diagnostic providers that have messages for it.

// A map from each diagnostic provider to the array of project messages from it.

// File paths are used as event names for the _fileChangeEmitter, so a second
// emitter is used for other events to prevent event name collisions.

// A map of NuclideUri to the number of listeners registered for changes to
// messages for that file.
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRpYWdub3N0aWNzLWJhc2UvbGliL0RpYWdub3N0aWNTdG9yZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7QUFBQSxXQUFXLENBQUM7O2VBdUJnQixPQUFPLENBQUMsTUFBTSxDQUFDOztJQUF0QyxVQUFVLFlBQVYsVUFBVTtJQUFFLE9BQU8sWUFBUCxPQUFPOztBQUV4QixJQUFJLDRCQUE0QixHQUFHLDhCQUE4QixDQUFDO0FBQ2xFLElBQUksZ0JBQWdCLEdBQUcsa0JBQWtCLENBQUM7O0lBRXBDLGVBQWU7QUFxQlIsV0FyQlAsZUFBZSxHQXFCTDswQkFyQlYsZUFBZTs7QUFzQmpCLFFBQUksQ0FBQyx5QkFBeUIsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQzNDLFFBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2xDLFFBQUksQ0FBQyw2QkFBNkIsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDOztBQUUvQyxRQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUN4QyxRQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztBQUMzQyxRQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUN2QyxRQUFJLENBQUMsc0JBQXNCLEdBQUcsQ0FBQyxDQUFDO0FBQ2hDLFFBQUksQ0FBQywwQkFBMEIsR0FBRyxDQUFDLENBQUM7R0FDckM7O2VBL0JHLGVBQWU7O1dBaUNaLG1CQUFHO0FBQ1IsVUFBSSxDQUFDLHlCQUF5QixDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ3ZDLFVBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUM5QixVQUFJLENBQUMsNkJBQTZCLENB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QkFBcUIsQ0FBQyxJQUFJLENBQUMsNEJBQTRCLEVBQUUsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQztPQUMzRjtLQUNGOzs7V0FFZSw0QkFBUztBQUN2QixVQUFJLElBQUksQ0FBQywwQkFBMEIsRUFBRTtBQUNuQyxZQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO09BQzNFO0tBQ0Y7OztTQTFURyxlQUFlOzs7QUE2VHJCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsZUFBZSxDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRpYWdub3N0aWNzLWJhc2UvbGliL0RpYWdub3N0aWNTdG9yZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmltcG9ydCB0eXBlIHtcbiAgSW52YWxpZGF0aW9uTWVzc2FnZSxcbiAgRGlhZ25vc3RpY01lc3NhZ2UsXG4gIERpYWdub3N0aWNQcm92aWRlcixcbiAgRGlhZ25vc3RpY1Byb3ZpZGVyVXBkYXRlLFxuICBGaWxlRGlhZ25vc3RpY01lc3NhZ2UsXG4gIFByb2plY3REaWFnbm9zdGljTWVzc2FnZSxcbiAgRmlsZU1lc3NhZ2VVcGRhdGUsXG59IGZyb20gJy4vdHlwZXMnO1xuXG5pbXBvcnQgdHlwZSB7TnVjbGlkZVVyaX0gZnJvbSAnbnVjbGlkZS1yZW1vdGUtdXJpJztcblxudmFyIHtEaXNwb3NhYmxlLCBFbWl0dGVyfSA9IHJlcXVpcmUoJ2F0b20nKTtcblxudmFyIFBST0pFQ1RfTUVTU0FHRV9DSEFOR0VfRVZFTlQgPSAnbWVzc2FnZXMtY2hhbmdlZC1mb3ItcHJvamVjdCc7XG52YXIgQUxMX0NIQU5HRV9FVkVOVCA9ICdtZXNzYWdlcy1jaGFuZ2VkJztcblxuY2xhc3MgRGlhZ25vc3RpY1N0b3JlIHtcbiAgLy8gQSBtYXAgZnJvbSBlYWNoIGRpYWdub3N0aWMgcHJvdmlkZXIgdG86XG4gIC8vIGEgbWFwIGZyb20gZWFjaCBmaWxlIGl0IGhhcyBtZXNzYWdlcyBmb3IgdG8gdGhlIGFycmF5IG9mIG1lc3NhZ2VzIGZvciB0aGF0IGZpbGUuXG4gIF9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXM6IE1hcDxEaWFnbm9zdGljUHJvdmlkZXIsIE1hcDxOdWNsaWRlVXJpLCBBcnJheTxGaWxlRGlhZ25vc3RpY01lc3NhZ2U+Pj47XG4gIC8vIEEgbWFwIGZyb20gZWFjaCBmaWxlIHRoYXQgaGFzIG1lc3NhZ2VzIGZyb20gYW55IGRpYWdub3N0aWMgcHJvdmlkZXJcbiAgLy8gdG8gdGhlIHNldCBvZiBkaWFnbm9zdGljIHByb3ZpZGVycyB0aGF0IGhhdmUgbWVzc2FnZXMgZm9yIGl0LlxuICBfZmlsZVRvUHJvdmlkZXJzOiBNYXA8TnVjbGlkZVVyaSwgU2V0PERpYWdub3N0aWNQcm92aWRlcj4+O1xuXG4gIC8vIEEgbWFwIGZyb20gZWFjaCBkaWFnbm9zdGljIHByb3ZpZGVyIHRvIHRoZSBhcnJheSBvZiBwcm9qZWN0IG1lc3NhZ2VzIGZyb20gaXQuXG4gIF9wcm92aWRlclRvUHJvamVjdERpYWdub3N0aWNzOiBNYXA8RGlhZ25vc3RpY1Byb3ZpZGVyLCBBcnJheTxQcm9qZWN0RGlhZ25vc3RpY01lc3NhZ2U+PjtcblxuICAvLyBGaWxlIHBhdGhzIGFyZSB1c2VkIGFzIGV2ZW50IG5hbWVzIGZvciB0aGUgX2ZpbGVDaGFuZ2VFbWl0dGVyLCBzbyBhIHNlY29uZFxuICAvLyBlbWl0dGVyIGlzIHVzZWQgZm9yIG90aGVyIGV2ZW50cyB0byBwcmV2ZW50IGV2ZW50IG5hbWUgY29sbGlzaW9ucy5cbiAgX2ZpbGVDaGFuZ2VFbWl0dGVyOiBFbWl0dGVyO1xuICBfbm9uRmlsZUNoYW5nZUVtaXR0ZXI6IEVtaXR0ZXI7XG4gIC8vIEEgbWFwIG9mIE51Y2xpZGVVcmkgdG8gdGhlIG51bWJlciBvZiBsaXN0ZW5lcnMgcmVnaXN0ZXJlZCBmb3IgY2hhbmdlcyB0b1xuICAvLyBtZXNzYWdlcyBmb3IgdGhhdCBmaWxlLlxuICBfZmlsZVRvTGlzdGVuZXJzQ291bnQ6IE1hcDxOdWNsaWRlVXJpLCBudW1iZXI+O1xuICBfcHJvamVjdExpc3RlbmVyc0NvdW50OiBudW1iZXI7XG4gIF9hbGxNZXNzYWdlc0xpc3RlbmVyc0NvdW50OiBudW1iZXI7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5fcHJvdmlkZXJUb0ZpbGVUb01lc3NhZ2VzID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX2ZpbGVUb1Byb3ZpZGVycyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9wcm92aWRlclRvUHJvamVjdERpYWdub3N0aWNzID0gbmV3IE1hcCgpO1xuXG4gICAgdGhpcy5fZmlsZUNoYW5nZUVtaXR0ZXIgPSBuZXcgRW1pdHRlcigpO1xuICAgIHRoaXMuX25vbkZpbGVDaGFuZ2VFbWl0dGVyID0gbmV3IEVtaXR0ZXIoKTtcbiAgICB0aGlzLl9maWxlVG9MaXN0ZW5lcnNDb3VudCA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLl9wcm9qZWN0TGlzdGVuZXJzQ291bnQgPSAwO1xuICAgIHRoaXMuX2FsbE1lc3NhZ2VzTGlzdGVuZXJzQ291bnQgPSAwO1xuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICB0aGlzLl9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXMuY2xlYXIoKTtcbiAgICB0aGlzLl9maWxlVG9Qcm92aWRlcnMuY2xlYXIoKTtcbiAgICB0aGlzLl9wcm92aWRlclRvUHJvamVjdERpYWdub3N0aWNzLmNsZWFyKCk7XG4gICAgdGhpcy5fZmlsZUNoYW5nZUVtaXR0ZXIuZGlzcG9zZSgpO1xuICAgIHRoaXMuX25vbkZpbGVDaGFuZ2VFbWl0dGVyLmRpc3Bvc2UoKTtcbiAgICB0aGlzLl9maWxlVG9MaXN0ZW5lcnNDb3VudC5jbGVhcigpO1xuICB9XG5cblxuICAvKipcbiAgICogU2VjdGlvbjogTWV0aG9kcyB0byBtb2RpZnkgdGhlIHN0b3JlLlxuICAgKi9cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSBtZXNzYWdlcyBmcm9tIHRoZSBnaXZlbiBwcm92aWRlci5cbiAgICogSWYgdGhlIHVwZGF0ZSBjb250YWlucyBtZXNzYWdlcyBhdCBhIHNjb3BlIHRoYXQgYWxyZWFkeSBoYXMgbWVzc2FnZXMgZnJvbVxuICAgKiB0aGlzIHByb3ZpZGVyIGluIHRoZSBzdG9yZSwgdGhlIGV4aXN0aW5nIG1lc3NhZ2VzIHdpbGwgYmUgb3ZlcndyaXR0ZW4gYnkgdGhlXG4gICAqIG5ldyBtZXNzYWdlcy5cbiAgICogQHBhcmFtIGRpYWdub3N0aWNQcm92aWRlciBUaGUgZGlhZ25vc3RpYyBwcm92aWRlciB0aGF0IHRoZXNlIG1lc3NhZ2VzIGNvbWUgZnJvbS5cbiAgICogQHBhcmFtIHVwZGF0ZXMgU2V0IG9mIHVwZGF0ZXMgdG8gYXBwbHkuXG4gICAqL1xuICB1cGRhdGVNZXNzYWdlcyhcbiAgICAgIGRpYWdub3N0aWNQcm92aWRlcjogRGlhZ25vc3RpY1Byb3ZpZGVyLFxuICAgICAgdXBkYXRlczogRGlhZ25vc3RpY1Byb3ZpZGVyVXBkYXRlLFxuICAgICk6IHZvaWQge1xuICAgIGlmICh1cGRhdGVzLmZpbGVQYXRoVG9NZXNzYWdlcykge1xuICAgICAgdGhpcy5fdXBkYXRlRmlsZU1lc3NhZ2VzKGRpYWdub3N0aWNQcm92aWRlciwgdXBkYXRlcy5maWxlUGF0aFRvTWVzc2FnZXMpO1xuICAgIH1cbiAgICBpZiAodXBkYXRlcy5wcm9qZWN0TWVzc2FnZXMpIHtcbiAgICAgIHRoaXMuX3VwZGF0ZVByb2plY3RNZXNzYWdlcyhkaWFnbm9zdGljUHJvdmlkZXIsIHVwZGF0ZXMucHJvamVjdE1lc3NhZ2VzKTtcbiAgICB9XG4gICAgaWYgKHVwZGF0ZXMuZmlsZVBhdGhUb01lc3NhZ2VzIHx8IHVwZGF0ZXMucHJvamVjdE1lc3NhZ2VzKSB7XG4gICAgICB0aGlzLl9lbWl0QWxsTWVzc2FnZXMoKTtcbiAgICB9XG4gIH1cblxuICBfdXBkYXRlRmlsZU1lc3NhZ2VzKFxuICAgICAgZGlhZ25vc3RpY1Byb3ZpZGVyOiBEaWFnbm9zdGljUHJvdmlkZXIsXG4gICAgICBuZXdGaWxlUGF0aHNUb01lc3NhZ2VzOiBNYXA8TnVjbGlkZVVyaSwgQXJyYXk8RmlsZURpYWdub3N0aWNNZXNzYWdlPj5cbiAgICApOiB2b2lkIHtcbiAgICB2YXIgZmlsZVRvTWVzc2FnZXMgPSB0aGlzLl9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXMuZ2V0KGRpYWdub3N0aWNQcm92aWRlcik7XG4gICAgaWYgKCFmaWxlVG9NZXNzYWdlcykge1xuICAgICAgZmlsZVRvTWVzc2FnZXMgPSBuZXcgTWFwKCk7XG4gICAgICB0aGlzLl9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXMuc2V0KGRpYWdub3N0aWNQcm92aWRlciwgZmlsZVRvTWVzc2FnZXMpO1xuICAgIH1cbiAgICBuZXdGaWxlUGF0aHNUb01lc3NhZ2VzLmZvckVhY2goKG5ld01lc3NhZ2VzRm9yUGF0aCwgZmlsZVBhdGgpID0+IHtcbiAgICAgIC8vIFVwZGF0ZSBfcHJvdmlkZXJUb0ZpbGVUb01lc3NhZ2VzLlxuICAgICAgZmlsZVRvTWVzc2FnZXMuc2V0KGZpbGVQYXRoLCBuZXdNZXNzYWdlc0ZvclBhdGgpO1xuICAgICAgLy8gVXBkYXRlIF9maWxlVG9Qcm92aWRlcnMuXG4gICAgICB2YXIgcHJvdmlkZXJzID0gdGhpcy5fZmlsZVRvUHJvdmlkZXJzLmdldChmaWxlUGF0aCk7XG4gICAgICBpZiAoIXByb3ZpZGVycykge1xuICAgICAgICBwcm92aWRlcnMgPSBuZXcgU2V0KCk7XG4gICAgICAgIHRoaXMuX2ZpbGVUb1Byb3ZpZGVycy5zZXQoZmlsZVBhdGgsIHByb3ZpZGVycyk7XG4gICAgICB9XG4gICAgICBwcm92aWRlcnMuYWRkKGRpYWdub3N0aWNQcm92aWRlcik7XG5cbiAgICAgIHRoaXMuX2VtaXRGaWxlTWVzc2FnZXMoZmlsZVBhdGgpO1xuICAgIH0pO1xuICB9XG5cbiAgX3VwZGF0ZVByb2plY3RNZXNzYWdlcyhcbiAgICBkaWFnbm9zdGljUHJvdmlkZXI6IERpYWdub3N0aWNQcm92aWRlcixcbiAgICBwcm9qZWN0TWVzc2FnZXM6IEFycmF5PFByb2plY3REaWFnbm9zdGljTWVzc2FnZT5cbiAgKTogdm9pZCB7XG4gICAgdGhpcy5fcHJvdmlkZXJUb1Byb2plY3REaWFnbm9zdGljcy5zZXQoZGlhZ25vc3RpY1Byb3ZpZGVyLCBwcm9qZWN0TWVzc2FnZXMpO1xuICAgIHRoaXMuX2VtaXRQcm9qZWN0TWVzc2FnZXMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciB0aGUgbWVzc2FnZXMgZnJvbSB0aGUgZ2l2ZW4gcHJvdmlkZXIsIGFjY29yZGluZyB0byB0aGUgb3B0aW9ucy5cbiAgICogQHBhcmFtIG9wdGlvbnMgQW4gT2JqZWN0IG9mIHRoZSBmb3JtOlxuICAgKiAgICogc2NvcGU6IENhbiBiZSAnZmlsZScsICdwcm9qZWN0Jywgb3IgJ2FsbCcuXG4gICAqICAgICAgICogJ2ZpbGUnOiBUaGUgJ2ZpbGVQYXRocycgb3B0aW9uIGRldGVybWluZXMgd2hpY2ggZmlsZXMnIG1lc3NhZ2VzIHRvIGNsZWFyXG4gICAqICAgICAgICogJ3Byb2plY3QnOiBhbGwgJ3Byb2plY3QnIHNjb3BlIG1lc3NhZ2VzIGFyZSBjbGVhcmVkLlxuICAgKiAgICAgICAqICdhbGwnOiBhbGwgbWVzc2FnZXMgYXJlIGNsZWFyZWQuXG4gICAqICAgKiBmaWxlUGF0aHM6IEFycmF5IG9mIGFic29sdXRlIGZpbGUgcGF0aHMgKE51Y2xpZGVVcmkpIHRvIGNsZWFyIG1lc3NhZ2VzIGZvci5cbiAgICovXG4gIGludmFsaWRhdGVNZXNzYWdlcyhcbiAgICAgIGRpYWdub3N0aWNQcm92aWRlcjogRGlhZ25vc3RpY1Byb3ZpZGVyLFxuICAgICAgaW52YWxpZGF0aW9uTWVzc2FnZTogSW52YWxpZGF0aW9uTWVzc2FnZVxuICAgICk6IHZvaWQge1xuICAgIGlmIChpbnZhbGlkYXRpb25NZXNzYWdlLnNjb3BlID09PSAnZmlsZScpIHtcbiAgICAgIHRoaXMuX2ludmFsaWRhdGVGaWxlTWVzc2FnZXNGb3JQcm92aWRlcihkaWFnbm9zdGljUHJvdmlkZXIsIGludmFsaWRhdGlvbk1lc3NhZ2UuZmlsZVBhdGhzKTtcbiAgICAgIHRoaXMuX2VtaXRBbGxNZXNzYWdlcygpO1xuICAgIH0gZWxzZSBpZiAoaW52YWxpZGF0aW9uTWVzc2FnZS5zY29wZSA9PT0gJ3Byb2plY3QnKSB7XG4gICAgICB0aGlzLl9pbnZhbGlkYXRlUHJvamVjdE1lc3NhZ2VzRm9yUHJvdmlkZXIoZGlhZ25vc3RpY1Byb3ZpZGVyKTtcbiAgICAgIHRoaXMuX2VtaXRBbGxNZXNzYWdlcygpO1xuICAgIH0gZWxzZSBpZiAoaW52YWxpZGF0aW9uTWVzc2FnZS5zY29wZSA9PT0gJ2FsbCcpIHtcbiAgICAgIHRoaXMuX2ludmFsaWRhdGVBbGxNZXNzYWdlc0ZvclByb3ZpZGVyKGRpYWdub3N0aWNQcm92aWRlcik7XG4gICAgfVxuICB9XG5cbiAgX2ludmFsaWRhdGVGaWxlTWVzc2FnZXNGb3JQcm92aWRlcihcbiAgICBkaWFnbm9zdGljUHJvdmlkZXI6IERpYWdub3N0aWNQcm92aWRlcixcbiAgICBwYXRoc1RvUmVtb3ZlOiBJdGVyYWJsZTxOdWNsaWRlVXJpPlxuICApOiB2b2lkIHtcbiAgICB2YXIgZmlsZVRvRGlhZ25vc3RpY3MgPSB0aGlzLl9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXMuZ2V0KGRpYWdub3N0aWNQcm92aWRlcik7XG4gICAgZm9yICh2YXIgZmlsZVBhdGggb2YgcGF0aHNUb1JlbW92ZSkge1xuICAgICAgLy8gVXBkYXRlIF9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXMuXG4gICAgICBpZiAoZmlsZVRvRGlhZ25vc3RpY3MpIHtcbiAgICAgICAgZmlsZVRvRGlhZ25vc3RpY3MuZGVsZXRlKGZpbGVQYXRoKTtcbiAgICAgIH1cbiAgICAgIC8vIFVwZGF0ZSBfZmlsZVRvUHJvdmlkZXJzLlxuICAgICAgdmFyIHByb3ZpZGVycyA9IHRoaXMuX2ZpbGVUb1Byb3ZpZGVycy5nZXQoZmlsZVBhdGgpO1xuICAgICAgaWYgKHByb3ZpZGVycykge1xuICAgICAgICBwcm92aWRlcnMuZGVsZXRlKGRpYWdub3N0aWNQcm92aWRlcik7XG4gICAgICB9XG4gICAgICB0aGlzLl9lbWl0RmlsZU1lc3NhZ2VzKGZpbGVQYXRoKTtcbiAgICB9XG4gIH1cblxuICBfaW52YWxpZGF0ZVByb2plY3RNZXNzYWdlc0ZvclByb3ZpZGVyKGRpYWdub3N0aWNQcm92aWRlcjogRGlhZ25vc3RpY1Byb3ZpZGVyKTogdm9pZCB7XG4gICAgdGhpcy5fcHJvdmlkZXJUb1Byb2plY3REaWFnbm9zdGljcy5kZWxldGUoZGlhZ25vc3RpY1Byb3ZpZGVyKTtcbiAgICB0aGlzLl9lbWl0UHJvamVjdE1lc3NhZ2VzKCk7XG4gIH1cblxuICBfaW52YWxpZGF0ZUFsbE1lc3NhZ2VzRm9yUHJvdmlkZXIoZGlhZ25vc3RpY1Byb3ZpZGVyOiBEaWFnbm9zdGljUHJvdmlkZXIpOiB2b2lkIHtcbiAgICAvLyBJbnZhbGlkYXRlIGFsbCBmaWxlIG1lc3NhZ2VzLlxuICAgIHZhciBmaWxlc1RvRGlhZ25vc3RpY3MgPSB0aGlzLl9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXMuZ2V0KGRpYWdub3N0aWNQcm92aWRlcik7XG4gICAgaWYgKGZpbGVzVG9EaWFnbm9zdGljcykge1xuICAgICAgdmFyIGFsbEZpbGVQYXRocyA9IGZpbGVzVG9EaWFnbm9zdGljcy5rZXlzKCk7XG4gICAgICB0aGlzLl9pbnZhbGlkYXRlRmlsZU1lc3NhZ2VzRm9yUHJvdmlkZXIoZGlhZ25vc3RpY1Byb3ZpZGVyLCBhbGxGaWxlUGF0aHMpO1xuICAgIH1cbiAgICAvLyBJbnZhbGlkYXRlIGFsbCBwcm9qZWN0IG1lc3NhZ2VzLlxuICAgIHRoaXMuX2ludmFsaWRhdGVQcm9qZWN0TWVzc2FnZXNGb3JQcm92aWRlcihkaWFnbm9zdGljUHJvdmlkZXIpO1xuXG4gICAgdGhpcy5fZW1pdEFsbE1lc3NhZ2VzKCk7XG4gIH1cblxuICAvKipcbiAgICogU2VjdGlvbjogTWV0aG9kcyB0byByZWFkIGZyb20gdGhlIHN0b3JlLlxuICAgKi9cblxuICAvKipcbiAgICogQ2FsbCB0aGUgY2FsbGJhY2sgd2hlbiB0aGUgZmlsZVBhdGgncyBtZXNzYWdlcyBoYXZlIGNoYW5nZWQuXG4gICAqIEluIGFkZGl0aW9uLCB0aGUgU3RvcmUgd2lsbCBpbW1lZGlhdGVseSBpbnZva2UgdGhlIGNhbGxiYWNrIHdpdGggdGhlIGRhdGFcbiAgICogY3VycmVudGx5IGluIHRoZSBTdG9yZSwgaWZmIHRoZXJlIGlzIGFueS5cbiAgICogQHBhcmFtIGNhbGxiYWNrIFRoZSBmdW5jdGlvbiB0byBtZXNzYWdlIHdoZW4gYW55IG9mIHRoZSBmaWxlUGF0aHMnIG1lc3NhZ2VzXG4gICAqICAgY2hhbmdlLiBUaGUgYXJyYXkgb2YgbWVzc2FnZXMgaXMgbWVhbnQgdG8gY29tcGxldGVseSByZXBsYWNlIGFueSBwcmV2aW91c1xuICAgKiAgIG1lc3NhZ2VzIGZvciB0aGlzIGZpbGUgcGF0aC5cbiAgICovXG4gIG9uRmlsZU1lc3NhZ2VzRGlkVXBkYXRlKFxuICAgICAgY2FsbGJhY2s6ICh1cGRhdGU6IEZpbGVNZXNzYWdlVXBkYXRlKSA9PiBtaXhlZCxcbiAgICAgIGZpbGVQYXRoOiBOdWNsaWRlVXJpXG4gICAgKTogYXRvbSREaXNwb3NhYmxlIHtcbiAgICAvLyBVc2UgdGhlIGZpbGVQYXRoIGFzIHRoZSBldmVudCBuYW1lLlxuICAgIHZhciBlbWl0dGVyRGlzcG9zYWJsZSA9IHRoaXMuX2ZpbGVDaGFuZ2VFbWl0dGVyLm9uKGZpbGVQYXRoLCBjYWxsYmFjayk7XG4gICAgdGhpcy5faW5jcmVtZW50RmlsZUxpc3RlbmVyQ291bnQoZmlsZVBhdGgpO1xuXG4gICAgdmFyIGZpbGVNZXNzYWdlcyA9IHRoaXMuX2dldEZpbGVNZXNzYWdlcyhmaWxlUGF0aCk7XG4gICAgaWYgKGZpbGVNZXNzYWdlcy5sZW5ndGgpIHtcbiAgICAgIGNhbGxiYWNrKHtmaWxlUGF0aCwgbWVzc2FnZXM6IGZpbGVNZXNzYWdlc30pO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgZW1pdHRlckRpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICAgICAgdGhpcy5fZGVjcmVtZW50RmlsZUxpc3RlbmVyQ291bnQoZmlsZVBhdGgpO1xuICAgIH0pO1xuICB9XG5cbiAgX2luY3JlbWVudEZpbGVMaXN0ZW5lckNvdW50KGZpbGVQYXRoOiBOdWNsaWRlVXJpKTogdm9pZCB7XG4gICAgdmFyIGN1cnJlbnRDb3VudCA9IHRoaXMuX2ZpbGVUb0xpc3RlbmVyc0NvdW50LmdldChmaWxlUGF0aCkgfHwgMDtcbiAgICB0aGlzLl9maWxlVG9MaXN0ZW5lcnNDb3VudC5zZXQoZmlsZVBhdGgsIGN1cnJlbnRDb3VudCArIDEpO1xuICB9XG5cbiAgX2RlY3JlbWVudEZpbGVMaXN0ZW5lckNvdW50KGZpbGVQYXRoOiBOdWNsaWRlVXJpKTogdm9pZCB7XG4gICAgdmFyIGN1cnJlbnRDb3VudCA9IHRoaXMuX2ZpbGVUb0xpc3RlbmVyc0NvdW50LmdldChmaWxlUGF0aCkgfHwgMDtcbiAgICBpZiAoY3VycmVudENvdW50ID4gMCkge1xuICAgICAgdGhpcy5fZmlsZVRvTGlzdGVuZXJzQ291bnQuc2V0KGZpbGVQYXRoLCBjdXJyZW50Q291bnQgLSAxKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2FsbCB0aGUgY2FsbGJhY2sgd2hlbiBwcm9qZWN0LXNjb3BlIG1lc3NhZ2VzIGNoYW5nZS5cbiAgICogSW4gYWRkaXRpb24sIHRoZSBTdG9yZSB3aWxsIGltbWVkaWF0ZWx5IGludm9rZSB0aGUgY2FsbGJhY2sgd2l0aCB0aGUgZGF0YVxuICAgKiBjdXJyZW50bHkgaW4gdGhlIFN0b3JlLCBpZmYgdGhlcmUgaXMgYW55LlxuICAgKiBAcGFyYW0gY2FsbGJhY2sgVGhlIGZ1bmN0aW9uIHRvIG1lc3NhZ2Ugd2hlbiB0aGUgcHJvamVjdC1zY29wZSBtZXNzYWdlc1xuICAgKiAgIGNoYW5nZS4gVGhlIGFycmF5IG9mIG1lc3NhZ2VzIGlzIG1lYW50IHRvIGNvbXBsZXRlbHkgcmVwbGFjZSBhbnkgcHJldmlvdXNcbiAgICogICBwcm9qZWN0LXNjb3BlIG1lc3NhZ2VzLlxuICAgKi9cbiAgb25Qcm9qZWN0TWVzc2FnZXNEaWRVcGRhdGUoY2FsbGJhY2s6IChtZXNzYWdlczogQXJyYXk8UHJvamVjdERpYWdub3N0aWNNZXNzYWdlPikgPT4gbWl4ZWQpOiBhdG9tJERpc3Bvc2FibGUge1xuICAgIHZhciBlbWl0dGVyRGlzcG9zYWJsZSA9IHRoaXMuX25vbkZpbGVDaGFuZ2VFbWl0dGVyLm9uKFBST0pFQ1RfTUVTU0FHRV9DSEFOR0VfRVZFTlQsIGNhbGxiYWNrKTtcbiAgICB0aGlzLl9wcm9qZWN0TGlzdGVuZXJzQ291bnQgKz0gMTtcblxuICAgIHZhciBwcm9qZWN0TWVzc2FnZXMgPSB0aGlzLl9nZXRQcm9qZWN0TWVzc2FnZXMoKTtcbiAgICBpZiAocHJvamVjdE1lc3NhZ2VzLmxlbmd0aCkge1xuICAgICAgY2FsbGJhY2socHJvamVjdE1lc3NhZ2VzKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIGVtaXR0ZXJEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuX3Byb2plY3RMaXN0ZW5lcnNDb3VudCAtPSAxO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGwgdGhlIGNhbGxiYWNrIHdoZW4gYW55IG1lc3NhZ2VzIGNoYW5nZS5cbiAgICogSW4gYWRkaXRpb24sIHRoZSBTdG9yZSB3aWxsIGltbWVkaWF0ZWx5IGludm9rZSB0aGUgY2FsbGJhY2sgd2l0aCBkYXRhXG4gICAqIGN1cnJlbnRseSBpbiB0aGUgU3RvcmUsIGlmZiB0aGVyZSBpcyBhbnkuXG4gICAqIEBwYXJhbSBjYWxsYmFjayBUaGUgZnVuY3Rpb24gdG8gbWVzc2FnZSB3aGVuIGFueSBtZXNzYWdlcyBjaGFuZ2UuIFRoZSBhcnJheVxuICAgKiAgIG9mIG1lc3NhZ2VzIGlzIG1lYW50IHRvIGNvbXBsZXRlbHkgcmVwbGFjZSBhbnkgcHJldmlvdXMgbWVzc2FnZXMuXG4gICAqL1xuICBvbkFsbE1lc3NhZ2VzRGlkVXBkYXRlKGNhbGxiYWNrOiAobWVzc2FnZXM6IEFycmF5PERpYWdub3N0aWNNZXNzYWdlPikgPT4gbWl4ZWQpOiBhdG9tJERpc3Bvc2FibGUge1xuICAgIHZhciBlbWl0dGVyRGlzcG9zYWJsZSA9IHRoaXMuX25vbkZpbGVDaGFuZ2VFbWl0dGVyLm9uKEFMTF9DSEFOR0VfRVZFTlQsIGNhbGxiYWNrKTtcbiAgICB0aGlzLl9hbGxNZXNzYWdlc0xpc3RlbmVyc0NvdW50ICs9IDE7XG5cbiAgICB2YXIgYWxsTWVzc2FnZXMgPSB0aGlzLl9nZXRBbGxNZXNzYWdlcygpO1xuICAgIGlmIChhbGxNZXNzYWdlcy5sZW5ndGgpIHtcbiAgICAgIGNhbGxiYWNrKGFsbE1lc3NhZ2VzKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIGVtaXR0ZXJEaXNwb3NhYmxlLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuX2FsbE1lc3NhZ2VzTGlzdGVuZXJzQ291bnQgLT0gMTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBjdXJyZW50IGRpYWdub3N0aWMgbWVzc2FnZXMgZm9yIHRoZSBmaWxlLlxuICAgKiBQcmVmZXIgdG8gZ2V0IHVwZGF0ZXMgdmlhIDo6b25GaWxlTWVzc2FnZXNEaWRVcGRhdGUuXG4gICAqL1xuICBfZ2V0RmlsZU1lc3NhZ2VzKGZpbGVQYXRoOiBOdWNsaWRlVXJpKTogQXJyYXk8RmlsZURpYWdub3N0aWNNZXNzYWdlPiB7XG4gICAgdmFyIGFsbEZpbGVNZXNzYWdlcyA9IFtdO1xuICAgIHZhciByZWxldmFudFByb3ZpZGVycyA9IHRoaXMuX2ZpbGVUb1Byb3ZpZGVycy5nZXQoZmlsZVBhdGgpO1xuICAgIGlmIChyZWxldmFudFByb3ZpZGVycykge1xuICAgICAgZm9yICh2YXIgcHJvdmlkZXIgb2YgcmVsZXZhbnRQcm92aWRlcnMpIHtcbiAgICAgICAgdmFyIG1lc3NhZ2VzID0gKHRoaXMuX3Byb3ZpZGVyVG9GaWxlVG9NZXNzYWdlcy5nZXQocHJvdmlkZXIpKS5nZXQoZmlsZVBhdGgpO1xuICAgICAgICBhbGxGaWxlTWVzc2FnZXMgPSBhbGxGaWxlTWVzc2FnZXMuY29uY2F0KG1lc3NhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGFsbEZpbGVNZXNzYWdlcztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIHRoZSBjdXJyZW50IHByb2plY3Qtc2NvcGUgZGlhZ25vc3RpYyBtZXNzYWdlcy5cbiAgICogUHJlZmVyIHRvIGdldCB1cGRhdGVzIHZpYSA6Om9uUHJvamVjdE1lc3NhZ2VzRGlkVXBkYXRlLlxuICAgKi9cbiAgX2dldFByb2plY3RNZXNzYWdlcygpOiBBcnJheTxQcm9qZWN0RGlhZ25vc3RpY01lc3NhZ2U+IHtcbiAgICB2YXIgYWxsUHJvamVjdE1lc3NhZ2VzID0gW107XG4gICAgZm9yICh2YXIgbWVzc2FnZXMgb2YgdGhpcy5fcHJvdmlkZXJUb1Byb2plY3REaWFnbm9zdGljcy52YWx1ZXMoKSkge1xuICAgICAgYWxsUHJvamVjdE1lc3NhZ2VzID0gYWxsUHJvamVjdE1lc3NhZ2VzLmNvbmNhdChtZXNzYWdlcyk7XG4gICAgfVxuICAgIHJldHVybiBhbGxQcm9qZWN0TWVzc2FnZXM7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhbGwgY3VycmVudCBkaWFnbm9zdGljIG1lc3NhZ2VzLlxuICAgKiBQcmVmZXIgdG8gZ2V0IHVwZGF0ZXMgdmlhIDo6b25BbGxNZXNzYWdlc0RpZFVwZGF0ZS5cbiAgICovXG4gIF9nZXRBbGxNZXNzYWdlcygpOiBBcnJheTxEaWFnbm9zdGljTWVzc2FnZT4ge1xuICAgIHZhciBhbGxNZXNzYWdlcyA9IFtdO1xuICAgIC8vIEdldCBhbGwgZmlsZSBtZXNzYWdlcy5cbiAgICBmb3IgKHZhciBmaWxlVG9NZXNzYWdlcyBvZiB0aGlzLl9wcm92aWRlclRvRmlsZVRvTWVzc2FnZXMudmFsdWVzKCkpIHtcbiAgICAgIGZvciAodmFyIG1lc3NhZ2VzIG9mIGZpbGVUb01lc3NhZ2VzLnZhbHVlcygpKSB7XG4gICAgICAgIGFsbE1lc3NhZ2VzID0gYWxsTWVzc2FnZXMuY29uY2F0KG1lc3NhZ2VzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gR2V0IGFsbCBwcm9qZWN0IG1lc3NhZ2VzLlxuICAgIGFsbE1lc3NhZ2VzID0gYWxsTWVzc2FnZXMuY29uY2F0KHRoaXMuX2dldFByb2plY3RNZXNzYWdlcygpKTtcbiAgICByZXR1cm4gYWxsTWVzc2FnZXM7XG4gIH1cblxuXG4gIC8qKlxuICAgKiBTZWN0aW9uOiBFdmVudCBFbWl0dGluZ1xuICAgKi9cblxuICBfZW1pdEZpbGVNZXNzYWdlcyhmaWxlUGF0aDogTnVjbGlkZVVyaSk6IHZvaWQge1xuICAgIGlmICh0aGlzLl9maWxlVG9MaXN0ZW5lcnNDb3VudC5nZXQoZmlsZVBhdGgpKSB7XG4gICAgICB0aGlzLl9maWxlQ2hhbmdlRW1pdHRlci5lbWl0KGZpbGVQYXRoLCB7ZmlsZVBhdGgsIG1lc3NhZ2VzOiB0aGlzLl9nZXRGaWxlTWVzc2FnZXMoZmlsZVBhdGgpfSk7XG4gICAgfVxuICB9XG5cbiAgX2VtaXRQcm9qZWN0TWVzc2FnZXMoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuX3Byb2plY3RMaXN0ZW5lcnNDb3VudCkge1xuICAgICAgdGhpcy5fbm9uRmlsZUNoYW5nZUVtaXR0ZXIuZW1pdChQUk9KRUNUX01FU1NBR0VfQ0hBTkdFX0VWRU5ULCB0aGlzLl9nZXRQcm9qZWN0TWVzc2FnZXMoKSk7XG4gICAgfVxuICB9XG5cbiAgX2VtaXRBbGxNZXNzYWdlcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fYWxsTWVzc2FnZXNMaXN0ZW5lcnNDb3VudCkge1xuICAgICAgdGhpcy5fbm9uRmlsZUNoYW5nZUVtaXR0ZXIuZW1pdChBTExfQ0hBTkdFX0VWRU5ULCB0aGlzLl9nZXRBbGxNZXNzYWdlcygpKTtcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBEaWFnbm9zdGljU3RvcmU7XG4iXX0=
