

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

'use babel';

var _require = require('atom');

var Disposable = _require.Disposable;
var CompositeDisposable = _require.CompositeDisposable;

var legacyLinterSetting = 'nuclide-diagnostics-store.consumeLegacyLinters';

var legacyLintOnTheFlySetting = 'nuclide-diagnostics-store.legacyLintOnTheFly';

var disposables = null;
var diagnosticStore = null;
var diagnosticUpdater = null;

function addDisposable(disposable) {
  if (disposables) {
    disposables.add(disposable);
  } else {
    var logger = require('nuclide-logging').getLogger();
    logger.error('disposables is null');
  }
}

function getDiagnosticStore() {
  if (!diagnosticStore) {
    var _require2 = require('nuclide-diagnostics-base');

    var DiagnosticStore = _require2.DiagnosticStore;

    diagnosticStore = new DiagnosticStore();
  }
  return diagnosticStore;
}

/**
 * @return A wrapper around the methods on DiagnosticStore that allow reading data.
 */
function getDiagnosticUpdater() {
  if (!diagnosticUpdater) {
    var store = getDiagnosticStore();
    diagnosticUpdater = {
      onFileMessagesDidUpdate: store.onFileMessagesDidUpdate.bind(store),
      onProjectMessagesDidUpdate: store.onProjectMessagesDidUpdate.bind(store),
      onAllMessagesDidUpdate: store.onAllMessagesDidUpdate.bind(store)
    };
  }
  return diagnosticUpdater;
}

var consumeLegacyLinters = false;
var lintOnTheFly = false;
var adapters = new Set();

module.exports = {
  config: {
    consumeLegacyLinters: {
      type: 'boolean',
      'default': false
    },
    legacyLintOnTheFly: {
      type: 'boolean',
      'default': false,
      description: 'Used only for legacy linters'
    }
  },

  activate: function activate(state) {
    if (!disposables) {
      disposables = new CompositeDisposable();
    }

    consumeLegacyLinters = atom.config.get(legacyLinterSetting); // returns mixed so a cast is necessary
    atom.config.observe(legacyLinterSetting, function (newValue) {
      // To make this really solid, we should also probably trigger the linter
      // for the active text editor. Possibly more trouble than it's worth,
      // though, since this may be a temporary option.
      consumeLegacyLinters = newValue;
      adapters.forEach(function (adapter) {
        return adapter.setEnabled(newValue);
      });
    });

    lintOnTheFly = atom.config.get(legacyLintOnTheFlySetting);
    atom.config.observe(legacyLintOnTheFlySetting, function (newValue) {
      lintOnTheFly = newValue;
      adapters.forEach(function (adapter) {
        return adapter.setLintOnFly(newValue);
      });
    });
  },

  consumeLinterProvider: function consumeLinterProvider(provider) {
    var LinterAdapter = require('./LinterAdapter');
    var adapter = new LinterAdapter(provider);
    adapter.setEnabled(consumeLegacyLinters);
    adapter.setLintOnFly(lintOnTheFly);
    adapters.add(adapter);
    var diagnosticDisposable = this.consumeDiagnosticProvider(adapter);
    var adapterDisposable = new Disposable(function () {
      diagnosticDisposable.dispose();
      adapter.dispose();
      adapters['delete'](adapter);
    });
    addDisposable(adapter);
    return adapterDisposable;
  },

  consumeDiagnosticProvider: function consumeDiagnosticProvider(provider) {
    var store = getDiagnosticStore();
    // Register the diagnostic store for updates from the new provider.
    var compositeDisposable = new CompositeDisposable();
    compositeDisposable.add(provider.onMessageUpdate(function (update) {
      store.updateMessages(provider, update);
    }));
    compositeDisposable.add(provider.onMessageInvalidation(function (invalidationMessage) {
      store.invalidateMessages(provider, invalidationMessage);
    }));
    addDisposable(compositeDisposable);
    return compositeDisposable;
  },

  provideDiagnosticUpdates: function provideDiagnosticUpdates() {
    return getDiagnosticUpdater();
  },

  deactivate: function deactivate() {
    if (disposables) {
      disposables.dispose();
      disposables = null;
    }
    if (diagnosticStore) {
      diagnosticStore.dispose();
      diagnosticStore = null;
    }
    diagnosticUpdater = null;
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL2FwbS9udWNsaWRlLWRpYWdub3N0aWNzLXN0b3JlL2xpYi9tYWluLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxXQUFXLENBQUM7O2VBYzRCLE9BQU8sQ0FBQyxNQUFNLENBQUM7O0lBQWxELFVBQVUsWUFBVixVQUFVO0lBQUUsbUJBQW1CLFlBQW5CLG1CQUFtQjs7QUFFcEMsSUFBTSxtQkFBbUIsR0FBRyxnREFBZ0QsQ0FBQzs7QUFFN0UsSUFBTSx5QkFBeUIsR0FBRyw4Q0FBOEMsQ0FBQzs7QUFFakYsSUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDO0FBQ3ZCLElBQUksZUFBZSxHQUFHLElBQUksQ0FBQztBQUMzQixJQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQzs7QUFFN0IsU0FBUyxhQUFhLENBQUMsVUFBNEIsRUFBRTtBQUNuRCxNQUFJLFdBQVcsRUFBRTtBQUNmLGVBQVcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7R0FDN0IsTUFBTTtBQUNMLFFBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ3BELFVBQU0sQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsQ0FBQztHQUNyQztDQUNGOztBQUVELFNBQVMsa0JBQWtCLEdBQW9CO0FBQzdDLE1BQUksQ0FBQyxlQUFlLEVBQUU7b0JBQ0ksT0FBTyxDQUFDLDBCQUEwQixDQUFDOztRQUF0RCxlQUFlLGFBQWYsZUFBZTs7QUFDcEIsbUJBQWUsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO0dBQ3pDO0FBQ0QsU0FBTyxlQUFlLENBQUM7Q0FDeEI7Ozs7O0FBS0QsU0FBUyxvQkFBb0IsR0FBc0I7QUFDakQsTUFBSSxDQUFDLGlCQUFpQixFQUFFO0FBQ3RCLFFBQUksS0FBSyxHQUFHLGtCQUFrQixFQUFFLENBQUM7QUFDakMscUJBQWlCLEdBQUc7QUFDbEIsNkJBQXVCLEVBQUUsS0FBSyxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDbEUsZ0NBQTBCLEVBQUUsS0FBSyxDQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7QUFDeEUsNEJBQXNCLEVBQUUsS0FBSyxDQUFDLHNCQUFzQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7S0FDakUsQ0FBQztHQUNIO0FBQ0QsU0FBTyxpQkFBaUIsQ0FBQztDQUMxQjs7QUFFRCxJQUFJLG9CQUFvQixHQUFHLEtBQUssQ0FBQztBQUNqQyxJQUFJLFlBQVksR0FBRyxLQUFLLENBQUM7QUFDekIsSUFBSSxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQzs7QUFFekIsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLFFBQU0sRUFBRTtBQUNOLHdCQUFvQixFQUFFO0FBQ3BCLFVBQUksRUFBRSxTQUFTO0FBQ2YsaUJBQVMsS0FBSztLQUNmO0FBQ0Qsc0JBQWtCLEVBQUU7QUFDbEIsVUFBSSxFQUFFLFNBQVM7QUFDZixpQkFBUyxLQUFLO0FBQ2QsaUJBQVcsRUFBRSw4QkFBOEI7S0FDNUM7R0FDRjs7QUFFRCxVQUFRLEVBQUEsa0JBQUMsS0FBYyxFQUFRO0FBQzdCLFFBQUksQ0FBQyxXQUFXLEVBQUU7QUFDaEIsaUJBQVcsR0FBRyxJQUFJLG1CQUFtQixFQUFFLENBQUM7S0FDekM7O0FBRUQsd0JBQW9CLEdBQUssSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUMsQUFBZ0IsQ0FBQztBQUM5RSxRQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxVQUFBLFFBQVEsRUFBSTs7OztBQUluRCwwQkFBb0IsR0FBRyxRQUFRLENBQUM7QUFDaEMsY0FBUSxDQUFDLE9BQU8sQ0FBQyxVQUFBLE9BQU87ZUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQztPQUFBLENBQUMsQ0FBQztLQUMzRCxDQUFDLENBQUM7O0FBRUgsZ0JBQVksR0FBSyxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyx5QkFBeUIsQ0FBQyxBQUFnQixDQUFDO0FBQzVFLFFBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLHlCQUF5QixFQUFFLFVBQUEsUUFBUSxFQUFJO0FBQ3pELGtCQUFZLEdBQUcsUUFBUSxDQUFDO0FBQ3hCLGNBQVEsQ0FBQyxPQUFPLENBQUMsVUFBQSxPQUFPO2VBQUksT0FBTyxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7T0FBQSxDQUFDLENBQUM7S0FDN0QsQ0FBQyxDQUFDO0dBQ0o7O0FBRUQsdUJBQXFCLEVBQUEsK0JBQUMsUUFBd0IsRUFBb0I7QUFDaEUsUUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDL0MsUUFBSSxPQUFPLEdBQUcsSUFBSSxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUMsV0FBTyxDQUFDLFVBQVUsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO0FBQ3pDLFdBQU8sQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDbkMsWUFBUSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN0QixRQUFJLG9CQUFvQixHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNuRSxRQUFJLGlCQUFpQixHQUFHLElBQUksVUFBVSxDQUFDLFlBQU07QUFDM0MsMEJBQW9CLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDL0IsYUFBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ2xCLGNBQVEsVUFBTyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQzFCLENBQUMsQ0FBQztBQUNILGlCQUFhLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDdkIsV0FBTyxpQkFBaUIsQ0FBQztHQUMxQjs7QUFFRCwyQkFBeUIsRUFBQSxtQ0FBQyxRQUE0QixFQUFvQjtBQUN4RSxRQUFJLEtBQUssR0FBRyxrQkFBa0IsRUFBRSxDQUFDOztBQUVqQyxRQUFJLG1CQUFtQixHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQztBQUNwRCx1QkFBbUIsQ0FBQyxHQUFHLENBQ3JCLFFBQVEsQ0FBQyxlQUFlLENBQUMsVUFBQyxNQUFNLEVBQStCO0FBQzdELFdBQUssQ0FBQyxjQUFjLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0tBQ3hDLENBQUMsQ0FDSCxDQUFDO0FBQ0YsdUJBQW1CLENBQUMsR0FBRyxDQUNyQixRQUFRLENBQUMscUJBQXFCLENBQUMsVUFBQyxtQkFBbUIsRUFBMEI7QUFDM0UsV0FBSyxDQUFDLGtCQUFrQixDQUFDLFFBQVEsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0tBQ3pELENBQUMsQ0FDSCxDQUFDO0FBQ0YsaUJBQWEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ25DLFdBQU8sbUJBQW1CLENBQUM7R0FDNUI7O0FBRUQsMEJBQXdCLEVBQUEsb0NBQXNCO0FBQzVDLFdBQU8sb0JBQW9CLEVBQUUsQ0FBQztHQUMvQjs7QUFFRCxZQUFVLEVBQUEsc0JBQUc7QUFDWCxRQUFJLFdBQVcsRUFBRTtBQUNmLGlCQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDdEIsaUJBQVcsR0FBRyxJQUFJLENBQUM7S0FDcEI7QUFDRCxRQUFJLGVBQWUsRUFBRTtBQUNuQixxQkFBZSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzFCLHFCQUFlLEdBQUcsSUFBSSxDQUFDO0tBQ3hCO0FBQ0QscUJBQWlCLEdBQUcsSUFBSSxDQUFDO0dBQzFCO0NBQ0YsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9hcG0vbnVjbGlkZS1kaWFnbm9zdGljcy1zdG9yZS9saWIvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmltcG9ydCB0eXBlIHtEaWFnbm9zdGljU3RvcmV9IGZyb20gJ251Y2xpZGUtZGlhZ25vc3RpY3MtYmFzZSc7XG5pbXBvcnQgdHlwZSB7TGludGVyUHJvdmlkZXJ9IGZyb20gJy4vTGludGVyQWRhcHRlcic7XG5cbnZhciB7RGlzcG9zYWJsZSwgQ29tcG9zaXRlRGlzcG9zYWJsZX0gPSByZXF1aXJlKCdhdG9tJyk7XG5cbmNvbnN0IGxlZ2FjeUxpbnRlclNldHRpbmcgPSAnbnVjbGlkZS1kaWFnbm9zdGljcy1zdG9yZS5jb25zdW1lTGVnYWN5TGludGVycyc7XG5cbmNvbnN0IGxlZ2FjeUxpbnRPblRoZUZseVNldHRpbmcgPSAnbnVjbGlkZS1kaWFnbm9zdGljcy1zdG9yZS5sZWdhY3lMaW50T25UaGVGbHknO1xuXG52YXIgZGlzcG9zYWJsZXMgPSBudWxsO1xudmFyIGRpYWdub3N0aWNTdG9yZSA9IG51bGw7XG52YXIgZGlhZ25vc3RpY1VwZGF0ZXIgPSBudWxsO1xuXG5mdW5jdGlvbiBhZGREaXNwb3NhYmxlKGRpc3Bvc2FibGU6IGF0b20kSURpc3Bvc2FibGUpIHtcbiAgaWYgKGRpc3Bvc2FibGVzKSB7XG4gICAgZGlzcG9zYWJsZXMuYWRkKGRpc3Bvc2FibGUpO1xuICB9IGVsc2Uge1xuICAgIHZhciBsb2dnZXIgPSByZXF1aXJlKCdudWNsaWRlLWxvZ2dpbmcnKS5nZXRMb2dnZXIoKTtcbiAgICBsb2dnZXIuZXJyb3IoJ2Rpc3Bvc2FibGVzIGlzIG51bGwnKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXREaWFnbm9zdGljU3RvcmUoKTogRGlhZ25vc3RpY1N0b3JlIHtcbiAgaWYgKCFkaWFnbm9zdGljU3RvcmUpIHtcbiAgICB2YXIge0RpYWdub3N0aWNTdG9yZX0gPSByZXF1aXJlKCdudWNsaWRlLWRpYWdub3N0aWNzLWJhc2UnKTtcbiAgICBkaWFnbm9zdGljU3RvcmUgPSBuZXcgRGlhZ25vc3RpY1N0b3JlKCk7XG4gIH1cbiAgcmV0dXJuIGRpYWdub3N0aWNTdG9yZTtcbn1cblxuLyoqXG4gKiBAcmV0dXJuIEEgd3JhcHBlciBhcm91bmQgdGhlIG1ldGhvZHMgb24gRGlhZ25vc3RpY1N0b3JlIHRoYXQgYWxsb3cgcmVhZGluZyBkYXRhLlxuICovXG5mdW5jdGlvbiBnZXREaWFnbm9zdGljVXBkYXRlcigpOiBEaWFnbm9zdGljVXBkYXRlciB7XG4gIGlmICghZGlhZ25vc3RpY1VwZGF0ZXIpIHtcbiAgICB2YXIgc3RvcmUgPSBnZXREaWFnbm9zdGljU3RvcmUoKTtcbiAgICBkaWFnbm9zdGljVXBkYXRlciA9IHtcbiAgICAgIG9uRmlsZU1lc3NhZ2VzRGlkVXBkYXRlOiBzdG9yZS5vbkZpbGVNZXNzYWdlc0RpZFVwZGF0ZS5iaW5kKHN0b3JlKSxcbiAgICAgIG9uUHJvamVjdE1lc3NhZ2VzRGlkVXBkYXRlOiBzdG9yZS5vblByb2plY3RNZXNzYWdlc0RpZFVwZGF0ZS5iaW5kKHN0b3JlKSxcbiAgICAgIG9uQWxsTWVzc2FnZXNEaWRVcGRhdGU6IHN0b3JlLm9uQWxsTWVzc2FnZXNEaWRVcGRhdGUuYmluZChzdG9yZSksXG4gICAgfTtcbiAgfVxuICByZXR1cm4gZGlhZ25vc3RpY1VwZGF0ZXI7XG59XG5cbnZhciBjb25zdW1lTGVnYWN5TGludGVycyA9IGZhbHNlO1xudmFyIGxpbnRPblRoZUZseSA9IGZhbHNlO1xudmFyIGFkYXB0ZXJzID0gbmV3IFNldCgpO1xuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgY29uZmlnOiB7XG4gICAgY29uc3VtZUxlZ2FjeUxpbnRlcnM6IHtcbiAgICAgIHR5cGU6ICdib29sZWFuJyxcbiAgICAgIGRlZmF1bHQ6IGZhbHNlLFxuICAgIH0sXG4gICAgbGVnYWN5TGludE9uVGhlRmx5OiB7XG4gICAgICB0eXBlOiAnYm9vbGVhbicsXG4gICAgICBkZWZhdWx0OiBmYWxzZSxcbiAgICAgIGRlc2NyaXB0aW9uOiAnVXNlZCBvbmx5IGZvciBsZWdhY3kgbGludGVycycsXG4gICAgfSxcbiAgfSxcblxuICBhY3RpdmF0ZShzdGF0ZTogP09iamVjdCk6IHZvaWQge1xuICAgIGlmICghZGlzcG9zYWJsZXMpIHtcbiAgICAgIGRpc3Bvc2FibGVzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICB9XG5cbiAgICBjb25zdW1lTGVnYWN5TGludGVycyA9ICgoYXRvbS5jb25maWcuZ2V0KGxlZ2FjeUxpbnRlclNldHRpbmcpOiBhbnkpOiBib29sZWFuKTsgIC8vIHJldHVybnMgbWl4ZWQgc28gYSBjYXN0IGlzIG5lY2Vzc2FyeVxuICAgIGF0b20uY29uZmlnLm9ic2VydmUobGVnYWN5TGludGVyU2V0dGluZywgbmV3VmFsdWUgPT4ge1xuICAgICAgLy8gVG8gbWFrZSB0aGlzIHJlYWxseSBzb2xpZCwgd2Ugc2hvdWxkIGFsc28gcHJvYmFibHkgdHJpZ2dlciB0aGUgbGludGVyXG4gICAgICAvLyBmb3IgdGhlIGFjdGl2ZSB0ZXh0IGVkaXRvci4gUG9zc2libHkgbW9yZSB0cm91YmxlIHRoYW4gaXQncyB3b3J0aCxcbiAgICAgIC8vIHRob3VnaCwgc2luY2UgdGhpcyBtYXkgYmUgYSB0ZW1wb3Jhcnkgb3B0aW9uLlxuICAgICAgY29uc3VtZUxlZ2FjeUxpbnRlcnMgPSBuZXdWYWx1ZTtcbiAgICAgIGFkYXB0ZXJzLmZvckVhY2goYWRhcHRlciA9PiBhZGFwdGVyLnNldEVuYWJsZWQobmV3VmFsdWUpKTtcbiAgICB9KTtcblxuICAgIGxpbnRPblRoZUZseSA9ICgoYXRvbS5jb25maWcuZ2V0KGxlZ2FjeUxpbnRPblRoZUZseVNldHRpbmcpOiBhbnkpOiBib29sZWFuKTtcbiAgICBhdG9tLmNvbmZpZy5vYnNlcnZlKGxlZ2FjeUxpbnRPblRoZUZseVNldHRpbmcsIG5ld1ZhbHVlID0+IHtcbiAgICAgIGxpbnRPblRoZUZseSA9IG5ld1ZhbHVlO1xuICAgICAgYWRhcHRlcnMuZm9yRWFjaChhZGFwdGVyID0+IGFkYXB0ZXIuc2V0TGludE9uRmx5KG5ld1ZhbHVlKSk7XG4gICAgfSk7XG4gIH0sXG5cbiAgY29uc3VtZUxpbnRlclByb3ZpZGVyKHByb3ZpZGVyOiBMaW50ZXJQcm92aWRlcik6IGF0b20kSURpc3Bvc2FibGUge1xuICAgIHZhciBMaW50ZXJBZGFwdGVyID0gcmVxdWlyZSgnLi9MaW50ZXJBZGFwdGVyJyk7XG4gICAgdmFyIGFkYXB0ZXIgPSBuZXcgTGludGVyQWRhcHRlcihwcm92aWRlcik7XG4gICAgYWRhcHRlci5zZXRFbmFibGVkKGNvbnN1bWVMZWdhY3lMaW50ZXJzKTtcbiAgICBhZGFwdGVyLnNldExpbnRPbkZseShsaW50T25UaGVGbHkpO1xuICAgIGFkYXB0ZXJzLmFkZChhZGFwdGVyKTtcbiAgICB2YXIgZGlhZ25vc3RpY0Rpc3Bvc2FibGUgPSB0aGlzLmNvbnN1bWVEaWFnbm9zdGljUHJvdmlkZXIoYWRhcHRlcik7XG4gICAgdmFyIGFkYXB0ZXJEaXNwb3NhYmxlID0gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgZGlhZ25vc3RpY0Rpc3Bvc2FibGUuZGlzcG9zZSgpO1xuICAgICAgYWRhcHRlci5kaXNwb3NlKCk7XG4gICAgICBhZGFwdGVycy5kZWxldGUoYWRhcHRlcik7XG4gICAgfSk7XG4gICAgYWRkRGlzcG9zYWJsZShhZGFwdGVyKTtcbiAgICByZXR1cm4gYWRhcHRlckRpc3Bvc2FibGU7XG4gIH0sXG5cbiAgY29uc3VtZURpYWdub3N0aWNQcm92aWRlcihwcm92aWRlcjogRGlhZ25vc3RpY1Byb3ZpZGVyKTogYXRvbSRJRGlzcG9zYWJsZSB7XG4gICAgdmFyIHN0b3JlID0gZ2V0RGlhZ25vc3RpY1N0b3JlKCk7XG4gICAgLy8gUmVnaXN0ZXIgdGhlIGRpYWdub3N0aWMgc3RvcmUgZm9yIHVwZGF0ZXMgZnJvbSB0aGUgbmV3IHByb3ZpZGVyLlxuICAgIHZhciBjb21wb3NpdGVEaXNwb3NhYmxlID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBjb21wb3NpdGVEaXNwb3NhYmxlLmFkZChcbiAgICAgIHByb3ZpZGVyLm9uTWVzc2FnZVVwZGF0ZSgodXBkYXRlOiBEaWFnbm9zdGljUHJvdmlkZXJVcGRhdGUpID0+IHtcbiAgICAgICAgc3RvcmUudXBkYXRlTWVzc2FnZXMocHJvdmlkZXIsIHVwZGF0ZSk7XG4gICAgICB9KVxuICAgICk7XG4gICAgY29tcG9zaXRlRGlzcG9zYWJsZS5hZGQoXG4gICAgICBwcm92aWRlci5vbk1lc3NhZ2VJbnZhbGlkYXRpb24oKGludmFsaWRhdGlvbk1lc3NhZ2U6IEludmFsaWRhdGlvbk1lc3NhZ2UpID0+IHtcbiAgICAgICAgc3RvcmUuaW52YWxpZGF0ZU1lc3NhZ2VzKHByb3ZpZGVyLCBpbnZhbGlkYXRpb25NZXNzYWdlKTtcbiAgICAgIH0pXG4gICAgKTtcbiAgICBhZGREaXNwb3NhYmxlKGNvbXBvc2l0ZURpc3Bvc2FibGUpO1xuICAgIHJldHVybiBjb21wb3NpdGVEaXNwb3NhYmxlO1xuICB9LFxuXG4gIHByb3ZpZGVEaWFnbm9zdGljVXBkYXRlcygpOiBEaWFnbm9zdGljVXBkYXRlciB7XG4gICAgcmV0dXJuIGdldERpYWdub3N0aWNVcGRhdGVyKCk7XG4gIH0sXG5cbiAgZGVhY3RpdmF0ZSgpIHtcbiAgICBpZiAoZGlzcG9zYWJsZXMpIHtcbiAgICAgIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcbiAgICAgIGRpc3Bvc2FibGVzID0gbnVsbDtcbiAgICB9XG4gICAgaWYgKGRpYWdub3N0aWNTdG9yZSkge1xuICAgICAgZGlhZ25vc3RpY1N0b3JlLmRpc3Bvc2UoKTtcbiAgICAgIGRpYWdub3N0aWNTdG9yZSA9IG51bGw7XG4gICAgfVxuICAgIGRpYWdub3N0aWNVcGRhdGVyID0gbnVsbDtcbiAgfVxufTtcbiJdfQ==
