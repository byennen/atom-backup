
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _require = require('./utils');

var log = _require.log;
var parseDbgpMessages = _require.parseDbgpMessages;
var uriToPath = _require.uriToPath;

/**
 * xdebugPort is the port to listen for dbgp connections on.
 *
 * If present scriptRegex must be a valid RegExp. Only dbgp connections whose script
 * path matches scriptRegex will be accepted. Dbgp connections which do not match
 * the scriptRegex will be ignored.
 *
 * Similarly, the idekeyRegex filters incoming dbgp connections by idekey,
 * and pid filters connections by process id (appid in the dbgp terminology).
 * Note that 0 pid also does not filter on process id.
 */

/**
 * Connect to requested dbgp debuggee on given port.
 *
 * Starts listening for socket connections on the given port.
 * Waits for dbgp init connection message for each connection.
 * If the connection matches the given pid/ideky/path then
 * resolve with the connection and stop listening for new
 * connections.
 * If the connection does not match the given pid/idekey/path
 * then close the connection and continue waiting for a match.
 *
 * TODO: Add timeout or cancel callback.
 */

var DbgpConnector = (function () {
  function DbgpConnector(config) {
    _classCallCheck(this, DbgpConnector);

    this._config = config;
    this._server = null;
    this._connected = false;
  }

  _createClass(DbgpConnector, [{
    key: 'attach',
    value: function attach() {
      var _this = this;

      var port = this._config.xdebugPort;

      log('Creating debug server on port ' + port);

      var server = require('net').createServer();
      this._server = server;
      server.on('close', function (socket) {
        return log('Closing port ' + port);
      });
      server.listen(port, function () {
        return log('Listening on port ' + port);
      });

      return new Promise(function (resolve, reject) {
        server.on('error', function (error) {
          return _this._onServerError(error, reject);
        });
        server.on('connection', function (socket) {
          return _this._onSocketConnection(socket, resolve);
        });
        server.on('close', function () {
          reject('Connection aborted.');
        });
      });
    }
  }, {
    key: '_onSocketConnection',
    value: function _onSocketConnection(socket, accept) {
      var _this2 = this;

      var port = this._config.xdebugPort;

      log('Connection on port ' + port);
      if (this._checkForExistingConnection(socket, 'Connection')) {
        return;
      }
      socket.once('data', function (data) {
        return _this2._onSocketData(socket, data, accept);
      });
    }
  }, {
    key: '_onServerError',
    value: function _onServerError(error, reject) {
      var port = this._config.xdebugPort;

      if (error.code === 'EADDRINUSE') {
        log('Port in use ' + port);
      } else {
        log('Unknown socket error ' + error.code);
      }
      this._server.close();
      reject(error);
    }
  }, {
    key: '_onSocketData',
    value: function _onSocketData(socket, data, accept) {
      if (this._checkForExistingConnection(socket, 'Data')) {
        return;
      }

      function failConnection(errorMessage) {
        log(errorMessage);
        socket.end();
        socket.destroy();
      }

      var messages;
      try {
        messages = parseDbgpMessages(data.toString());
      } catch (error) {
        failConnection('Non XML connection string: ' + data.toString() + '. Discarding connection.');
        return;
      }

      if (messages.length !== 1) {
        failConnection('Expected a single connection message. Got ' + messages.length);
        return;
      }

      var message = messages[0];
      if (this._isCorrectConnection(message)) {
        this._connected = true;
        accept(socket);

        this._server.close();
        this._server = null;
      } else {
        failConnection('Discarding connection ' + JSON.stringify(message));
      }
    }

    /**
     * Checks if a connection already exists. If it does, then close the new socket.
     */
  }, {
    key: '_checkForExistingConnection',
    value: function _checkForExistingConnection(socket, message) {
      var port = this._config.xdebugPort;

      if (this._connected) {
        log('Ignoring ' + message + ' on port ' + port + ' after successful connection.');
        socket.end();
        socket.destroy();
      }
      return this._connected;
    }
  }, {
    key: '_isCorrectConnection',
    value: function _isCorrectConnection(message) {
      var _config = this._config;
      var pid = _config.pid;
      var idekeyRegex = _config.idekeyRegex;
      var scriptRegex = _config.scriptRegex;

      if (!message || !message.init || !message.init.$) {
        log('Incorrect init');
        return false;
      }

      var init = message.init;
      if (!init.engine || !init.engine || !init.engine[0] || init.engine[0]._ !== 'xdebug') {
        log('Incorrect engine');
        return false;
      }

      var attributes = init.$;
      if (attributes.xmlns !== 'urn:debugger_protocol_v1' || attributes['xmlns:xdebug'] !== 'http://xdebug.org/dbgp/xdebug' || attributes.language !== 'PHP') {
        log('Incorrect attributes');
        return false;
      }

      return (!pid || attributes.appid === String(pid)) && (!idekeyRegex || new RegExp(idekeyRegex).test(attributes.idekey)) && (!scriptRegex || new RegExp(scriptRegex).test(uriToPath(attributes.fileuri)));
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      if (this._server) {
        this._server.close();
      }
    }
  }]);

  return DbgpConnector;
})();

module.exports = { DbgpConnector: DbgpConnector };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL2Nvbm5lY3QuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7OztlQWdCUixPQUFPLENBQUMsU0FBUyxDQUFDOztJQUhwQixHQUFHLFlBQUgsR0FBRztJQUNILGlCQUFpQixZQUFqQixpQkFBaUI7SUFDakIsU0FBUyxZQUFULFNBQVM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7SUFrQ0wsYUFBYTtBQUtOLFdBTFAsYUFBYSxDQUtMLE1BQXdCLEVBQUU7MEJBTGxDLGFBQWE7O0FBTWYsUUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7QUFDdEIsUUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7QUFDcEIsUUFBSSxDQUFDLFVBQVUsR0FBRyxLQUFLLENBQUM7R0FDekI7O2VBVEcsYUFBYTs7V0FXWCxrQkFBb0I7OztBQUN4QixVQUFJLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQzs7QUFFbkMsU0FBRyxDQUFDLGdDQUFnQyxHQUFHLElBQUksQ0FBQyxDQUFDOztBQUU3QyxVQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsWUFBWSxFQUFFLENBQUM7QUFDM0MsVUFBSSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUM7QUFDdEIsWUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsVUFBQSxNQUFNO2VBQUksR0FBRyxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7T0FBQSxDQUFDLENBQUM7QUFDMUQsWUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUU7ZUFBTSxHQUFHLENBQUMsb0JBQW9CLEdBQUcsSUFBSSxDQUFDO09BQUEsQ0FBQyxDQUFDOztBQUU1RCxh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VUFBVSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7QUFDeEIsVUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLDBCQUEwQixJQUM5QyxVQUFVLENBQUMsY0FBYyxDQUFDLEtBQUssK0JBQStCLElBQzlELFVBQVUsQ0FBQyxRQUFRLEtBQUssS0FBSyxFQUFFO0FBQ2hDLFdBQUcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0FBQzVCLGVBQU8sS0FBSyxDQUFDO09BQ2hCOztBQUVELGFBQU8sQ0FBQyxDQUFDLEdBQUcsSUFBSSxVQUFVLENBQUMsS0FBSyxLQUFLLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQSxLQUM3QyxDQUFDLFdBQVcsSUFBSSxJQUFJLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxDQUFBLEFBQUMsS0FDaEUsQ0FBQyxXQUFXLElBQUksSUFBSSxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQSxBQUFDLENBQUM7S0FDakY7OztXQUVNLG1CQUFHO0FBQ1IsVUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO0FBQ2hCLFlBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7T0FDdEI7S0FDRjs7O1NBbklHLGFBQWE7OztBQXNJbkIsTUFBTSxDQUFDLE9BQU8sR0FBRyxFQUFDLGFBQWEsRUFBYixhQUFhLEVBQUMsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1kZWJ1Z2dlci1oaHZtLXByb3h5L2xpYi9jb25uZWN0LmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuXG52YXIge1xuICBsb2csXG4gIHBhcnNlRGJncE1lc3NhZ2VzLFxuICB1cmlUb1BhdGgsXG59ID0gcmVxdWlyZSgnLi91dGlscycpO1xuXG4vKipcbiAqIHhkZWJ1Z1BvcnQgaXMgdGhlIHBvcnQgdG8gbGlzdGVuIGZvciBkYmdwIGNvbm5lY3Rpb25zIG9uLlxuICpcbiAqIElmIHByZXNlbnQgc2NyaXB0UmVnZXggbXVzdCBiZSBhIHZhbGlkIFJlZ0V4cC4gT25seSBkYmdwIGNvbm5lY3Rpb25zIHdob3NlIHNjcmlwdFxuICogcGF0aCBtYXRjaGVzIHNjcmlwdFJlZ2V4IHdpbGwgYmUgYWNjZXB0ZWQuIERiZ3AgY29ubmVjdGlvbnMgd2hpY2ggZG8gbm90IG1hdGNoXG4gKiB0aGUgc2NyaXB0UmVnZXggd2lsbCBiZSBpZ25vcmVkLlxuICpcbiAqIFNpbWlsYXJseSwgdGhlIGlkZWtleVJlZ2V4IGZpbHRlcnMgaW5jb21pbmcgZGJncCBjb25uZWN0aW9ucyBieSBpZGVrZXksXG4gKiBhbmQgcGlkIGZpbHRlcnMgY29ubmVjdGlvbnMgYnkgcHJvY2VzcyBpZCAoYXBwaWQgaW4gdGhlIGRiZ3AgdGVybWlub2xvZ3kpLlxuICogTm90ZSB0aGF0IDAgcGlkIGFsc28gZG9lcyBub3QgZmlsdGVyIG9uIHByb2Nlc3MgaWQuXG4gKi9cbnR5cGUgQ29ubmVjdGlvbkNvbmZpZyA9IHtcbiAgeGRlYnVnUG9ydDogbnVtYmVyO1xuICBwaWQ/OiBudW1iZXI7XG4gIHNjcmlwdFJlZ2V4Pzogc3RyaW5nO1xuICBpZGVrZXlSZWdleD86IHN0cmluZztcbn07XG5cbi8qKlxuICogQ29ubmVjdCB0byByZXF1ZXN0ZWQgZGJncCBkZWJ1Z2dlZSBvbiBnaXZlbiBwb3J0LlxuICpcbiAqIFN0YXJ0cyBsaXN0ZW5pbmcgZm9yIHNvY2tldCBjb25uZWN0aW9ucyBvbiB0aGUgZ2l2ZW4gcG9ydC5cbiAqIFdhaXRzIGZvciBkYmdwIGluaXQgY29ubmVjdGlvbiBtZXNzYWdlIGZvciBlYWNoIGNvbm5lY3Rpb24uXG4gKiBJZiB0aGUgY29ubmVjdGlvbiBtYXRjaGVzIHRoZSBnaXZlbiBwaWQvaWRla3kvcGF0aCB0aGVuXG4gKiByZXNvbHZlIHdpdGggdGhlIGNvbm5lY3Rpb24gYW5kIHN0b3AgbGlzdGVuaW5nIGZvciBuZXdcbiAqIGNvbm5lY3Rpb25zLlxuICogSWYgdGhlIGNvbm5lY3Rpb24gZG9lcyBub3QgbWF0Y2ggdGhlIGdpdmVuIHBpZC9pZGVrZXkvcGF0aFxuICogdGhlbiBjbG9zZSB0aGUgY29ubmVjdGlvbiBhbmQgY29udGludWUgd2FpdGluZyBmb3IgYSBtYXRjaC5cbiAqXG4gKiBUT0RPOiBBZGQgdGltZW91dCBvciBjYW5jZWwgY2FsbGJhY2suXG4gKi9cbmNsYXNzIERiZ3BDb25uZWN0b3Ige1xuICBfY29uZmlnOiBDb25uZWN0aW9uQ29uZmlnO1xuICBfc2VydmVyOiA/U2VydmVyO1xuICBfY29ubmVjdGVkOiBib29sZWFuO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogQ29ubmVjdGlvbkNvbmZpZykge1xuICAgIHRoaXMuX2NvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLl9zZXJ2ZXIgPSBudWxsO1xuICAgIHRoaXMuX2Nvbm5lY3RlZCA9IGZhbHNlO1xuICB9XG5cbiAgYXR0YWNoKCk6IFByb21pc2U8U29ja2V0PiB7XG4gICAgdmFyIHBvcnQgPSB0aGlzLl9jb25maWcueGRlYnVnUG9ydDtcblxuICAgIGxvZygnQ3JlYXRpbmcgZGVidWcgc2VydmVyIG9uIHBvcnQgJyArIHBvcnQpO1xuXG4gICAgdmFyIHNlcnZlciA9IHJlcXVpcmUoJ25ldCcpLmNyZWF0ZVNlcnZlcigpO1xuICAgIHRoaXMuX3NlcnZlciA9IHNlcnZlcjtcbiAgICBzZXJ2ZXIub24oJ2Nsb3NlJywgc29ja2V0ID0+IGxvZygnQ2xvc2luZyBwb3J0ICcgKyBwb3J0KSk7XG4gICAgc2VydmVyLmxpc3Rlbihwb3J0LCAoKSA9PiBsb2coJ0xpc3RlbmluZyBvbiBwb3J0ICcgKyBwb3J0KSk7XG5cbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgc2VydmVyLm9uKCdlcnJvcicsIGVycm9yID0+IHRoaXMuX29uU2VydmVyRXJyb3IoZXJyb3IsIHJlamVjdCkpO1xuICAgICAgc2VydmVyLm9uKCdjb25uZWN0aW9uJywgc29ja2V0ID0+IHRoaXMuX29uU29ja2V0Q29ubmVjdGlvbihzb2NrZXQsIHJlc29sdmUpKTtcbiAgICAgIHNlcnZlci5vbignY2xvc2UnLCAoKSA9PiB7cmVqZWN0KCdDb25uZWN0aW9uIGFib3J0ZWQuJyl9KTtcbiAgICB9KTtcbiAgfVxuXG4gIF9vblNvY2tldENvbm5lY3Rpb24oc29ja2V0OiBTb2NrZXQsIGFjY2VwdDogKHNvY2tldDogU29ja2V0KSA9PiB2b2lkKSB7XG4gICAgdmFyIHBvcnQgPSB0aGlzLl9jb25maWcueGRlYnVnUG9ydDtcblxuICAgIGxvZygnQ29ubmVjdGlvbiBvbiBwb3J0ICcgKyBwb3J0KTtcbiAgICBpZiAodGhpcy5fY2hlY2tGb3JFeGlzdGluZ0Nvbm5lY3Rpb24oc29ja2V0LCAnQ29ubmVjdGlvbicpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHNvY2tldC5vbmNlKCdkYXRhJywgZGF0YSA9PiB0aGlzLl9vblNvY2tldERhdGEoc29ja2V0LCBkYXRhLCBhY2NlcHQpKTtcbiAgfVxuXG4gIF9vblNlcnZlckVycm9yKGVycm9yOiBPYmplY3QsIHJlamVjdDogKHJlYXNvbjogT2JqZWN0KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdmFyIHBvcnQgPSB0aGlzLl9jb25maWcueGRlYnVnUG9ydDtcblxuICAgIGlmIChlcnJvci5jb2RlID09PSAnRUFERFJJTlVTRScpIHtcbiAgICAgIGxvZygnUG9ydCBpbiB1c2UgJyArIHBvcnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2coJ1Vua25vd24gc29ja2V0IGVycm9yICcgKyBlcnJvci5jb2RlKTtcbiAgICB9XG4gICAgdGhpcy5fc2VydmVyLmNsb3NlKCk7XG4gICAgcmVqZWN0KGVycm9yKTtcbiAgfVxuXG4gIF9vblNvY2tldERhdGEoc29ja2V0OiBTb2NrZXQsIGRhdGE6IEJ1ZmZlciB8IHN0cmluZywgYWNjZXB0OiAoc29ja2V0OiBTb2NrZXQpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fY2hlY2tGb3JFeGlzdGluZ0Nvbm5lY3Rpb24oc29ja2V0LCAnRGF0YScpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZmFpbENvbm5lY3Rpb24oZXJyb3JNZXNzYWdlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgIGxvZyhlcnJvck1lc3NhZ2UpO1xuICAgICAgc29ja2V0LmVuZCgpO1xuICAgICAgc29ja2V0LmRlc3Ryb3koKTtcbiAgICB9XG5cbiAgICB2YXIgbWVzc2FnZXM7XG4gICAgdHJ5IHtcbiAgICAgIG1lc3NhZ2VzID0gcGFyc2VEYmdwTWVzc2FnZXMoZGF0YS50b1N0cmluZygpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZmFpbENvbm5lY3Rpb24oJ05vbiBYTUwgY29ubmVjdGlvbiBzdHJpbmc6ICcgKyBkYXRhLnRvU3RyaW5nKCkgKyAnLiBEaXNjYXJkaW5nIGNvbm5lY3Rpb24uJyk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG1lc3NhZ2VzLmxlbmd0aCAhPT0gMSkge1xuICAgICAgZmFpbENvbm5lY3Rpb24oJ0V4cGVjdGVkIGEgc2luZ2xlIGNvbm5lY3Rpb24gbWVzc2FnZS4gR290ICcgKyBtZXNzYWdlcy5sZW5ndGgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHZhciBtZXNzYWdlID0gbWVzc2FnZXNbMF07XG4gICAgaWYgKHRoaXMuX2lzQ29ycmVjdENvbm5lY3Rpb24obWVzc2FnZSkpIHtcbiAgICAgIHRoaXMuX2Nvbm5lY3RlZCA9IHRydWU7XG4gICAgICBhY2NlcHQoc29ja2V0KTtcblxuICAgICAgdGhpcy5fc2VydmVyLmNsb3NlKCk7XG4gICAgICB0aGlzLl9zZXJ2ZXIgPSBudWxsO1xuICAgIH0gZWxzZSB7XG4gICAgICBmYWlsQ29ubmVjdGlvbignRGlzY2FyZGluZyBjb25uZWN0aW9uICcgKyBKU09OLnN0cmluZ2lmeShtZXNzYWdlKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrcyBpZiBhIGNvbm5lY3Rpb24gYWxyZWFkeSBleGlzdHMuIElmIGl0IGRvZXMsIHRoZW4gY2xvc2UgdGhlIG5ldyBzb2NrZXQuXG4gICAqL1xuICBfY2hlY2tGb3JFeGlzdGluZ0Nvbm5lY3Rpb24oc29ja2V0OiBTb2NrZXQsIG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuICAgIHZhciBwb3J0ID0gdGhpcy5fY29uZmlnLnhkZWJ1Z1BvcnQ7XG5cbiAgICBpZiAodGhpcy5fY29ubmVjdGVkKSB7XG4gICAgICBsb2coJ0lnbm9yaW5nICcgKyBtZXNzYWdlICsgJyBvbiBwb3J0ICcgKyBwb3J0ICsgJyBhZnRlciBzdWNjZXNzZnVsIGNvbm5lY3Rpb24uJyk7XG4gICAgICBzb2NrZXQuZW5kKCk7XG4gICAgICBzb2NrZXQuZGVzdHJveSgpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fY29ubmVjdGVkO1xuICB9XG5cbiAgX2lzQ29ycmVjdENvbm5lY3Rpb24obWVzc2FnZTogT2JqZWN0KTogYm9vbGVhbiB7XG4gICAgdmFyIHtwaWQsIGlkZWtleVJlZ2V4LCBzY3JpcHRSZWdleH0gPSB0aGlzLl9jb25maWc7XG5cbiAgICBpZiAoIW1lc3NhZ2UgfHwgIW1lc3NhZ2UuaW5pdCB8fCAhbWVzc2FnZS5pbml0LiQpIHtcbiAgICAgIGxvZygnSW5jb3JyZWN0IGluaXQnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICB2YXIgaW5pdCA9IG1lc3NhZ2UuaW5pdDtcbiAgICBpZiAoIWluaXQuZW5naW5lIHx8ICFpbml0LmVuZ2luZSB8fCAhaW5pdC5lbmdpbmVbMF0gfHwgaW5pdC5lbmdpbmVbMF0uXyAhPT0gJ3hkZWJ1ZycpIHtcbiAgICAgIGxvZygnSW5jb3JyZWN0IGVuZ2luZScpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHZhciBhdHRyaWJ1dGVzID0gaW5pdC4kO1xuICAgIGlmIChhdHRyaWJ1dGVzLnhtbG5zICE9PSAndXJuOmRlYnVnZ2VyX3Byb3RvY29sX3YxJ1xuICAgICAgfHwgYXR0cmlidXRlc1sneG1sbnM6eGRlYnVnJ10gIT09ICdodHRwOi8veGRlYnVnLm9yZy9kYmdwL3hkZWJ1ZydcbiAgICAgIHx8IGF0dHJpYnV0ZXMubGFuZ3VhZ2UgIT09ICdQSFAnKSB7XG4gICAgICAgIGxvZygnSW5jb3JyZWN0IGF0dHJpYnV0ZXMnKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiAoIXBpZCB8fCBhdHRyaWJ1dGVzLmFwcGlkID09PSBTdHJpbmcocGlkKSkgJiZcbiAgICAgICghaWRla2V5UmVnZXggfHwgbmV3IFJlZ0V4cChpZGVrZXlSZWdleCkudGVzdChhdHRyaWJ1dGVzLmlkZWtleSkpICYmXG4gICAgICAoIXNjcmlwdFJlZ2V4IHx8IG5ldyBSZWdFeHAoc2NyaXB0UmVnZXgpLnRlc3QodXJpVG9QYXRoKGF0dHJpYnV0ZXMuZmlsZXVyaSkpKTtcbiAgfVxuXG4gIGRpc3Bvc2UoKSB7XG4gICAgaWYgKHRoaXMuX3NlcnZlcikge1xuICAgICAgdGhpcy5fc2VydmVyLmNsb3NlKCk7XG4gICAgfVxuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge0RiZ3BDb25uZWN0b3J9O1xuIl19
