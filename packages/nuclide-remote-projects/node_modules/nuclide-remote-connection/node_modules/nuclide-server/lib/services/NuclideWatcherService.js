
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var watchFile = _asyncToGenerator(function* (filePath) {
  var exists = yield fsPromise.exists(filePath);
  if (!exists) {
    // Atom watcher behavior compatability.
    throw new Error('Can\'t watch a non-existing file! : ' + filePath);
  }
  var realPath = yield fsPromise.realpath(filePath);
  var watchEntry = watchedFiles[realPath];
  if (!watchEntry) {
    watchEntry = watchedFiles[realPath] = {
      eventEmitter: new EventEmitter(),
      subscriptionCount: 0,
      eventEmitterId: null
    };
  }
  watchEntry.subscriptionCount++;
  // A watch entry would have only a permanent eventEmitterId for all the future watch requests.
  watchEntry.eventEmitterId = watchEntry.eventEmitterId || this.registerEventEmitter(watchEntry.eventEmitter);
  return watchEntry.eventEmitterId;
});

var unwatchFile = _asyncToGenerator(function* (filePath) {
  var exists = yield fsPromise.exists(filePath);
  if (!exists) {
    return;
  }
  var realPath = yield fsPromise.realpath(filePath);
  var watchEntry = watchedFiles[realPath];
  if (watchEntry) {
    if (--watchEntry.subscriptionCount === 0) {
      delete watchedFiles[realPath];
    }
  }
});

var watchDirectory = _asyncToGenerator(function* (directoryPath) {
  var exists = yield fsPromise.exists(directoryPath);
  if (!exists) {
    return;
  }
  var realPath = yield fsPromise.realpath(directoryPath);
  var watchEntry = watchedDirectories[realPath];
  if (!watchEntry) {
    watchEntry = watchedDirectories[realPath] = {
      eventEmitter: new EventEmitter(),
      subscriptionCount: 0,
      eventEmitterId: null
    };
  }
  watchEntry.subscriptionCount++;
  // A watch entry would have only a permanent eventEmitterId for all the future watch requests.
  watchEntry.eventEmitterId = watchEntry.eventEmitterId || this.registerEventEmitter(watchEntry.eventEmitter);
  return watchEntry.eventEmitterId;
});

var unwatchDirectory = _asyncToGenerator(function* (directoryPath) {
  var exists = yield fsPromise.exists(directoryPath);
  if (!exists) {
    return;
  }
  var realPath = yield fsPromise.realpath(directoryPath);
  var watchEntry = watchedDirectories[realPath];
  if (watchEntry) {
    if (--watchEntry.subscriptionCount === 0) {
      delete watchedDirectories[realPath];
    }
  }
});

var watchDirectoryRecursive = _asyncToGenerator(function* (directoryPath, channel) {
  var _this = this;

  watchmanClient = watchmanClient || new WatchmanClient();
  if (watchmanClient.hasSubscription(directoryPath)) {
    return;
  }
  var watcher = yield watchmanClient.watchDirectoryRecursive(directoryPath);

  watcher.on('change', function (entries) {
    _this.publish(channel);

    var directoryChanges = {};

    for (var i = 0; i < entries.length; i++) {
      var entry = entries[i];
      var entryPath = path.join(watcher.root, entry.name);
      if (watchedFiles[entryPath]) {
        var fileWatcherEntry = watchedFiles[entryPath];
        // TODO(most): handle `rename`, if needed.
        if (!entry.exists) {
          fileWatcherEntry.eventEmitter.emit('delete');
        } else {
          fileWatcherEntry.eventEmitter.emit('change');
        }
      }
      // A file watch event can also be considered a directry change
      // for the parent directory if a file was created or deleted.
      if (entry['new'] || !entry.exists) {
        var entryDirectoryPath = path.join(entryPath, '..');
        if (watchedDirectories[entryDirectoryPath]) {
          directoryChanges[entryDirectoryPath] = (directoryChanges[entryDirectoryPath] || []).concat([entry]);
        }
      }
    }

    for (var watchedDirectoryPath in directoryChanges) {
      var changes = directoryChanges[watchedDirectoryPath];
      var directoryWatcherEntry = watchedDirectories[watchedDirectoryPath];
      directoryWatcherEntry.eventEmitter.emit('change', changes);
    }
  });
});

var unwatchDirectoryRecursive = _asyncToGenerator(function* (directoryPath) {
  watchmanClient = watchmanClient || new WatchmanClient();
  yield watchmanClient.unwatch(directoryPath);
});

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

var _require = require('nuclide-commons');

var fsPromise = _require.fsPromise;

var path = require('path');

var _require2 = require('events');

var EventEmitter = _require2.EventEmitter;

var _require3 = require('nuclide-watchman-helpers');

var WatchmanClient = _require3.WatchmanClient;

var watchmanClient = null;

var watchedFiles = {};
var watchedDirectories = {};

module.exports = {
  services: {
    '/watcher/watchFile': { handler: watchFile, method: 'post' },
    '/watcher/unwatchFile': { handler: unwatchFile, method: 'post' },
    '/watcher/watchDirectory': { handler: watchDirectory, method: 'post' },
    '/watcher/unwatchDirectory': { handler: unwatchDirectory, method: 'post' },
    '/watcher/watchDirectoryRecursive': { handler: watchDirectoryRecursive, method: 'post' },
    '/watcher/unwatchDirectoryRecursive': { handler: unwatchDirectoryRecursive, method: 'post' }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZXMvTnVjbGlkZVdhdGNoZXJTZXJ2aWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7OztJQTBCRyxTQUFTLHFCQUF4QixXQUF5QixRQUFnQixFQUFtQjtBQUMxRCxNQUFJLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDOUMsTUFBSSxDQUFDLE1BQU0sRUFBRTs7QUFFWCxVQUFNLElBQUksS0FBSyxDQUFDLHNDQUFzQyxHQUFHLFFBQVEsQ0FBQyxDQUFDO0dBQ3BFO0FBQ0QsTUFBSSxRQUFRLEdBQUcsTUFBTSxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ2xELE1BQUksVUFBVSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN4QyxNQUFJLENBQUMsVUFBVSxFQUFFO0FBQ2YsY0FBVSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsR0FBRztBQUNwQyxrQkFBWSxFQUFFLElBQUksWUFBWSxFQUFFO0FBQ2hDLHVCQUFpQixFQUFFLENBQUM7QUFDcEIsb0JBQWMsRUFBRSxJQUFJO0tBQ3JCLENBQUM7R0FDSDtBQUNELFlBQVUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDOztBQUUvQixZQUFVLENBQUMsY0FBYyxHQUFHLFVBQVUsQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUM1RyxTQUFPLFVBQVUsQ0FBQyxjQUFjLENBQUM7Q0FDbEM7O0lBRWMsV0FBVyxxQkFBMUIsV0FBMkIsUUFBZ0IsRUFBaUI7QUFDMUQsTUFBSSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsTUFBTSxDQUFDLFFB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TyxDQUFDLGlCQUFpQixDQUFDOztJQUF2QyxTQUFTLFlBQVQsU0FBUzs7QUFDZCxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7O2dCQUNOLE9BQU8sQ0FBQyxRQUFRLENBQUM7O0lBQWpDLFlBQVksYUFBWixZQUFZOztnQkFDTSxPQUFPLENBQUMsMEJBQTBCLENBQUM7O0lBQXJELGNBQWMsYUFBZCxjQUFjOztBQUVuQixJQUFJLGNBQStCLEdBQUcsSUFBSSxDQUFDOztBQU8zQyxJQUFJLFlBQThDLEdBQUcsRUFBRSxDQUFDO0FBQ3hELElBQUksa0JBQXlELEdBQUcsRUFBRSxDQUFDOztBQXNIbkUsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLFVBQVEsRUFBRTtBQUNSLHdCQUFvQixFQUFFLEVBQUMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDO0FBQzFELDBCQUFzQixFQUFFLEVBQUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDO0FBQzlELDZCQUF5QixFQUFFLEVBQUMsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDO0FBQ3BFLCtCQUEyQixFQUFFLEVBQUMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUM7QUFDeEUsc0NBQWtDLEVBQUUsRUFBQyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBQztBQUN0Rix3Q0FBb0MsRUFBRSxFQUFDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDO0dBQzNGO0NBQ0YsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1zZXJ2ZXIvbGliL3NlcnZpY2VzL051Y2xpZGVXYXRjaGVyU2VydmljZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbnZhciB7ZnNQcm9taXNlfSA9IHJlcXVpcmUoJ251Y2xpZGUtY29tbW9ucycpO1xudmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG52YXIge0V2ZW50RW1pdHRlcn0gPSByZXF1aXJlKCdldmVudHMnKTtcbnZhciB7V2F0Y2htYW5DbGllbnR9ID0gcmVxdWlyZSgnbnVjbGlkZS13YXRjaG1hbi1oZWxwZXJzJyk7XG5cbnZhciB3YXRjaG1hbkNsaWVudDogP1dhdGNobWFuQ2xpZW50ID0gbnVsbDtcblxudHlwZSBXYXRjaEVudHJ5ID0ge1xuICBldmVudEVtaXR0ZXI6IEV2ZW50RW1pdHRlcjtcbiAgc3Vic2NyaXB0aW9uQ291bnQ6IG51bWJlcjtcbn07XG5cbnZhciB3YXRjaGVkRmlsZXM6IHtbZmlsZVBhdGg6IHN0cmluZ106IFdhdGNoRW50cnl9ID0ge307XG52YXIgd2F0Y2hlZERpcmVjdG9yaWVzOiB7W2RpcmVjdG9yeVBhdGg6IHN0cmluZ106IFdhdGNoRW50cnl9ID0ge307XG5cbmFzeW5jIGZ1bmN0aW9uIHdhdGNoRmlsZShmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgdmFyIGV4aXN0cyA9IGF3YWl0IGZzUHJvbWlzZS5leGlzdHMoZmlsZVBhdGgpO1xuICBpZiAoIWV4aXN0cykge1xuICAgIC8vIEF0b20gd2F0Y2hlciBiZWhhdmlvciBjb21wYXRhYmlsaXR5LlxuICAgIHRocm93IG5ldyBFcnJvcignQ2FuXFwndCB3YXRjaCBhIG5vbi1leGlzdGluZyBmaWxlISA6ICcgKyBmaWxlUGF0aCk7XG4gIH1cbiAgdmFyIHJlYWxQYXRoID0gYXdhaXQgZnNQcm9taXNlLnJlYWxwYXRoKGZpbGVQYXRoKTtcbiAgdmFyIHdhdGNoRW50cnkgPSB3YXRjaGVkRmlsZXNbcmVhbFBhdGhdO1xuICBpZiAoIXdhdGNoRW50cnkpIHtcbiAgICB3YXRjaEVudHJ5ID0gd2F0Y2hlZEZpbGVzW3JlYWxQYXRoXSA9IHtcbiAgICAgIGV2ZW50RW1pdHRlcjogbmV3IEV2ZW50RW1pdHRlcigpLFxuICAgICAgc3Vic2NyaXB0aW9uQ291bnQ6IDAsXG4gICAgICBldmVudEVtaXR0ZXJJZDogbnVsbCxcbiAgICB9O1xuICB9XG4gIHdhdGNoRW50cnkuc3Vic2NyaXB0aW9uQ291bnQrKztcbiAgLy8gQSB3YXRjaCBlbnRyeSB3b3VsZCBoYXZlIG9ubHkgYSBwZXJtYW5lbnQgZXZlbnRFbWl0dGVySWQgZm9yIGFsbCB0aGUgZnV0dXJlIHdhdGNoIHJlcXVlc3RzLlxuICB3YXRjaEVudHJ5LmV2ZW50RW1pdHRlcklkID0gd2F0Y2hFbnRyeS5ldmVudEVtaXR0ZXJJZCB8fCB0aGlzLnJlZ2lzdGVyRXZlbnRFbWl0dGVyKHdhdGNoRW50cnkuZXZlbnRFbWl0dGVyKTtcbiAgcmV0dXJuIHdhdGNoRW50cnkuZXZlbnRFbWl0dGVySWQ7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVud2F0Y2hGaWxlKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgdmFyIGV4aXN0cyA9IGF3YWl0IGZzUHJvbWlzZS5leGlzdHMoZmlsZVBhdGgpO1xuICBpZiAoIWV4aXN0cykge1xuICAgIHJldHVybjtcbiAgfVxuICB2YXIgcmVhbFBhdGggPSBhd2FpdCBmc1Byb21pc2UucmVhbHBhdGgoZmlsZVBhdGgpO1xuICB2YXIgd2F0Y2hFbnRyeSA9IHdhdGNoZWRGaWxlc1tyZWFsUGF0aF07XG4gIGlmICh3YXRjaEVudHJ5KSB7XG4gICAgaWYgKC0td2F0Y2hFbnRyeS5zdWJzY3JpcHRpb25Db3VudCA9PT0gMCkge1xuICAgICAgZGVsZXRlIHdhdGNoZWRGaWxlc1tyZWFsUGF0aF07XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdhdGNoRGlyZWN0b3J5KGRpcmVjdG9yeVBhdGg6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gIHZhciBleGlzdHMgPSBhd2FpdCBmc1Byb21pc2UuZXhpc3RzKGRpcmVjdG9yeVBhdGgpO1xuICBpZiAoIWV4aXN0cykge1xuICAgIHJldHVybjtcbiAgfVxuICB2YXIgcmVhbFBhdGggPSBhd2FpdCBmc1Byb21pc2UucmVhbHBhdGgoZGlyZWN0b3J5UGF0aCk7XG4gIHZhciB3YXRjaEVudHJ5ID0gd2F0Y2hlZERpcmVjdG9yaWVzW3JlYWxQYXRoXTtcbiAgaWYgKCF3YXRjaEVudHJ5KSB7XG4gICAgd2F0Y2hFbnRyeSA9IHdhdGNoZWREaXJlY3Rvcmllc1tyZWFsUGF0aF0gPSB7XG4gICAgICBldmVudEVtaXR0ZXI6IG5ldyBFdmVudEVtaXR0ZXIoKSxcbiAgICAgIHN1YnNjcmlwdGlvbkNvdW50OiAwLFxuICAgICAgZXZlbnRFbWl0dGVySWQ6IG51bGwsXG4gICAgfTtcbiAgfVxuICB3YXRjaEVudHJ5LnN1YnNjcmlwdGlvbkNvdW50Kys7XG4gIC8vIEEgd2F0Y2ggZW50cnkgd291bGQgaGF2ZSBvbmx5IGEgcGVybWFuZW50IGV2ZW50RW1pdHRlcklkIGZvciBhbGwgdGhlIGZ1dHVyZSB3YXRjaCByZXF1ZXN0cy5cbiAgd2F0Y2hFbnRyeS5ldmVudEVtaXR0ZXJJZCA9IHdhdGNoRW50cnkuZXZlbnRFbWl0dGVySWQgfHwgdGhpcy5yZWdpc3RlckV2ZW50RW1pdHRlcih3YXRjaEVudHJ5LmV2ZW50RW1pdHRlcik7XG4gIHJldHVybiB3YXRjaEVudHJ5LmV2ZW50RW1pdHRlcklkO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1bndhdGNoRGlyZWN0b3J5KGRpcmVjdG9yeVBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICB2YXIgZXhpc3RzID0gYXdhaXQgZnNQcm9taXNlLmV4aXN0cyhkaXJlY3RvcnlQYXRoKTtcbiAgaWYgKCFleGlzdHMpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgdmFyIHJlYWxQYXRoID0gYXdhaXQgZnNQcm9taXNlLnJlYWxwYXRoKGRpcmVjdG9yeVBhdGgpO1xuICB2YXIgd2F0Y2hFbnRyeSA9IHdhdGNoZWREaXJlY3Rvcmllc1tyZWFsUGF0aF07XG4gIGlmICh3YXRjaEVudHJ5KSB7XG4gICAgaWYgKC0td2F0Y2hFbnRyeS5zdWJzY3JpcHRpb25Db3VudCA9PT0gMCkge1xuICAgICAgZGVsZXRlIHdhdGNoZWREaXJlY3Rvcmllc1tyZWFsUGF0aF07XG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHdhdGNoRGlyZWN0b3J5UmVjdXJzaXZlKGRpcmVjdG9yeVBhdGg6IHN0cmluZywgY2hhbm5lbDogc3RyaW5nKTogUHJvbWlzZSB7XG4gIHdhdGNobWFuQ2xpZW50ID0gd2F0Y2htYW5DbGllbnQgfHwgbmV3IFdhdGNobWFuQ2xpZW50KCk7XG4gIGlmICh3YXRjaG1hbkNsaWVudC5oYXNTdWJzY3JpcHRpb24oZGlyZWN0b3J5UGF0aCkpIHtcbiAgICByZXR1cm47XG4gIH1cbiAgdmFyIHdhdGNoZXIgPSBhd2FpdCB3YXRjaG1hbkNsaWVudC53YXRjaERpcmVjdG9yeVJlY3Vyc2l2ZShkaXJlY3RvcnlQYXRoKTtcblxuICB3YXRjaGVyLm9uKCdjaGFuZ2UnLCAoZW50cmllczogQXJyYXk8RmlsZUNoYW5nZT4pID0+IHtcbiAgICB0aGlzLnB1Ymxpc2goY2hhbm5lbCk7XG5cbiAgICB2YXIgZGlyZWN0b3J5Q2hhbmdlcyA9IHt9O1xuXG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbnRyaWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2YXIgZW50cnkgPSBlbnRyaWVzW2ldO1xuICAgICAgdmFyIGVudHJ5UGF0aCA9IHBhdGguam9pbih3YXRjaGVyLnJvb3QsIGVudHJ5Lm5hbWUpO1xuICAgICAgaWYgKHdhdGNoZWRGaWxlc1tlbnRyeVBhdGhdKSB7XG4gICAgICAgIHZhciBmaWxlV2F0Y2hlckVudHJ5ID0gd2F0Y2hlZEZpbGVzW2VudHJ5UGF0aF07XG4gICAgICAgIC8vIFRPRE8obW9zdCk6IGhhbmRsZSBgcmVuYW1lYCwgaWYgbmVlZGVkLlxuICAgICAgICBpZiAoIWVudHJ5LmV4aXN0cykge1xuICAgICAgICAgIGZpbGVXYXRjaGVyRW50cnkuZXZlbnRFbWl0dGVyLmVtaXQoJ2RlbGV0ZScpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZpbGVXYXRjaGVyRW50cnkuZXZlbnRFbWl0dGVyLmVtaXQoJ2NoYW5nZScpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyBBIGZpbGUgd2F0Y2ggZXZlbnQgY2FuIGFsc28gYmUgY29uc2lkZXJlZCBhIGRpcmVjdHJ5IGNoYW5nZVxuICAgICAgLy8gZm9yIHRoZSBwYXJlbnQgZGlyZWN0b3J5IGlmIGEgZmlsZSB3YXMgY3JlYXRlZCBvciBkZWxldGVkLlxuICAgICAgaWYgKGVudHJ5Lm5ldyB8fCAhZW50cnkuZXhpc3RzKSB7XG4gICAgICAgIHZhciBlbnRyeURpcmVjdG9yeVBhdGggPSBwYXRoLmpvaW4oZW50cnlQYXRoLCAnLi4nKTtcbiAgICAgICAgaWYgKHdhdGNoZWREaXJlY3Rvcmllc1tlbnRyeURpcmVjdG9yeVBhdGhdKSB7XG4gICAgICAgICAgZGlyZWN0b3J5Q2hhbmdlc1tlbnRyeURpcmVjdG9yeVBhdGhdID0gKGRpcmVjdG9yeUNoYW5nZXNbZW50cnlEaXJlY3RvcnlQYXRoXSB8fCBbXSkuY29uY2F0KFtlbnRyeV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgZm9yICh2YXIgd2F0Y2hlZERpcmVjdG9yeVBhdGggaW4gZGlyZWN0b3J5Q2hhbmdlcykge1xuICAgICAgdmFyIGNoYW5nZXMgPSBkaXJlY3RvcnlDaGFuZ2VzW3dhdGNoZWREaXJlY3RvcnlQYXRoXTtcbiAgICAgIHZhciBkaXJlY3RvcnlXYXRjaGVyRW50cnkgPSB3YXRjaGVkRGlyZWN0b3JpZXNbd2F0Y2hlZERpcmVjdG9yeVBhdGhdO1xuICAgICAgZGlyZWN0b3J5V2F0Y2hlckVudHJ5LmV2ZW50RW1pdHRlci5lbWl0KCdjaGFuZ2UnLCBjaGFuZ2VzKTtcbiAgICB9XG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1bndhdGNoRGlyZWN0b3J5UmVjdXJzaXZlKGRpcmVjdG9yeVBhdGg6IHN0cmluZykge1xuICB3YXRjaG1hbkNsaWVudCA9IHdhdGNobWFuQ2xpZW50IHx8IG5ldyBXYXRjaG1hbkNsaWVudCgpO1xuICBhd2FpdCB3YXRjaG1hbkNsaWVudC51bndhdGNoKGRpcmVjdG9yeVBhdGgpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgc2VydmljZXM6IHtcbiAgICAnL3dhdGNoZXIvd2F0Y2hGaWxlJzoge2hhbmRsZXI6IHdhdGNoRmlsZSwgbWV0aG9kOiAncG9zdCd9LFxuICAgICcvd2F0Y2hlci91bndhdGNoRmlsZSc6IHtoYW5kbGVyOiB1bndhdGNoRmlsZSwgbWV0aG9kOiAncG9zdCd9LFxuICAgICcvd2F0Y2hlci93YXRjaERpcmVjdG9yeSc6IHtoYW5kbGVyOiB3YXRjaERpcmVjdG9yeSwgbWV0aG9kOiAncG9zdCd9LFxuICAgICcvd2F0Y2hlci91bndhdGNoRGlyZWN0b3J5Jzoge2hhbmRsZXI6IHVud2F0Y2hEaXJlY3RvcnksIG1ldGhvZDogJ3Bvc3QnfSxcbiAgICAnL3dhdGNoZXIvd2F0Y2hEaXJlY3RvcnlSZWN1cnNpdmUnOiB7aGFuZGxlcjogd2F0Y2hEaXJlY3RvcnlSZWN1cnNpdmUsIG1ldGhvZDogJ3Bvc3QnfSxcbiAgICAnL3dhdGNoZXIvdW53YXRjaERpcmVjdG9yeVJlY3Vyc2l2ZSc6IHtoYW5kbGVyOiB1bndhdGNoRGlyZWN0b3J5UmVjdXJzaXZlLCBtZXRob2Q6ICdwb3N0J30sXG4gIH0sXG59O1xuIl19
