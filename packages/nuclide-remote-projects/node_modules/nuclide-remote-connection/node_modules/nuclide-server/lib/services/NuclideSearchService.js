
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

// TODO (mikeo): Make this another search provider

var doSearchDirectory = _asyncToGenerator(function* (directoryUri, query) {
  var search = fileSearchers[directoryUri];
  if (search === undefined) {
    var directory = remoteUri.parse(directoryUri).path;

    var exists = yield fsPromise.exists(directory);
    if (!exists) {
      throw new Error('Could not find directory to search : ' + directory);
    }

    var stat = yield fsPromise.stat(directory);
    if (!stat.isDirectory()) {
      throw new Error('Provided path is not a directory : ' + directory);
    }

    search = yield fileSearchForDirectory(directoryUri);
    fileSearchers[directoryUri] = search;
  }

  return yield search.query(query);
});

var getSearchProviders = _asyncToGenerator(function* (cwd) {
  var checkAvailability = _asyncToGenerator(function* (providerName) {
    var isAvailable = yield providers[providerName].isAvailable(cwd);
    return isAvailable ? { name: providerName } : null;
  });

  var validPromises = [];

  for (var name in providers) {
    validPromises.push(checkAvailability(name));
  }

  var results = yield Promise.all(validPromises);
  return results.filter(function (provider) {
    return !!provider;
  });
});

var doSearchQuery = _asyncToGenerator(function* (cwd, provider, query) {
  var currentProvider = providers[provider];
  if (!currentProvider) {
    throw new Error('Invalid provider: ' + provider);
  }
  var results = yield currentProvider.query(cwd, query);
  return { results: results };
});

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

var _require = require('nuclide-commons');

var fsPromise = _require.fsPromise;

var _require2 = require('nuclide-path-search');

var fileSearchForDirectory = _require2.fileSearchForDirectory;

var remoteUri = require('nuclide-remote-uri');

var providers;

/*
 * TODO(williamsc): This needs to have some better
 *                  managment tools (Adding/removing query sets).
 */

// Cache of previously indexed folders for later use.
var fileSearchers = {};

function addProvider(name, provider) {
  providers = providers || {};
  if (providers[name]) {
    throw new Error(name + ' has already been added as a provider.');
  }
  providers[name] = provider;
}

function clearProviders() {
  providers = undefined;
}

function initialize(server) {
  var HackProvider = require('./search/HackProvider');
  addProvider('hack', new HackProvider(server));

  var BigGrepProvider;
  try {
    BigGrepProvider = require('./search/fb/BigGrepProvider');
  } catch (e) {}
  if (BigGrepProvider) {
    addProvider('biggrep', new BigGrepProvider(server));
  }
}

function shutdown(server) {
  clearProviders();
}

module.exports = {
  initialize: initialize,
  shutdown: shutdown,
  addProvider: addProvider,
  clearProviders: clearProviders,
  services: {
    '/search/query': { handler: doSearchQuery, method: 'post' },
    '/search/listProviders': { handler: getSearchProviders, method: 'post' },
    '/search/directory': { handler: doSearchDirectory }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZXMvTnVjbGlkZVNlYXJjaFNlcnZpY2UuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7Ozs7SUFrREcsaUJBQWlCLHFCQUFoQyxXQUFpQyxZQUFvQixFQUFFLEtBQWEsRUFBb0M7QUFDdEcsTUFBSSxNQUFNLEdBQUcsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3pDLE1BQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtBQUN4QixRQUFJLFNBQVMsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQzs7QUFFbkQsUUFBSSxNQUFNLEdBQUcsTUFBTSxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQy9DLFFBQUksQ0FBQyxNQUFNLEVBQUU7QUFDWCxZQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxHQUFHLFNBQVMsQ0FBQyxDQUFDO0tBQ3RFOztBQUVELFFBQUksSUFBSSxHQUFHLE1BQU0sU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztBQUMzQyxRQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFO0FBQ3ZCLFlBQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLEdBQUcsU0FBUyxDQUFDLENBQUM7S0FDcEU7O0FBRUQsVUFBTSxHQUFHLE1BQU0sc0JBQXNCLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEQsaUJBQWEsQ0FBQyxZQUFZLENBQUMsR0FBRyxNQUFNLENBQUM7R0FDdEM7O0FBRUQsU0FBTyxNQUFNLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Q0FDbEM7O0lBRWMsa0JBQWtCLHFCQUFqQyxXQUFrQyxHQUFXLEVBQWdDO01BRzVE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QU0sRUFBQztBQUN6RCwyQkFBdUIsRUFBRSxFQUFDLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxFQUFDO0FBQ3RFLHVCQUFtQixFQUFFLEVBQUMsT0FBTyxFQUFFLGlCQUFpQixFQUFDO0dBQ2xEO0NBQ0YsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1zZXJ2ZXIvbGliL3NlcnZpY2VzL051Y2xpZGVTZWFyY2hTZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxudHlwZSBTZWFyY2hRdWVyeSA9IHtcbiAgcHJvdmlkZXI6IHN0cmluZztcbiAgcXVlcnk6IHN0cmluZztcbn1cblxudHlwZSBQcm92aWRlckluZm8gPSB7XG4gIG5hbWU6IHN0cmluZztcbn1cblxudHlwZSBTZWFyY2hRdWVyeVJlc3VsdCA9IHtcbiAgbGluZTogbnVtYmVyO1xuICBjb2x1bW46IG51bWJlcjtcbiAgbmFtZTogc3RyaW5nO1xuICBwYXRoOiBzdHJpbmc7XG4gIGxlbmd0aDogbnVtYmVyO1xuICBzY29wZTogc3RyaW5nO1xuICBhZGRpdGlvbmFsSW5mbzogc3RyaW5nO1xuICBhY3Rpb246IHN0cmluZztcbn1cblxudHlwZSBTZWFyY2hSZXNwb25zZSA9IHtcbiAgcmVzdWx0czogQXJyYXk8U2VhcmNoUXVlcnlSZXN1bHQ+O1xufVxuXG52YXIge2ZzUHJvbWlzZX0gPSByZXF1aXJlKCdudWNsaWRlLWNvbW1vbnMnKTtcbnZhciB7ZmlsZVNlYXJjaEZvckRpcmVjdG9yeX0gPSByZXF1aXJlKCdudWNsaWRlLXBhdGgtc2VhcmNoJyk7XG52YXIgcmVtb3RlVXJpID0gcmVxdWlyZSgnbnVjbGlkZS1yZW1vdGUtdXJpJyk7XG5cbnZhciBwcm92aWRlcnM7XG5cbi8qXG4gKiBUT0RPKHdpbGxpYW1zYyk6IFRoaXMgbmVlZHMgdG8gaGF2ZSBzb21lIGJldHRlclxuICogICAgICAgICAgICAgICAgICBtYW5hZ21lbnQgdG9vbHMgKEFkZGluZy9yZW1vdmluZyBxdWVyeSBzZXRzKS5cbiAqL1xuXG4vLyBDYWNoZSBvZiBwcmV2aW91c2x5IGluZGV4ZWQgZm9sZGVycyBmb3IgbGF0ZXIgdXNlLlxudmFyIGZpbGVTZWFyY2hlcnM6IGFueSA9IHt9O1xuXG4vLyBUT0RPIChtaWtlbyk6IE1ha2UgdGhpcyBhbm90aGVyIHNlYXJjaCBwcm92aWRlclxuYXN5bmMgZnVuY3Rpb24gZG9TZWFyY2hEaXJlY3RvcnkoZGlyZWN0b3J5VXJpOiBzdHJpbmcsIHF1ZXJ5OiBzdHJpbmcpOiBQcm9taXNlPEFycmF5PEZpbGVTZWFyY2hSZXN1bHQ+PiB7XG4gIHZhciBzZWFyY2ggPSBmaWxlU2VhcmNoZXJzW2RpcmVjdG9yeVVyaV07XG4gIGlmIChzZWFyY2ggPT09IHVuZGVmaW5lZCkge1xuICAgIHZhciBkaXJlY3RvcnkgPSByZW1vdGVVcmkucGFyc2UoZGlyZWN0b3J5VXJpKS5wYXRoO1xuXG4gICAgdmFyIGV4aXN0cyA9IGF3YWl0IGZzUHJvbWlzZS5leGlzdHMoZGlyZWN0b3J5KTtcbiAgICBpZiAoIWV4aXN0cykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDb3VsZCBub3QgZmluZCBkaXJlY3RvcnkgdG8gc2VhcmNoIDogJyArIGRpcmVjdG9yeSk7XG4gICAgfVxuXG4gICAgdmFyIHN0YXQgPSBhd2FpdCBmc1Byb21pc2Uuc3RhdChkaXJlY3RvcnkpO1xuICAgIGlmICghc3RhdC5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1Byb3ZpZGVkIHBhdGggaXMgbm90IGEgZGlyZWN0b3J5IDogJyArIGRpcmVjdG9yeSk7XG4gICAgfVxuXG4gICAgc2VhcmNoID0gYXdhaXQgZmlsZVNlYXJjaEZvckRpcmVjdG9yeShkaXJlY3RvcnlVcmkpO1xuICAgIGZpbGVTZWFyY2hlcnNbZGlyZWN0b3J5VXJpXSA9IHNlYXJjaDtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCBzZWFyY2gucXVlcnkocXVlcnkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRTZWFyY2hQcm92aWRlcnMoY3dkOiBzdHJpbmcpOiBQcm9taXNlPEFycmF5PFByb3ZpZGVySW5mbz4+IHtcbiAgdmFyIHZhbGlkUHJvbWlzZXMgPSBbXTtcblxuICBhc3luYyBmdW5jdGlvbiBjaGVja0F2YWlsYWJpbGl0eShwcm92aWRlck5hbWUpIHtcbiAgICB2YXIgaXNBdmFpbGFibGUgPSBhd2FpdCBwcm92aWRlcnNbcHJvdmlkZXJOYW1lXS5pc0F2YWlsYWJsZShjd2QpO1xuICAgIHJldHVybiBpc0F2YWlsYWJsZSA/IHtuYW1lOiBwcm92aWRlck5hbWV9IDogbnVsbDtcbiAgfVxuXG4gIGZvciAodmFyIG5hbWUgaW4gcHJvdmlkZXJzKSB7XG4gICAgdmFsaWRQcm9taXNlcy5wdXNoKGNoZWNrQXZhaWxhYmlsaXR5KG5hbWUpKTtcbiAgfVxuXG4gIHZhciByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGwodmFsaWRQcm9taXNlcyk7XG4gIHJldHVybiByZXN1bHRzLmZpbHRlcigocHJvdmlkZXIpID0+ICEhcHJvdmlkZXIpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBkb1NlYXJjaFF1ZXJ5KGN3ZDogc3RyaW5nLCBwcm92aWRlcjogc3RyaW5nLCBxdWVyeTogc3RyaW5nKTogUHJvbWlzZTxTZWFyY2hSZXNwb25zZT4ge1xuICB2YXIgY3VycmVudFByb3ZpZGVyID0gcHJvdmlkZXJzW3Byb3ZpZGVyXTtcbiAgaWYgKCFjdXJyZW50UHJvdmlkZXIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcHJvdmlkZXI6ICR7cHJvdmlkZXJ9YCk7XG4gIH1cbiAgdmFyIHJlc3VsdHMgPSBhd2FpdCBjdXJyZW50UHJvdmlkZXIucXVlcnkoY3dkLCBxdWVyeSk7XG4gIHJldHVybiB7cmVzdWx0c307XG59XG5cbmZ1bmN0aW9uIGFkZFByb3ZpZGVyKG5hbWU6IHN0cmluZywgcHJvdmlkZXIpIHtcbiAgcHJvdmlkZXJzID0gcHJvdmlkZXJzIHx8IHt9O1xuICBpZiAocHJvdmlkZXJzW25hbWVdKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGAke25hbWV9IGhhcyBhbHJlYWR5IGJlZW4gYWRkZWQgYXMgYSBwcm92aWRlci5gKTtcbiAgfVxuICBwcm92aWRlcnNbbmFtZV0gPSBwcm92aWRlcjtcbn1cblxuZnVuY3Rpb24gY2xlYXJQcm92aWRlcnMoKSB7XG4gIHByb3ZpZGVycyA9IHVuZGVmaW5lZDtcbn1cblxuZnVuY3Rpb24gaW5pdGlhbGl6ZShzZXJ2ZXIpIHtcbiAgdmFyIEhhY2tQcm92aWRlciA9IHJlcXVpcmUoJy4vc2VhcmNoL0hhY2tQcm92aWRlcicpO1xuICBhZGRQcm92aWRlcignaGFjaycsIG5ldyBIYWNrUHJvdmlkZXIoc2VydmVyKSk7XG5cbiAgdmFyIEJpZ0dyZXBQcm92aWRlcjtcbiAgdHJ5IHtcbiAgICBCaWdHcmVwUHJvdmlkZXIgPSByZXF1aXJlKCcuL3NlYXJjaC9mYi9CaWdHcmVwUHJvdmlkZXInKTtcbiAgfSBjYXRjaCAoZSkge1xuICB9XG4gIGlmIChCaWdHcmVwUHJvdmlkZXIpIHtcbiAgICBhZGRQcm92aWRlcignYmlnZ3JlcCcsIG5ldyBCaWdHcmVwUHJvdmlkZXIoc2VydmVyKSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gc2h1dGRvd24oc2VydmVyKSB7XG4gIGNsZWFyUHJvdmlkZXJzKCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBpbml0aWFsaXplLFxuICBzaHV0ZG93bixcbiAgYWRkUHJvdmlkZXIsXG4gIGNsZWFyUHJvdmlkZXJzLFxuICBzZXJ2aWNlczoge1xuICAgICcvc2VhcmNoL3F1ZXJ5Jzoge2hhbmRsZXI6IGRvU2VhcmNoUXVlcnksIG1ldGhvZDogJ3Bvc3QnfSxcbiAgICAnL3NlYXJjaC9saXN0UHJvdmlkZXJzJzoge2hhbmRsZXI6IGdldFNlYXJjaFByb3ZpZGVycywgbWV0aG9kOiAncG9zdCd9LFxuICAgICcvc2VhcmNoL2RpcmVjdG9yeSc6IHtoYW5kbGVyOiBkb1NlYXJjaERpcmVjdG9yeX0sXG4gIH0sXG59O1xuIl19
