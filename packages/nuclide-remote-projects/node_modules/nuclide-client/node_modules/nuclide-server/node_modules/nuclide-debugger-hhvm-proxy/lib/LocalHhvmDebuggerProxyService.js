
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

var _get = function get(_x, _x2, _x3) { var _again = true; _function: while (_again) { var object = _x, property = _x2, receiver = _x3; desc = parent = getter = undefined; _again = false; if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { _x = parent; _x2 = property; _x3 = receiver; _again = true; continue _function; } } else if ('value' in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } } };

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

function _inherits(subClass, superClass) { if (typeof superClass !== 'function' && superClass !== null) { throw new TypeError('Super expression must either be null or a function, not ' + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var _require = require('./utils');

var log = _require.log;
var logError = _require.logError;

var _require2 = require('./connect');

var DbgpConnector = _require2.DbgpConnector;

// Connection states
var INITIAL = 'initial';
var CONNECTING = 'connecting';
var CONNECTED = 'connected';
var CLOSED = 'closed';
var ERROR = 'error';

var HhvmDebuggerProxyService = require('./HhvmDebuggerProxyService');

var NOTIFY_EVENT = 'notify';
var SESSION_END_EVENT = 'session-end';

/**
 * Proxy for converting between Chrome dev tools debugger
 * and HHVM Dbgp debuggee.
 *
 * Chrome Debugging protocol spec is here:
 * https://developer.chrome.com/devtools/docs/protocol/1.1/index
 *
 * Dbgp spec is here:
 * http://xdebug.org/docs-dbgp.php
 *
 * Usage:
 *    After construction, call onNotify() with a callback to receive Chrome
 *    Notifications.
 *    Call attach() to attach to the dbgp debuggee.
 *    After the promise returned by attach() is resolved, call sendCommand()
 *    to send Chrome Commands, and be prepared to receive notifications on the
 *    callback registered with onNotify().
 */

var LocalHhvmDebuggerProxyService = (function (_HhvmDebuggerProxyService) {
  _inherits(LocalHhvmDebuggerProxyService, _HhvmDebuggerProxyService);

  function LocalHhvmDebuggerProxyService() {
    _classCallCheck(this, LocalHhvmDebuggerProxyService);

    _get(Object.getPrototypeOf(LocalHhvmDebuggerProxyService.prototype), 'constructor', this).call(this);

    this._state = INITIAL;
    this._connector = null;
    this._translator = null;

    var _require3 = require("events");

    var EventEmitter = _require3.EventEmitter;

    this._emitter = new EventEmitter();
  }

  _createClass(LocalHhvmDebuggerProxyService, [{
    key: 'onNotify',
    value: function onNotify(callback) {
      return this._addListener(NOTIFY_EVENT, callback);
    }
  }, {
    key: 'onSessionEnd',
    value: function onSessionEnd(callback) {
      return this._addListener(SESSION_END_EVENT, callback);
    }
  }, {
    key: '_addListener',
    value: function _addListener(eventName, callback) {
      var _this = this;

      this._emitter.addListener(eventName, callback);
      return {
        dispose: function dispose() {
          return _this._emitter.removeListener(eventName, callback);
        }
      };
    }
  }, {
    key: 'attach',
    value: _asyncToGenerator(function* (config) {
      var _this2 = this;

      log('Connecting config: ' + JSON.stringify(config));

      this._setState(CONNECTING);

      var connector = new DbgpConnector(config);
      this._connector = connector;
      var socket = yield connector.attach();
      socket.on('end', this._onEnd.bind(this));
      socket.on('error', this._onError.bind(this));

      var _require4 = require('./MessageTranslator');

      var MessageTranslator = _require4.MessageTranslator;

      this._translator = new MessageTranslator(socket, function (message) {
        return _this2._emitter.emit(NOTIFY_EVENT, message);
      });
      this._translator.onSessionEnd(this._onEnd.bind(this));

      this._setState(CONNECTED);

      return 'HHVM connected';
    })
  }, {
    key: 'sendCommand',
    value: function sendCommand(message) {
      log('Recieved command: ' + message);
      if (this._translator) {
        this._translator.handleCommand(message);
      }
    }
  }, {
    key: '_onEnd',
    value: function _onEnd() {
      this._setState(CLOSED);
    }
  }, {
    key: '_onError',
    value: function _onError(error) {
      this._setState(ERROR);
      log('connection error ' + error.code);
    }
  }, {
    key: '_setState',
    value: function _setState(newState) {
      log('state change from ' + this._state + ' to ' + newState);
      // TODO: Consider logging socket info: remote ip, etc.
      this._state = newState;

      if (this._state === ERROR || this._state === CLOSED) {
        this.dispose();
      }
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      log('Proxy: Ending session');
      this._emitter.emit(SESSION_END_EVENT);
      this._emitter.removeAllListeners(SESSION_END_EVENT);

      if (this._translator) {
        this._translator.dispose();
        this._translator = null;
      }
      if (this._connector) {
        this._connector.dispose();
        this._connector = null;
      }
    }
  }]);

  return LocalHhvmDebuggerProxyService;
})(HhvmDebuggerProxyService);

module.exports = LocalHhvmDebuggerProxyService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL0xvY2FsSGh2bURlYnVnZ2VyUHJveHlTZXJ2aWNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7ZUFZWSxPQUFPLENBQUMsU0FBUyxDQUFDOztJQUFuQyxHQUFHLFlBQUgsR0FBRztJQUFFLFFBQVEsWUFBUixRQUFROztnQkFDSSxPQUFPLENBQUMsV0FBVyxDQUFDOztJQUFyQyxhQUFhLGFBQWIsYUFBYTs7O0FBR3BCLElBQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQztBQUMxQixJQUFNLFVBQVUsR0FBRyxZQUFZLENBQUM7QUFDaEMsSUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDO0FBQzlCLElBQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQztBQUN4QixJQUFNLEtBQUssR0FBRyxPQUFPLENBQUM7O0FBRXRCLElBQU0sd0JBQXdCLEdBQUcsT0FBTyxDQUFDLDRCQUE0QixDQUFDLENBQUM7O0FBRXZFLElBQU0sWUFBWSxHQUFHLFFBQVEsQ0FBQztBQUM5QixJQUFNLGlCQUFpQixHQUFHLGFBQWEsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBb0JsQyw2QkFBNkI7WUFBN0IsNkJBQTZCOztBQU10QixXQU5QLDZCQUE2QixHQU1uQjswQkFOViw2QkFBNkI7O0FBTy9CLCtCQVBFLDZCQUE2Qiw2Q0FPdkI7O0FBRVIsUUFBSSxDQUFDLE1BQU0sR0FBRyxPQUFPLENBQUM7QUFDdEIsUUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLENBQUM7QUFDdkIsUUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7O29CQUNILE9BQU8sQ0FBQyxRQUFRLENBQUM7O1FBQWpDLFlBQVksYUFBWixZQUFZOztBQUNqQixRQUFJLENB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QUNGOzs7V0FFTSxtQkFBUztBQUNkLFNBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO0FBQzdCLFVBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUE7QUFDckMsVUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxpQkFBaUIsQ0FBQyxDQUFBOztBQUVuRCxVQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7QUFDcEIsWUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUMzQixZQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztPQUN6QjtBQUNELFVBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtBQUNuQixZQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQzFCLFlBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO09BQ3hCO0tBQ0Y7OztTQTFGRyw2QkFBNkI7R0FBUyx3QkFBd0I7O0FBNkZwRSxNQUFNLENBQUMsT0FBTyxHQUFHLDZCQUE2QixDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL0xvY2FsSGh2bURlYnVnZ2VyUHJveHlTZXJ2aWNlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuXG5jb25zdCB7bG9nLCBsb2dFcnJvcn0gPSByZXF1aXJlKCcuL3V0aWxzJyk7XG5jb25zdCB7RGJncENvbm5lY3Rvcn0gPSByZXF1aXJlKCcuL2Nvbm5lY3QnKTtcblxuLy8gQ29ubmVjdGlvbiBzdGF0ZXNcbmNvbnN0IElOSVRJQUwgPSAnaW5pdGlhbCc7XG5jb25zdCBDT05ORUNUSU5HID0gJ2Nvbm5lY3RpbmcnO1xuY29uc3QgQ09OTkVDVEVEID0gJ2Nvbm5lY3RlZCc7XG5jb25zdCBDTE9TRUQgPSAnY2xvc2VkJztcbmNvbnN0IEVSUk9SID0gJ2Vycm9yJztcblxuY29uc3QgSGh2bURlYnVnZ2VyUHJveHlTZXJ2aWNlID0gcmVxdWlyZSgnLi9IaHZtRGVidWdnZXJQcm94eVNlcnZpY2UnKTtcblxuY29uc3QgTk9USUZZX0VWRU5UID0gJ25vdGlmeSc7XG5jb25zdCBTRVNTSU9OX0VORF9FVkVOVCA9ICdzZXNzaW9uLWVuZCc7XG5cbi8qKlxuICogUHJveHkgZm9yIGNvbnZlcnRpbmcgYmV0d2VlbiBDaHJvbWUgZGV2IHRvb2xzIGRlYnVnZ2VyXG4gKiBhbmQgSEhWTSBEYmdwIGRlYnVnZ2VlLlxuICpcbiAqIENocm9tZSBEZWJ1Z2dpbmcgcHJvdG9jb2wgc3BlYyBpcyBoZXJlOlxuICogaHR0cHM6Ly9kZXZlbG9wZXIuY2hyb21lLmNvbS9kZXZ0b29scy9kb2NzL3Byb3RvY29sLzEuMS9pbmRleFxuICpcbiAqIERiZ3Agc3BlYyBpcyBoZXJlOlxuICogaHR0cDovL3hkZWJ1Zy5vcmcvZG9jcy1kYmdwLnBocFxuICpcbiAqIFVzYWdlOlxuICogICAgQWZ0ZXIgY29uc3RydWN0aW9uLCBjYWxsIG9uTm90aWZ5KCkgd2l0aCBhIGNhbGxiYWNrIHRvIHJlY2VpdmUgQ2hyb21lXG4gKiAgICBOb3RpZmljYXRpb25zLlxuICogICAgQ2FsbCBhdHRhY2goKSB0byBhdHRhY2ggdG8gdGhlIGRiZ3AgZGVidWdnZWUuXG4gKiAgICBBZnRlciB0aGUgcHJvbWlzZSByZXR1cm5lZCBieSBhdHRhY2goKSBpcyByZXNvbHZlZCwgY2FsbCBzZW5kQ29tbWFuZCgpXG4gKiAgICB0byBzZW5kIENocm9tZSBDb21tYW5kcywgYW5kIGJlIHByZXBhcmVkIHRvIHJlY2VpdmUgbm90aWZpY2F0aW9ucyBvbiB0aGVcbiAqICAgIGNhbGxiYWNrIHJlZ2lzdGVyZWQgd2l0aCBvbk5vdGlmeSgpLlxuICovXG5jbGFzcyBMb2NhbEhodm1EZWJ1Z2dlclByb3h5U2VydmljZSBleHRlbmRzIEhodm1EZWJ1Z2dlclByb3h5U2VydmljZSB7XG4gIF9zdGF0ZTogc3RyaW5nO1xuICBfZW1pdHRlcjogRXZlbnRFbWl0dGVyO1xuICBfdHJhbnNsYXRvcjogP01lc3NhZ2VUcmFuc2xhdG9yO1xuICBfY29ubmVjdG9yOiA/RGJncENvbm5lY3RvcjtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5fc3RhdGUgPSBJTklUSUFMO1xuICAgIHRoaXMuX2Nvbm5lY3RvciA9IG51bGw7XG4gICAgdGhpcy5fdHJhbnNsYXRvciA9IG51bGw7XG4gICAgdmFyIHtFdmVudEVtaXR0ZXJ9ID0gcmVxdWlyZShcImV2ZW50c1wiKTtcbiAgICB0aGlzLl9lbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICB9XG5cbiAgb25Ob3RpZnkoY2FsbGJhY2s6IChtZXNzYWdlOiBzdHJpbmcpID0+IHZvaWQpOiBEaXNwb3NhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5fYWRkTGlzdGVuZXIoTk9USUZZX0VWRU5ULCBjYWxsYmFjayk7XG4gIH1cblxuICBvblNlc3Npb25FbmQoY2FsbGJhY2s6ICgpID0+IHZvaWQpOiBEaXNwb3NhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5fYWRkTGlzdGVuZXIoU0VTU0lPTl9FTkRfRVZFTlQsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIF9hZGRMaXN0ZW5lcihldmVudE5hbWU6IHN0cmluZywgY2FsbGJhY2s6IEZ1bmN0aW9uKTogRGlzcG9zYWJsZSB7XG4gICAgdGhpcy5fZW1pdHRlci5hZGRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgICByZXR1cm4ge1xuICAgICAgZGlzcG9zZTogKCkgPT4gdGhpcy5fZW1pdHRlci5yZW1vdmVMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrKSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgYXR0YWNoKGNvbmZpZzogQ29ubmVjdGlvbkNvbmZpZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgbG9nKCdDb25uZWN0aW5nIGNvbmZpZzogJyArIEpTT04uc3RyaW5naWZ5KGNvbmZpZykpO1xuXG4gICAgdGhpcy5fc2V0U3RhdGUoQ09OTkVDVElORyk7XG5cbiAgICB2YXIgY29ubmVjdG9yID0gIG5ldyBEYmdwQ29ubmVjdG9yKGNvbmZpZyk7XG4gICAgdGhpcy5fY29ubmVjdG9yID0gY29ubmVjdG9yO1xuICAgIHZhciBzb2NrZXQgPSBhd2FpdCBjb25uZWN0b3IuYXR0YWNoKCk7XG4gICAgc29ja2V0Lm9uKCdlbmQnLCB0aGlzLl9vbkVuZC5iaW5kKHRoaXMpKTtcbiAgICBzb2NrZXQub24oJ2Vycm9yJywgdGhpcy5fb25FcnJvci5iaW5kKHRoaXMpKTtcblxuICAgIHZhciB7TWVzc2FnZVRyYW5zbGF0b3J9ID0gcmVxdWlyZSgnLi9NZXNzYWdlVHJhbnNsYXRvcicpO1xuICAgIHRoaXMuX3RyYW5zbGF0b3IgPSBuZXcgTWVzc2FnZVRyYW5zbGF0b3Ioc29ja2V0LCBtZXNzYWdlID0+IHRoaXMuX2VtaXR0ZXIuZW1pdChOT1RJRllfRVZFTlQsIG1lc3NhZ2UpKTtcbiAgICB0aGlzLl90cmFuc2xhdG9yLm9uU2Vzc2lvbkVuZCh0aGlzLl9vbkVuZC5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuX3NldFN0YXRlKENPTk5FQ1RFRCk7XG5cbiAgICByZXR1cm4gJ0hIVk0gY29ubmVjdGVkJztcbiAgfVxuXG4gIHNlbmRDb21tYW5kKG1lc3NhZ2U6IHN0cmluZyk6IHZvaWQge1xuICAgIGxvZygnUmVjaWV2ZWQgY29tbWFuZDogJyArIG1lc3NhZ2UpO1xuICAgIGlmICh0aGlzLl90cmFuc2xhdG9yKSB7XG4gICAgICB0aGlzLl90cmFuc2xhdG9yLmhhbmRsZUNvbW1hbmQobWVzc2FnZSk7XG4gICAgfVxuICB9XG5cbiAgX29uRW5kKCk6IHZvaWQge1xuICAgIHRoaXMuX3NldFN0YXRlKENMT1NFRCk7XG4gIH1cblxuICBfb25FcnJvcihlcnJvcjogRXJyb3IpOiB2b2lkIHtcbiAgICB0aGlzLl9zZXRTdGF0ZShFUlJPUik7XG4gICAgbG9nKCdjb25uZWN0aW9uIGVycm9yICcgKyBlcnJvci5jb2RlKTtcbiAgfVxuXG4gIF9zZXRTdGF0ZShuZXdTdGF0ZTogc3RyaW5nKTogdm9pZCB7XG4gICAgbG9nKCdzdGF0ZSBjaGFuZ2UgZnJvbSAnICsgdGhpcy5fc3RhdGUgKyAnIHRvICcgKyBuZXdTdGF0ZSk7XG4gICAgLy8gVE9ETzogQ29uc2lkZXIgbG9nZ2luZyBzb2NrZXQgaW5mbzogcmVtb3RlIGlwLCBldGMuXG4gICAgdGhpcy5fc3RhdGUgPSBuZXdTdGF0ZTtcblxuICAgIGlmICh0aGlzLl9zdGF0ZSA9PT0gRVJST1IgfHwgdGhpcy5fc3RhdGUgPT09IENMT1NFRCkge1xuICAgICAgdGhpcy5kaXNwb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICBsb2coJ1Byb3h5OiBFbmRpbmcgc2Vzc2lvbicpO1xuICAgIHRoaXMuX2VtaXR0ZXIuZW1pdChTRVNTSU9OX0VORF9FVkVOVClcbiAgICB0aGlzLl9lbWl0dGVyLnJlbW92ZUFsbExpc3RlbmVycyhTRVNTSU9OX0VORF9FVkVOVClcblxuICAgIGlmICh0aGlzLl90cmFuc2xhdG9yKSB7XG4gICAgICB0aGlzLl90cmFuc2xhdG9yLmRpc3Bvc2UoKTtcbiAgICAgIHRoaXMuX3RyYW5zbGF0b3IgPSBudWxsO1xuICAgIH1cbiAgICBpZiAodGhpcy5fY29ubmVjdG9yKSB7XG4gICAgICB0aGlzLl9jb25uZWN0b3IuZGlzcG9zZSgpO1xuICAgICAgdGhpcy5fY29ubmVjdG9yID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSBMb2NhbEhodm1EZWJ1Z2dlclByb3h5U2VydmljZTtcbiJdfQ==
