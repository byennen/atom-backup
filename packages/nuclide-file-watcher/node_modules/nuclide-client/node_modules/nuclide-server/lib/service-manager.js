
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var logger = require('nuclide-logging').getLogger();

// A cache stores services in form of '$serviceName@$cwd' => $serviceObject.
var cachedServices = new Map();

function optionsToString(options) {
  if (!options) {
    return '';
  } else if (options instanceof Array) {
    return '[' + options.map(function (item) {
      return optionsToString(item);
    }).join(', ') + ']';
  } else if (options instanceof Object) {
    var keys = Object.keys(options).sort();
    return '{' + keys.map(function (key) {
      return key + ': ' + optionsToString(options[key]);
    }).join(', ') + '}';
  } else if (typeof options === 'number' || typeof options === 'boolean' || typeof options === 'string') {
    return JSON.stringify(options);
  } else {
    throw Error('Can\'t stringify %o', options);
  }
}

/**
 * Create a new or retrieve a cached service instance by serviceName and service options.
 */
function getService(serviceName, options, localImplementationClassPath) {
  var key = serviceName + '@' + optionsToString(options);
  if (!cachedServices.has(key)) {
    logger.debug('Create service instance: ' + key);
    var serviceInstance = createLocalService(serviceName, localImplementationClassPath, options);
    cachedServices.set(key, serviceInstance);
  }
  return cachedServices.get(key);
}

function createLocalService(serviceName, localImplementationClassPath, options) {
  var serviceModule = require(localImplementationClassPath);
  var serviceClass = serviceModule[serviceName] || serviceModule;
  return new serviceClass(options);
}

function getRemoteEventName(serviceName, eventMethodName, serviceOptions) {
  return getLocalEventName(serviceName, eventMethodName) + '@' + optionsToString(serviceOptions);
}

function getLocalEventName(serviceName, eventMethodName) {
  return serviceName + '/' + eventMethodName;
}

module.exports = {
  getService: getService,
  getRemoteEventName: getRemoteEventName,
  optionsToString: optionsToString
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZS1tYW5hZ2VyLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7OztBQVdaLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDOzs7QUFHcEQsSUFBSSxjQUFnQyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7O0FBRWpELFNBQVMsZUFBZSxDQUFDLE9BQWEsRUFBVTtBQUM5QyxNQUFJLENBQUMsT0FBTyxFQUFFO0FBQ1osV0FBTyxFQUFFLENBQUM7R0FDWCxNQUFNLElBQUksT0FBTyxZQUFZLEtBQUssRUFBRTtBQUNuQyxXQUFPLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSTthQUFJLGVBQWUsQ0FBQyxJQUFJLENBQUM7S0FBQSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztHQUMxRSxNQUFNLElBQUksT0FBTyxZQUFZLE1BQU0sRUFBRTtBQUNwQyxRQUFJLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO0FBQ3ZDLFdBQU8sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsVUFBQSxHQUFHO2FBQUksR0FBRyxHQUFHLElBQUksR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0tBQUEsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUM7R0FDM0YsTUFBTSxJQUFJLE9BQU8sT0FBTyxLQUFLLFFBQVEsSUFBSSxPQUFPLE9BQU8sS0FBSyxTQUFTLElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO0FBQ3JHLFdBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztHQUNoQyxNQUFNO0FBQ0wsVUFBTSxLQUFLLENBQUMscUJBQXFCLEVBQUUsT0FBTyxDQUFDLENBQUM7R0FDN0M7Q0FDRjs7Ozs7QUFLRCxTQUFTLFVBQVUsQ0FBQyxXQUFtQixFQUFFLE9BQVksRUFBRSw0QkFBb0MsRUFBTztBQUNoRyxNQUFJLEdBQUcsR0FBRyxXQUFXLEdBQUcsR0FBRyxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN2RCxNQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtBQUM1QixVQUFNLENBQUMsS0FBSywrQkFBNkIsR0FBRyxDQUFHLENBQUM7QUFDaEQsUUFBSSxlQUFlLEdBQUcsa0JBQWtCLENBQUMsV0FBVyxFQUFFLDRCQUE0QixFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBQzdGLGtCQUFjLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxlQUFlLENBQUMsQ0FBQztHQUMxQztBQUNELFNBQU8sY0FBYyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUNoQzs7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFdBQW1CLEVBQUUsNEJBQW9DLEVBQUUsT0FBWSxFQUFPO0FBQ3hHLE1BQUksYUFBYSxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQzFELE1BQUksWUFBWSxHQUFHLGFBQWEsQ0FBQyxXQUFXLENBQUMsSUFBSSxhQUFhLENBQUM7QUFDL0QsU0FBTyxJQUFJLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztDQUNsQzs7QUFFRCxTQUFTLGtCQUFrQixDQUFDLFdBQW1CLEVBQUUsZUFBdUIsRUFBRSxjQUFtQixFQUFVO0FBQ3JHLFNBQU8saUJBQWlCLENBQUMsV0FBVyxFQUFFLGVBQWUsQ0FBQyxHQUFHLEdBQUcsR0FBRyxlQUFlLENBQUMsY0FBYyxDQUFDLENBQUM7Q0FDaEc7O0FBRUQsU0FBUyxpQkFBaUIsQ0FBQyxXQUFtQixFQUFFLGVBQXVCLEVBQVU7QUFDL0UsU0FBTyxXQUFXLEdBQUcsR0FBRyxHQUFHLGVBQWUsQ0FBQztDQUM1Qzs7QUFFRCxNQUFNLENBQUMsT0FBTyxHQUFHO0FBQ2YsWUFBVSxFQUFWLFVBQVU7QUFDVixvQkFBa0IsRUFBbEIsa0JBQWtCO0FBQ2xCLGlCQUFlLEVBQWYsZUFBZTtDQUNoQixDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXNlcnZlci9saWIvc2VydmljZS1tYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxudmFyIGxvZ2dlciA9IHJlcXVpcmUoJ251Y2xpZGUtbG9nZ2luZycpLmdldExvZ2dlcigpO1xuXG4vLyBBIGNhY2hlIHN0b3JlcyBzZXJ2aWNlcyBpbiBmb3JtIG9mICckc2VydmljZU5hbWVAJGN3ZCcgPT4gJHNlcnZpY2VPYmplY3QuXG52YXIgY2FjaGVkU2VydmljZXM6IE1hcDxzdHJpbmcsIGFueT4gPSBuZXcgTWFwKCk7XG5cbmZ1bmN0aW9uIG9wdGlvbnNUb1N0cmluZyhvcHRpb25zOiA/YW55KTogc3RyaW5nIHtcbiAgaWYgKCFvcHRpb25zKSB7XG4gICAgcmV0dXJuICcnO1xuICB9IGVsc2UgaWYgKG9wdGlvbnMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgIHJldHVybiAnWycgKyBvcHRpb25zLm1hcChpdGVtID0+IG9wdGlvbnNUb1N0cmluZyhpdGVtKSkuam9pbignLCAnKSArICddJztcbiAgfSBlbHNlIGlmIChvcHRpb25zIGluc3RhbmNlb2YgT2JqZWN0KSB7XG4gICAgdmFyIGtleXMgPSBPYmplY3Qua2V5cyhvcHRpb25zKS5zb3J0KCk7XG4gICAgcmV0dXJuICd7JyArIGtleXMubWFwKGtleSA9PiBrZXkgKyAnOiAnICsgb3B0aW9uc1RvU3RyaW5nKG9wdGlvbnNba2V5XSkpLmpvaW4oJywgJykgKyAnfSc7XG4gIH0gZWxzZSBpZiAodHlwZW9mIG9wdGlvbnMgPT09ICdudW1iZXInIHx8IHR5cGVvZiBvcHRpb25zID09PSAnYm9vbGVhbicgfHwgdHlwZW9mIG9wdGlvbnMgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9wdGlvbnMpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IEVycm9yKCdDYW5cXCd0IHN0cmluZ2lmeSAlbycsIG9wdGlvbnMpO1xuICB9XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgbmV3IG9yIHJldHJpZXZlIGEgY2FjaGVkIHNlcnZpY2UgaW5zdGFuY2UgYnkgc2VydmljZU5hbWUgYW5kIHNlcnZpY2Ugb3B0aW9ucy5cbiAqL1xuZnVuY3Rpb24gZ2V0U2VydmljZShzZXJ2aWNlTmFtZTogc3RyaW5nLCBvcHRpb25zOiBhbnksIGxvY2FsSW1wbGVtZW50YXRpb25DbGFzc1BhdGg6IHN0cmluZyk6IGFueSB7XG4gIHZhciBrZXkgPSBzZXJ2aWNlTmFtZSArICdAJyArIG9wdGlvbnNUb1N0cmluZyhvcHRpb25zKTtcbiAgaWYgKCFjYWNoZWRTZXJ2aWNlcy5oYXMoa2V5KSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgQ3JlYXRlIHNlcnZpY2UgaW5zdGFuY2U6ICR7a2V5fWApO1xuICAgIHZhciBzZXJ2aWNlSW5zdGFuY2UgPSBjcmVhdGVMb2NhbFNlcnZpY2Uoc2VydmljZU5hbWUsIGxvY2FsSW1wbGVtZW50YXRpb25DbGFzc1BhdGgsIG9wdGlvbnMpO1xuICAgIGNhY2hlZFNlcnZpY2VzLnNldChrZXksIHNlcnZpY2VJbnN0YW5jZSk7XG4gIH1cbiAgcmV0dXJuIGNhY2hlZFNlcnZpY2VzLmdldChrZXkpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVMb2NhbFNlcnZpY2Uoc2VydmljZU5hbWU6IHN0cmluZywgbG9jYWxJbXBsZW1lbnRhdGlvbkNsYXNzUGF0aDogc3RyaW5nLCBvcHRpb25zOiBhbnkpOiBhbnkge1xuICB2YXIgc2VydmljZU1vZHVsZSA9IHJlcXVpcmUobG9jYWxJbXBsZW1lbnRhdGlvbkNsYXNzUGF0aCk7XG4gIHZhciBzZXJ2aWNlQ2xhc3MgPSBzZXJ2aWNlTW9kdWxlW3NlcnZpY2VOYW1lXSB8fCBzZXJ2aWNlTW9kdWxlO1xuICByZXR1cm4gbmV3IHNlcnZpY2VDbGFzcyhvcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gZ2V0UmVtb3RlRXZlbnROYW1lKHNlcnZpY2VOYW1lOiBzdHJpbmcsIGV2ZW50TWV0aG9kTmFtZTogc3RyaW5nLCBzZXJ2aWNlT3B0aW9uczogYW55KTogc3RyaW5nIHtcbiAgcmV0dXJuIGdldExvY2FsRXZlbnROYW1lKHNlcnZpY2VOYW1lLCBldmVudE1ldGhvZE5hbWUpICsgJ0AnICsgb3B0aW9uc1RvU3RyaW5nKHNlcnZpY2VPcHRpb25zKTtcbn1cblxuZnVuY3Rpb24gZ2V0TG9jYWxFdmVudE5hbWUoc2VydmljZU5hbWU6IHN0cmluZywgZXZlbnRNZXRob2ROYW1lOiBzdHJpbmcpOiBzdHJpbmcge1xuICByZXR1cm4gc2VydmljZU5hbWUgKyAnLycgKyBldmVudE1ldGhvZE5hbWU7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBnZXRTZXJ2aWNlLFxuICBnZXRSZW1vdGVFdmVudE5hbWUsXG4gIG9wdGlvbnNUb1N0cmluZyxcbn07XG4iXX0=
