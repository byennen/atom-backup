var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

var _get = function get(_x, _x2, _x3) { var _again = true; _function: while (_again) { var object = _x, property = _x2, receiver = _x3; desc = parent = getter = undefined; _again = false; if (object === null) object = Function.prototype; var desc = Object.getOwnPropertyDescriptor(object, property); if (desc === undefined) { var parent = Object.getPrototypeOf(object); if (parent === null) { return undefined; } else { _x = parent; _x2 = property; _x3 = receiver; _again = true; continue _function; } } else if ('value' in desc) { return desc.value; } else { var getter = desc.get; if (getter === undefined) { return undefined; } return getter.call(receiver); } } };

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

function _inherits(subClass, superClass) { if (typeof superClass !== 'function' && superClass !== null) { throw new TypeError('Super expression must either be null or a function, not ' + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

'use babel';

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */
/* @providesModule LocalHgServiceBase */

var _require = require('events');

var EventEmitter = _require.EventEmitter;

var HgService = require('./HgService');

var _require2 = require('./hg-constants');

var HgStatusOption = _require2.HgStatusOption;

var _require3 = require('./hg-output-helpers');

var parseHgDiffUnifiedOutput = _require3.parseHgDiffUnifiedOutput;

var _require4 = require('./hg-revision-expression-helpers');

var _fetchCommonAncestorOfHeadAndRevision = _require4.fetchCommonAncestorOfHeadAndRevision;
var _fetchRevisionNumbersBetweenRevisions = _require4.fetchRevisionNumbersBetweenRevisions;

var _require5 = require('./hg-revision-state-helpers');

var _fetchFileContentAtRevision = _require5.fetchFileContentAtRevision;
var _fetchFilesChangedAtRevision = _require5.fetchFilesChangedAtRevision;

var _require6 = require('nuclide-commons');

var asyncExecute = _require6.asyncExecute;

var path = require('path');

var isOsX = require('os').platform() === 'darwin';

var LocalHgServiceBase = (function (_HgService) {
  _inherits(LocalHgServiceBase, _HgService);

  function LocalHgServiceBase(options) {
    _classCallCheck(this, LocalHgServiceBase);

    _get(Object.getPrototypeOf(LocalHgServiceBase.prototype), 'constructor', this).call(this);
    this._emitter = new EventEmitter();
    this._workingDirectory = options.workingDirectory;
  }

  _createClass(LocalHgServiceBase, [{
    key: 'destroy',
    value: function destroy() {
      this._emitter.removeAllListeners();
      this._emitter = null;
    }
  }, {
    key: 'getWorkingDirectory',
    value: function getWorkingDirectory() {
      return this._workingDirectory;
    }

    /**
     * See HgService::fetchStatuses for details.
     */
  }, {
    key: 'fetchStatuses',
    value: _asyncToGenerator(function* (filePaths, options) {
      var _this = this;

      var statusMap = {};

      var args = ['status', '-Tjson'];
      if (options && 'hgStatusOption' in options) {
        if (options.hgStatusOption === HgStatusOption.ONLY_IGNORED) {
          args.push('--ignored');
        } else if (options.hgStatusOption === HgStatusOption.ALL_STATUSES) {
          args.push('--all');
        }
      }
      args = args.concat(filePaths);
      var execOptions = {
        cwd: this.getWorkingDirectory()
      };
      try {
        var output = yield this._hgAsyncExecute(args, execOptions);
      } catch (e) {
        return statusMap;
      }

      var statuses = JSON.parse(output.stdout);
      statuses.forEach(function (status) {
        statusMap[_this._absolutize(status.path)] = status.status;
      });
      return statusMap;
    })

    // Mercurial returns all paths relative to the repository's working directory.
    // This method transforms a path relative to the working direcotry into an
    // absolute path.
  }, {
    key: '_absolutize',
    value: function _absolutize(pathRelativeToWorkingDirectory) {
      return path.join(this._workingDirectory, pathRelativeToWorkingDirectory);
    }

    /**
     * See HgService::onFilesDidChange for details.
     */
  }, {
    key: 'onFilesDidChange',
    value: function onFilesDidChange(callback) {
      var _this2 = this;

      this._emitter.on('files-changed', callback);
      return {
        dispose: function dispose() {
          _this2._removeOnFilesDidChangeListener(callback);
        }
      };
    }

    /**
     * Removes a listener that was registered on ::onFilesDidChange.
     * Note: Does not fire on changes to .hgignore files. Use ::onHgIgnoreFileDidChange
     * if you need to observe changes on these types of files.
     */
  }, {
    key: '_removeOnFilesDidChangeListener',
    value: function _removeOnFilesDidChangeListener(callback) {
      this._emitter.removeListener('files-changed', callback);
    }

    /**
     * See HgService::onHgIgnoreFileDidChange for details.
     */
  }, {
    key: 'onHgIgnoreFileDidChange',
    value: function onHgIgnoreFileDidChange(callback) {
      var _this3 = this;

      this._emitter.on('hg-ignore-changed', callback);
      return {
        dispose: function dispose() {
          _this3._removeOnHgIgnoreFileDidChangeListener(callback);
        }
      };
    }

    /**
     * Removes a listener that was registered on ::onHgIgnoreFileDidChange.
     */
  }, {
    key: '_removeOnHgIgnoreFileDidChangeListener',
    value: function _removeOnHgIgnoreFileDidChangeListener(callback) {
      this._emitter.removeListener('hg-ignore-changed', callback);
    }

    /**
     * See HgService::onHgRepoStateDidChange for details.
     */
  }, {
    key: 'onHgRepoStateDidChange',
    value: function onHgRepoStateDidChange(callback) {
      var _this4 = this;

      this._emitter.on('hg-repo-state-changed', callback);
      return {
        dispose: function dispose() {
          _this4._removeOnHgRepoStateDidChangeListener(callback);
        }
      };
    }

    /**
     * Removes a listener that was registered on ::onHgRepoStateDidChange.
     */
  }, {
    key: '_removeOnHgRepoStateDidChangeListener',
    value: function _removeOnHgRepoStateDidChangeListener(callback) {
      this._emitter.removeListener('hg-repo-state-changed', callback);
    }

    /**
     * See HgService::fetchDiffInfo for details.
     */
  }, {
    key: 'fetchDiffInfo',
    value: _asyncToGenerator(function* (filePath) {
      var args = ['diff', '--unified', '0', filePath];
      var options = {
        cwd: this.getWorkingDirectory()
      };
      try {
        var output = yield this._hgAsyncExecute(args, options);
      } catch (e) {
        return null;
      }
      return parseHgDiffUnifiedOutput(output.stdout);
    })

    /**
     * Calls out to asyncExecute using the 'hg' command.
     * @param options as specified by http://nodejs.org/api/child_process.html. Additional options:
     *   - NO_HGPLAIN set if the $HGPLAIN environment variable should not be used.
     *   - TTY_OUTPUT set if the command should be run as if it were attached to a tty.
     */
  }, {
    key: '_hgAsyncExecute',
    value: function _hgAsyncExecute(args, options) {
      if (!options['NO_HGPLAIN']) {
        // Setting HGPLAIN=1 overrides any custom aliases a user has defined.
        if (options.env) {
          options.env['HGPLAIN'] = 1;
        } else {
          var assign = require('nuclide-commons').object.assign;

          var env = { 'HGPLAIN': 1 };
          assign(env, process.env);
          options.env = env;
        }
      }

      var cmd;
      if (options['TTY_OUTPUT']) {
        cmd = 'script';
        if (isOsX) {
          // On OS X, script takes the program to run and its arguments as varargs at the end.
          args = ['-q', '/dev/null', 'hg'].concat(args);
        } else {
          // On Linux, script takes the command to run as the -c parameter.
          var hgCommand = ['hg'].concat(args).join(' ');
          args = ['-q', '/dev/null', '-c', hgCommand];
        }
      } else {
        cmd = 'hg';
      }
      return asyncExecute(cmd, args, options);
    }
  }, {
    key: 'fetchCurrentBookmark',
    value: function fetchCurrentBookmark() {
      var _require7 = require('./hg-bookmark-helpers');

      var fetchCurrentBookmark = _require7.fetchCurrentBookmark;

      return fetchCurrentBookmark(path.join(this._workingDirectory, '.hg'));
    }

    /**
     * See HgService::onHgBookmarkDidChange for details.
     */
  }, {
    key: 'onHgBookmarkDidChange',
    value: function onHgBookmarkDidChange(callback) {
      this._emitter.on('hg-bookmark-changed', callback);
      return {
        dispose: this._removeOnHgBookmarkDidChangeListener.bind(this, callback)
      };
    }
  }, {
    key: '_removeOnHgBookmarkDidChangeListener',
    value: function _removeOnHgBookmarkDidChangeListener(callback) {
      this._emitter.removeListener('hg-bookmark-changed', callback);
    }

    /**
     * Section: Repository State at Specific Revisions
     */

  }, {
    key: 'fetchFileContentAtRevision',
    value: function fetchFileContentAtRevision(filePath, revision) {
      return _fetchFileContentAtRevision(filePath, revision, this._workingDirectory);
    }
  }, {
    key: 'fetchFilesChangedAtRevision',
    value: function fetchFilesChangedAtRevision(revision) {
      return _fetchFilesChangedAtRevision(revision, this._workingDirectory);
    }
  }, {
    key: 'fetchCommonAncestorOfHeadAndRevision',
    value: function fetchCommonAncestorOfHeadAndRevision(revision) {
      return _fetchCommonAncestorOfHeadAndRevision(revision, this._workingDirectory);
    }
  }, {
    key: 'fetchRevisionNumbersBetweenRevisions',
    value: function fetchRevisionNumbersBetweenRevisions(revisionFrom, revisionTo) {
      return _fetchRevisionNumbersBetweenRevisions(revisionFrom, revisionTo, this._workingDirectory);
    }
  }, {
    key: 'getSmartlog',
    value: _asyncToGenerator(function* (ttyOutput, concise) {
      var args = [concise ? 'sl' : 'smartlog'];
      var execOptions = {
        cwd: this.getWorkingDirectory(),
        NO_HGPLAIN: concise, // `hg sl` is likely user-defined.
        TTY_OUTPUT: ttyOutput
      };
      return yield this._hgAsyncExecute(args, execOptions);
    })
  }, {
    key: 'checkout',
    value: _asyncToGenerator(function* (revision, create) {
      var options = {
        cwd: this.getWorkingDirectory()
      };
      try {
        yield this._hgAsyncExecute(['checkout', revision], options);
      } catch (e) {
        return false;
      }
      return true;
    })
  }]);

  return LocalHgServiceBase;
})(HgService);

module.exports = LocalHgServiceBase;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWhnLXJlcG9zaXRvcnktYmFzZS9saWIvTG9jYWxIZ1NlcnZpY2VCYXNlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7QUFBQSxXQUFXLENBQUM7Ozs7Ozs7Ozs7O2VBWVMsT0FBTyxDQUFDLFFBQVEsQ0FBQzs7SUFBakMsWUFBWSxZQUFaLFlBQVk7O0FBQ2pCLElBQUksU0FBUyxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQzs7Z0JBQ2hCLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQzs7SUFBM0MsY0FBYyxhQUFkLGNBQWM7O2dCQUNjLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQzs7SUFBMUQsd0JBQXdCLGFBQXhCLHdCQUF3Qjs7Z0JBRWUsT0FBTyxDQUFDLGtDQUFrQyxDQUFDOztJQURsRixxQ0FBb0MsYUFBcEMsb0NBQW9DO0lBQ3JDLHFDQUFvQyxhQUFwQyxvQ0FBb0M7O2dCQUN3QixPQUFPLENBQUMsNkJBQTZCLENBQUM7O0lBQWpHLDJCQUEwQixhQUExQiwwQkFBMEI7SUFBRSw0QkFBMkIsYUFBM0IsMkJBQTJCOztnQkFDdkMsT0FBTyxDQUFDLGlCQUFpQixDQUFDOztJQUExQyxZQUFZLGFBQVosWUFBWTs7QUFDakIsSUFBSSxJQUFJLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDOztBQUkzQixJQUFJLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxFQUFFLEtBQUssUUFBUSxDQUFDOztJQUU1QyxrQkFBa0I7WUFBbEIsa0JBQWtCOztBQUNYLFdBRFAsa0JBQWtCLENBQ1YsT0FBOEIsRUFBRTswQkFEeEMsa0JBQWtCOztBQUVwQiwrQkFGRSxrQkFBa0IsNkNBRVo7QUFDUixRQUFJLENBQUMsUUFBUSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7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QyxDQUFDLFVBQVUsRUFBRSxRQUFRLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztPQUM3RCxDQUFDLE9BQU8sQ0FBQyxFQUFFO0FBQ1YsZUFBTyxLQUFLLENBQUM7T0FDZDtBQUNELGFBQU8sSUFBSSxDQUFDO0tBQ2I7OztTQWpPRyxrQkFBa0I7R0FBUyxTQUFTOztBQXFPMUMsTUFBTSxDQUFDLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1oZy1yZXBvc2l0b3J5LWJhc2UvbGliL0xvY2FsSGdTZXJ2aWNlQmFzZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG4vKiBAcHJvdmlkZXNNb2R1bGUgTG9jYWxIZ1NlcnZpY2VCYXNlICovXG5cbnZhciB7RXZlbnRFbWl0dGVyfSA9IHJlcXVpcmUoJ2V2ZW50cycpO1xudmFyIEhnU2VydmljZSA9IHJlcXVpcmUoJy4vSGdTZXJ2aWNlJyk7XG52YXIge0hnU3RhdHVzT3B0aW9ufSA9IHJlcXVpcmUoJy4vaGctY29uc3RhbnRzJyk7XG52YXIge3BhcnNlSGdEaWZmVW5pZmllZE91dHB1dH0gPSByZXF1aXJlKCcuL2hnLW91dHB1dC1oZWxwZXJzJyk7XG52YXIge2ZldGNoQ29tbW9uQW5jZXN0b3JPZkhlYWRBbmRSZXZpc2lvbixcbiAgICBmZXRjaFJldmlzaW9uTnVtYmVyc0JldHdlZW5SZXZpc2lvbnN9ID0gcmVxdWlyZSgnLi9oZy1yZXZpc2lvbi1leHByZXNzaW9uLWhlbHBlcnMnKTtcbnZhciB7ZmV0Y2hGaWxlQ29udGVudEF0UmV2aXNpb24sIGZldGNoRmlsZXNDaGFuZ2VkQXRSZXZpc2lvbn0gPSByZXF1aXJlKCcuL2hnLXJldmlzaW9uLXN0YXRlLWhlbHBlcnMnKTtcbnZhciB7YXN5bmNFeGVjdXRlfSA9IHJlcXVpcmUoJ251Y2xpZGUtY29tbW9ucycpO1xudmFyIHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cbmltcG9ydCB0eXBlIExvY2FsSGdTZXJ2aWNlT3B0aW9ucyBmcm9tICcuL2hnLXR5cGVzJztcblxudmFyIGlzT3NYID0gcmVxdWlyZSgnb3MnKS5wbGF0Zm9ybSgpID09PSAnZGFyd2luJztcblxuY2xhc3MgTG9jYWxIZ1NlcnZpY2VCYXNlIGV4dGVuZHMgSGdTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3Iob3B0aW9uczogTG9jYWxIZ1NlcnZpY2VPcHRpb25zKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLl9lbWl0dGVyID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICAgIHRoaXMuX3dvcmtpbmdEaXJlY3RvcnkgPSBvcHRpb25zLndvcmtpbmdEaXJlY3Rvcnk7XG4gIH1cblxuICBkZXN0cm95KCkge1xuICAgIHRoaXMuX2VtaXR0ZXIucmVtb3ZlQWxsTGlzdGVuZXJzKCk7XG4gICAgdGhpcy5fZW1pdHRlciA9IG51bGw7XG4gIH1cblxuICBnZXRXb3JraW5nRGlyZWN0b3J5KCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX3dvcmtpbmdEaXJlY3Rvcnk7XG4gIH1cblxuICAvKipcbiAgICogU2VlIEhnU2VydmljZTo6ZmV0Y2hTdGF0dXNlcyBmb3IgZGV0YWlscy5cbiAgICovXG4gIGFzeW5jIGZldGNoU3RhdHVzZXMoZmlsZVBhdGhzOiBBcnJheTxzdHJpbmc+LCBvcHRpb25zOiA/YW55KTogUHJvbWlzZTx7W2tleTogc3RyaW5nXTogU3RhdHVzQ29kZUlkfT4ge1xuICAgIHZhciBzdGF0dXNNYXAgPSB7fTtcblxuICAgIHZhciBhcmdzID0gWydzdGF0dXMnLCAnLVRqc29uJ107XG4gICAgaWYgKG9wdGlvbnMgJiYgKCdoZ1N0YXR1c09wdGlvbicgaW4gb3B0aW9ucykpIHtcbiAgICAgIGlmIChvcHRpb25zLmhnU3RhdHVzT3B0aW9uID09PSBIZ1N0YXR1c09wdGlvbi5PTkxZX0lHTk9SRUQpIHtcbiAgICAgICAgYXJncy5wdXNoKCctLWlnbm9yZWQnKTtcbiAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5oZ1N0YXR1c09wdGlvbiA9PT0gSGdTdGF0dXNPcHRpb24uQUxMX1NUQVRVU0VTKSB7XG4gICAgICAgIGFyZ3MucHVzaCgnLS1hbGwnKTtcbiAgICAgIH1cbiAgICB9XG4gICAgYXJncyA9IGFyZ3MuY29uY2F0KGZpbGVQYXRocyk7XG4gICAgdmFyIGV4ZWNPcHRpb25zID0ge1xuICAgICAgY3dkOiB0aGlzLmdldFdvcmtpbmdEaXJlY3RvcnkoKSxcbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICB2YXIgb3V0cHV0ID0gYXdhaXQgdGhpcy5faGdBc3luY0V4ZWN1dGUoYXJncywgZXhlY09wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBzdGF0dXNNYXA7XG4gICAgfVxuXG4gICAgdmFyIHN0YXR1c2VzID0gSlNPTi5wYXJzZShvdXRwdXQuc3Rkb3V0KTtcbiAgICBzdGF0dXNlcy5mb3JFYWNoKChzdGF0dXMpID0+IHtcbiAgICAgIHN0YXR1c01hcFt0aGlzLl9hYnNvbHV0aXplKHN0YXR1cy5wYXRoKV0gPSBzdGF0dXMuc3RhdHVzO1xuICAgIH0pO1xuICAgIHJldHVybiBzdGF0dXNNYXA7XG4gIH1cblxuICAvLyBNZXJjdXJpYWwgcmV0dXJucyBhbGwgcGF0aHMgcmVsYXRpdmUgdG8gdGhlIHJlcG9zaXRvcnkncyB3b3JraW5nIGRpcmVjdG9yeS5cbiAgLy8gVGhpcyBtZXRob2QgdHJhbnNmb3JtcyBhIHBhdGggcmVsYXRpdmUgdG8gdGhlIHdvcmtpbmcgZGlyZWNvdHJ5IGludG8gYW5cbiAgLy8gYWJzb2x1dGUgcGF0aC5cbiAgX2Fic29sdXRpemUocGF0aFJlbGF0aXZlVG9Xb3JraW5nRGlyZWN0b3J5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBwYXRoLmpvaW4odGhpcy5fd29ya2luZ0RpcmVjdG9yeSwgcGF0aFJlbGF0aXZlVG9Xb3JraW5nRGlyZWN0b3J5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWUgSGdTZXJ2aWNlOjpvbkZpbGVzRGlkQ2hhbmdlIGZvciBkZXRhaWxzLlxuICAgKi9cbiAgb25GaWxlc0RpZENoYW5nZShjYWxsYmFjazogKGNoYW5nZWRGaWxlUGF0aHM6IEFycmF5PHN0cmluZz4pID0+IHZvaWQpOiBEaXNwb3NhYmxlIHtcbiAgICB0aGlzLl9lbWl0dGVyLm9uKCdmaWxlcy1jaGFuZ2VkJywgY2FsbGJhY2spO1xuICAgIHJldHVybiB7XG4gICAgICBkaXNwb3NlOiAoKSA9PiB7XG4gICAgICAgIHRoaXMuX3JlbW92ZU9uRmlsZXNEaWRDaGFuZ2VMaXN0ZW5lcihjYWxsYmFjayk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGEgbGlzdGVuZXIgdGhhdCB3YXMgcmVnaXN0ZXJlZCBvbiA6Om9uRmlsZXNEaWRDaGFuZ2UuXG4gICAqIE5vdGU6IERvZXMgbm90IGZpcmUgb24gY2hhbmdlcyB0byAuaGdpZ25vcmUgZmlsZXMuIFVzZSA6Om9uSGdJZ25vcmVGaWxlRGlkQ2hhbmdlXG4gICAqIGlmIHlvdSBuZWVkIHRvIG9ic2VydmUgY2hhbmdlcyBvbiB0aGVzZSB0eXBlcyBvZiBmaWxlcy5cbiAgICovXG4gIF9yZW1vdmVPbkZpbGVzRGlkQ2hhbmdlTGlzdGVuZXIoY2FsbGJhY2s6IChjaGFuZ2VkRmlsZVBhdGhzOiBBcnJheTxzdHJpbmc+KSA9PiB2b2lkKTogdm9pZCB7XG4gICAgdGhpcy5fZW1pdHRlci5yZW1vdmVMaXN0ZW5lcignZmlsZXMtY2hhbmdlZCcsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWUgSGdTZXJ2aWNlOjpvbkhnSWdub3JlRmlsZURpZENoYW5nZSBmb3IgZGV0YWlscy5cbiAgICovXG4gIG9uSGdJZ25vcmVGaWxlRGlkQ2hhbmdlKGNhbGxiYWNrOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZSB7XG4gICAgdGhpcy5fZW1pdHRlci5vbignaGctaWdub3JlLWNoYW5nZWQnLCBjYWxsYmFjayk7XG4gICAgcmV0dXJuIHtcbiAgICAgIGRpc3Bvc2U6ICgpID0+IHtcbiAgICAgICAgdGhpcy5fcmVtb3ZlT25IZ0lnbm9yZUZpbGVEaWRDaGFuZ2VMaXN0ZW5lcihjYWxsYmFjayk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmVzIGEgbGlzdGVuZXIgdGhhdCB3YXMgcmVnaXN0ZXJlZCBvbiA6Om9uSGdJZ25vcmVGaWxlRGlkQ2hhbmdlLlxuICAgKi9cbiAgX3JlbW92ZU9uSGdJZ25vcmVGaWxlRGlkQ2hhbmdlTGlzdGVuZXIoY2FsbGJhY2s6ICgpID0+IHZvaWQpOiB2b2lkIHtcbiAgICB0aGlzLl9lbWl0dGVyLnJlbW92ZUxpc3RlbmVyKCdoZy1pZ25vcmUtY2hhbmdlZCcsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWUgSGdTZXJ2aWNlOjpvbkhnUmVwb1N0YXRlRGlkQ2hhbmdlIGZvciBkZXRhaWxzLlxuICAgKi9cbiAgb25IZ1JlcG9TdGF0ZURpZENoYW5nZShjYWxsYmFjazogKCkgPT4gdm9pZCk6IERpc3Bvc2FibGUge1xuICAgIHRoaXMuX2VtaXR0ZXIub24oJ2hnLXJlcG8tc3RhdGUtY2hhbmdlZCcsIGNhbGxiYWNrKTtcbiAgICByZXR1cm4ge1xuICAgICAgZGlzcG9zZTogKCkgPT4ge1xuICAgICAgICB0aGlzLl9yZW1vdmVPbkhnUmVwb1N0YXRlRGlkQ2hhbmdlTGlzdGVuZXIoY2FsbGJhY2spO1xuICAgICAgfVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlcyBhIGxpc3RlbmVyIHRoYXQgd2FzIHJlZ2lzdGVyZWQgb24gOjpvbkhnUmVwb1N0YXRlRGlkQ2hhbmdlLlxuICAgKi9cbiAgX3JlbW92ZU9uSGdSZXBvU3RhdGVEaWRDaGFuZ2VMaXN0ZW5lcihjYWxsYmFjazogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMuX2VtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoJ2hnLXJlcG8tc3RhdGUtY2hhbmdlZCcsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZWUgSGdTZXJ2aWNlOjpmZXRjaERpZmZJbmZvIGZvciBkZXRhaWxzLlxuICAgKi9cbiAgYXN5bmMgZmV0Y2hEaWZmSW5mbyhmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTw/RGlmZkluZm8+IHtcbiAgICB2YXIgYXJncyA9IFsnZGlmZicsICctLXVuaWZpZWQnLCAnMCcsIGZpbGVQYXRoXTtcbiAgICB2YXIgb3B0aW9ucyA9IHtcbiAgICAgIGN3ZDogdGhpcy5nZXRXb3JraW5nRGlyZWN0b3J5KCksXG4gICAgfTtcbiAgICB0cnkge1xuICAgICAgdmFyIG91dHB1dCA9IGF3YWl0IHRoaXMuX2hnQXN5bmNFeGVjdXRlKGFyZ3MsIG9wdGlvbnMpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICByZXR1cm4gcGFyc2VIZ0RpZmZVbmlmaWVkT3V0cHV0KG91dHB1dC5zdGRvdXQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGxzIG91dCB0byBhc3luY0V4ZWN1dGUgdXNpbmcgdGhlICdoZycgY29tbWFuZC5cbiAgICogQHBhcmFtIG9wdGlvbnMgYXMgc3BlY2lmaWVkIGJ5IGh0dHA6Ly9ub2RlanMub3JnL2FwaS9jaGlsZF9wcm9jZXNzLmh0bWwuIEFkZGl0aW9uYWwgb3B0aW9uczpcbiAgICogICAtIE5PX0hHUExBSU4gc2V0IGlmIHRoZSAkSEdQTEFJTiBlbnZpcm9ubWVudCB2YXJpYWJsZSBzaG91bGQgbm90IGJlIHVzZWQuXG4gICAqICAgLSBUVFlfT1VUUFVUIHNldCBpZiB0aGUgY29tbWFuZCBzaG91bGQgYmUgcnVuIGFzIGlmIGl0IHdlcmUgYXR0YWNoZWQgdG8gYSB0dHkuXG4gICAqL1xuICBfaGdBc3luY0V4ZWN1dGUoYXJnczogQXJyYXk8c3RyaW5nPiwgb3B0aW9uczogYW55KTogUHJvbWlzZTxhbnk+IHtcbiAgICBpZiAoIW9wdGlvbnNbJ05PX0hHUExBSU4nXSkge1xuICAgICAgLy8gU2V0dGluZyBIR1BMQUlOPTEgb3ZlcnJpZGVzIGFueSBjdXN0b20gYWxpYXNlcyBhIHVzZXIgaGFzIGRlZmluZWQuXG4gICAgICBpZiAob3B0aW9ucy5lbnYpIHtcbiAgICAgICAgb3B0aW9ucy5lbnZbJ0hHUExBSU4nXSA9IDE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2YXIge2Fzc2lnbn0gPSByZXF1aXJlKCdudWNsaWRlLWNvbW1vbnMnKS5vYmplY3Q7XG4gICAgICAgIHZhciBlbnYgPSB7J0hHUExBSU4nOiAxfTtcbiAgICAgICAgYXNzaWduKGVudiwgcHJvY2Vzcy5lbnYpO1xuICAgICAgICBvcHRpb25zLmVudiA9IGVudjtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB2YXIgY21kO1xuICAgIGlmIChvcHRpb25zWydUVFlfT1VUUFVUJ10pIHtcbiAgICAgIGNtZCA9ICdzY3JpcHQnO1xuICAgICAgaWYgKGlzT3NYKSB7XG4gICAgICAgIC8vIE9uIE9TIFgsIHNjcmlwdCB0YWtlcyB0aGUgcHJvZ3JhbSB0byBydW4gYW5kIGl0cyBhcmd1bWVudHMgYXMgdmFyYXJncyBhdCB0aGUgZW5kLlxuICAgICAgICBhcmdzID0gWyctcScsICcvZGV2L251bGwnLCAnaGcnXS5jb25jYXQoYXJncyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBPbiBMaW51eCwgc2NyaXB0IHRha2VzIHRoZSBjb21tYW5kIHRvIHJ1biBhcyB0aGUgLWMgcGFyYW1ldGVyLlxuICAgICAgICB2YXIgaGdDb21tYW5kID0gWydoZyddLmNvbmNhdChhcmdzKS5qb2luKCcgJyk7XG4gICAgICAgIGFyZ3MgPSBbJy1xJywgJy9kZXYvbnVsbCcsICctYycsIGhnQ29tbWFuZF07XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNtZCA9ICdoZyc7XG4gICAgfVxuICAgIHJldHVybiBhc3luY0V4ZWN1dGUoY21kLCBhcmdzLCBvcHRpb25zKTtcbiAgfVxuXG4gIGZldGNoQ3VycmVudEJvb2ttYXJrKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdmFyIHtmZXRjaEN1cnJlbnRCb29rbWFya30gPSByZXF1aXJlKCcuL2hnLWJvb2ttYXJrLWhlbHBlcnMnKTtcbiAgICByZXR1cm4gZmV0Y2hDdXJyZW50Qm9va21hcmsocGF0aC5qb2luKHRoaXMuX3dvcmtpbmdEaXJlY3RvcnksICcuaGcnKSk7XG4gIH1cblxuICAvKipcbiAgICogU2VlIEhnU2VydmljZTo6b25IZ0Jvb2ttYXJrRGlkQ2hhbmdlIGZvciBkZXRhaWxzLlxuICAgKi9cbiAgb25IZ0Jvb2ttYXJrRGlkQ2hhbmdlKGNhbGxiYWNrOiAoKSA9PiB2b2lkKTogRGlzcG9zYWJsZSB7XG4gICAgdGhpcy5fZW1pdHRlci5vbignaGctYm9va21hcmstY2hhbmdlZCcsIGNhbGxiYWNrKTtcbiAgICByZXR1cm4ge1xuICAgICAgZGlzcG9zZTogdGhpcy5fcmVtb3ZlT25IZ0Jvb2ttYXJrRGlkQ2hhbmdlTGlzdGVuZXIuYmluZCh0aGlzLCBjYWxsYmFjayksXG4gICAgfTtcbiAgfVxuXG4gIF9yZW1vdmVPbkhnQm9va21hcmtEaWRDaGFuZ2VMaXN0ZW5lcihjYWxsYmFjazogKCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIHRoaXMuX2VtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoJ2hnLWJvb2ttYXJrLWNoYW5nZWQnLCBjYWxsYmFjayk7XG4gIH1cblxuXG4gIC8qKlxuICAgKiBTZWN0aW9uOiBSZXBvc2l0b3J5IFN0YXRlIGF0IFNwZWNpZmljIFJldmlzaW9uc1xuICAgKi9cblxuICBmZXRjaEZpbGVDb250ZW50QXRSZXZpc2lvbihmaWxlUGF0aDogTnVjbGlkZVVyaSwgcmV2aXNpb246IHN0cmluZyk6IFByb21pc2U8P3N0cmluZz4ge1xuICAgIHJldHVybiBmZXRjaEZpbGVDb250ZW50QXRSZXZpc2lvbihmaWxlUGF0aCwgcmV2aXNpb24sIHRoaXMuX3dvcmtpbmdEaXJlY3RvcnkpO1xuICB9XG5cbiAgZmV0Y2hGaWxlc0NoYW5nZWRBdFJldmlzaW9uKHJldmlzaW9uOiBzdHJpbmcpOiBQcm9taXNlPD9SZXZpc2lvbkZpbGVDaGFuZ2VzPiB7XG4gICAgcmV0dXJuIGZldGNoRmlsZXNDaGFuZ2VkQXRSZXZpc2lvbihyZXZpc2lvbiwgdGhpcy5fd29ya2luZ0RpcmVjdG9yeSk7XG4gIH1cblxuICBmZXRjaENvbW1vbkFuY2VzdG9yT2ZIZWFkQW5kUmV2aXNpb24ocmV2aXNpb246IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgcmV0dXJuIGZldGNoQ29tbW9uQW5jZXN0b3JPZkhlYWRBbmRSZXZpc2lvbihyZXZpc2lvbiwgdGhpcy5fd29ya2luZ0RpcmVjdG9yeSk7XG4gIH1cblxuICBmZXRjaFJldmlzaW9uTnVtYmVyc0JldHdlZW5SZXZpc2lvbnMocmV2aXNpb25Gcm9tOiBzdHJpbmcsIHJldmlzaW9uVG86IHN0cmluZyk6IFByb21pc2U8QXJyYXk8c3RyaW5nPj4ge1xuICAgIHJldHVybiBmZXRjaFJldmlzaW9uTnVtYmVyc0JldHdlZW5SZXZpc2lvbnMocmV2aXNpb25Gcm9tLCByZXZpc2lvblRvLCB0aGlzLl93b3JraW5nRGlyZWN0b3J5KTtcbiAgfVxuXG4gIGFzeW5jIGdldFNtYXJ0bG9nKHR0eU91dHB1dDogYm9vbGVhbiwgY29uY2lzZTogYm9vbGVhbik6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdmFyIGFyZ3MgPSBbY29uY2lzZSA/ICdzbCcgOiAnc21hcnRsb2cnXTtcbiAgICB2YXIgZXhlY09wdGlvbnMgPSB7XG4gICAgICBjd2Q6IHRoaXMuZ2V0V29ya2luZ0RpcmVjdG9yeSgpLFxuICAgICAgTk9fSEdQTEFJTjogY29uY2lzZSwgLy8gYGhnIHNsYCBpcyBsaWtlbHkgdXNlci1kZWZpbmVkLlxuICAgICAgVFRZX09VVFBVVDogdHR5T3V0cHV0LFxuICAgIH07XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuX2hnQXN5bmNFeGVjdXRlKGFyZ3MsIGV4ZWNPcHRpb25zKTtcbiAgfVxuXG4gIGFzeW5jIGNoZWNrb3V0KHJldmlzaW9uOiBzdHJpbmcsIGNyZWF0ZTogYm9vbGVhbik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgY3dkOiB0aGlzLmdldFdvcmtpbmdEaXJlY3RvcnkoKSxcbiAgICB9O1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLl9oZ0FzeW5jRXhlY3V0ZShbJ2NoZWNrb3V0JywgcmV2aXNpb25dLCBvcHRpb25zKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cblxubW9kdWxlLmV4cG9ydHMgPSBMb2NhbEhnU2VydmljZUJhc2U7XG4iXX0=
