
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

/*
 * An ElementRange identifies a range of child elements of a data value.
 * startIndex represents the index of the first element in the range.
 * count the number of elements in the range.
 * pagesize is always the debuggee pagesize which currently defaults to 32.
 *
 * Note that the children of an ElementRange may be aggregated into ranges whose size
 * is larger than the debuggeee pagesize. For example given a range with pagesize
 * of 32, and count of 32^5, the children of the range will have a pagesize of 32
 * and count of 32^4.
 */

/*
 * ObjectIds identify data values with children.
 *
 * Initially when data with children is returned to the Chrome
 * debugger only the ObjectId is returned. Subsequent calls by the debugger can request
 * the child properties of an ObjectId.
 *
 * There are 3 valid forms of ObjectId.
 *
 * ObjectIds for stack frame contexts just have the 3 required fields.
 * Contexts are never paged - even with large numbers of variables.
 *
 * Array and Object children may be paged.
 *
 * SinglePageObjectIds have fullname and page set. They represent a single page of
 * children of the value represented by fullname.
 *
 * PagedObjectIds have fullname and elementRange set. They represent multiple pages
 * of children of the value represented by fullname. Note that the children of
 * PagedObjectIds may be a combination of SinglePageObjectIds and PagedObjectIds.
 */

function remoteObjectIdOfObjectId(id) {
  return JSON.stringify(id);
}

function createContextObjectId(enableCount, frameIndex, contextId) {
  return {
    enableCount: enableCount,
    frameIndex: frameIndex,
    contextId: contextId
  };
}

function pagedObjectId(objectId, fullname, elementRange) {
  var result = copyObjectId(objectId);
  result.fullname = fullname;
  result.elementRange = elementRange;
  return result;
}

function singlePageObjectId(objectId, fullname, page) {
  var result = copyObjectId(objectId);
  result.fullname = fullname;
  result.page = page;
  return result;
}

function isContextObjectId(id) {
  return !id.hasOwnProperty('fullname');
}

function isSinglePageObjectId(id) {
  return id.hasOwnProperty('page');
}

function isPagedObjectId(id) {
  return id.hasOwnProperty('elementRange');
}

/**
 * Extracts just the shared parts from an ObjectId. Does not use object.assign as objectId
 * may have fields which we must not copy.
 */
function copyObjectId(id) {
  return createContextObjectId(id.enableCount, id.frameIndex, id.contextId);
}

function endIndexOfElementRange(elementRange) {
  return elementRange.startIndex + elementRange.count;
}

function endIndexOfObjectId(id) {
  return endIndexOfElementRange(id.elementRange);
}

function startIndexOfObjectId(id, pagesize) {
  if (isSinglePageObjectId(id)) {
    return id.page * pagesize;
  } else {
    return id.elementRange.startIndex;
  }
}

function countOfObjectId(id, pagesize, parentEndIndex) {
  if (isSinglePageObjectId(id)) {
    return Math.min(pagesize, parentEndIndex - startIndexOfObjectId(id, pagesize));
  } else {
    return id.elementRange.count;
  }
}

/*
 * Given a PagedObjectId, return an array of ObjectIds for its children.
 * Note that the children may be a combination of PagedObjectIds and SinglePageObjectIds.
 */
function getChildIds(id) {
  var pagesize = id.elementRange.pagesize;

  // Handle a page of pages (... of pages)
  var childSize = pagesize;
  while (childSize * pagesize < id.elementRange.count) {
    childSize *= pagesize;
  }

  var result = [];
  var childStartIndex = id.elementRange.startIndex;
  var endIndex = endIndexOfObjectId(id);
  while (childStartIndex < endIndex) {
    var childCount = Math.min(childSize, endIndex - childStartIndex);

    var childId;
    if (childCount <= pagesize) {
      childId = singlePageObjectId(id, id.fullname, Math.trunc(childStartIndex / pagesize));
    } else {
      childId = pagedObjectId(id, id.fullname, { pagesize: pagesize, startIndex: childStartIndex, count: childCount });
    }

    result.push(childId);

    childStartIndex += childCount;
  }

  return result;
}

module.exports = {
  remoteObjectIdOfObjectId: remoteObjectIdOfObjectId,
  createContextObjectId: createContextObjectId,
  pagedObjectId: pagedObjectId,
  singlePageObjectId: singlePageObjectId,
  isContextObjectId: isContextObjectId,
  isSinglePageObjectId: isSinglePageObjectId,
  isPagedObjectId: isPagedObjectId,
  copyObjectId: copyObjectId,
  endIndexOfElementRange: endIndexOfElementRange,
  endIndexOfObjectId: endIndexOfObjectId,
  startIndexOfObjectId: startIndexOfObjectId,
  countOfObjectId: countOfObjectId,
  getChildIds: getChildIds
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL09iamVjdElkLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUEyRFosU0FBUyx3QkFBd0IsQ0FBQyxFQUFZLEVBQWtCO0FBQzlELFNBQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztDQUMzQjs7QUFFRCxTQUFTLHFCQUFxQixDQUFDLFdBQW1CLEVBQUUsVUFBa0IsRUFBRSxTQUFpQixFQUFZO0FBQ25HLFNBQU87QUFDTCxlQUFXLEVBQVgsV0FBVztBQUNYLGNBQVUsRUFBVixVQUFVO0FBQ1YsYUFBUyxFQUFULFNBQVM7R0FDVixDQUFDO0NBQ0g7O0FBRUQsU0FBUyxhQUFhLENBQUMsUUFBa0IsRUFBRSxRQUFnQixFQUFFLFlBQTBCLEVBQVk7QUFDakcsTUFBSSxNQUFNLEdBQUcsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3BDLFFBQU0sQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0FBQzNCLFFBQU0sQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0FBQ25DLFNBQU8sTUFBTSxDQUFDO0NBQ2Y7O0FBRUQsU0FBUyxrQkFBa0IsQ0FBQyxRQUFrQixFQUFFLFFBQWdCLEVBQUUsSUFBWSxFQUFZO0FBQ3hGLE1BQUksTUFBTSxHQUFHLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNwQyxRQUFNLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztBQUMzQixRQUFNLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUNuQixTQUFPLE1BQU0sQ0FBQztDQUNmOztBQUVELFNBQVMsaUJBQWlCLENBQUMsRUFBWSxFQUFXO0FBQ2hELFNBQU8s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TUFBTSxDQUFDO0NBQ2Y7O0FBR0QsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNmLDBCQUF3QixFQUF4Qix3QkFBd0I7QUFDeEIsdUJBQXFCLEVBQXJCLHFCQUFxQjtBQUNyQixlQUFhLEVBQWIsYUFBYTtBQUNiLG9CQUFrQixFQUFsQixrQkFBa0I7QUFDbEIsbUJBQWlCLEVBQWpCLGlCQUFpQjtBQUNqQixzQkFBb0IsRUFBcEIsb0JBQW9CO0FBQ3BCLGlCQUFlLEVBQWYsZUFBZTtBQUNmLGNBQVksRUFBWixZQUFZO0FBQ1osd0JBQXNCLEVBQXRCLHNCQUFzQjtBQUN0QixvQkFBa0IsRUFBbEIsa0JBQWtCO0FBQ2xCLHNCQUFvQixFQUFwQixvQkFBb0I7QUFDcEIsaUJBQWUsRUFBZixlQUFlO0FBQ2YsYUFBVyxFQUFYLFdBQVc7Q0FDWixDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWRlYnVnZ2VyLWhodm0tcHJveHkvbGliL09iamVjdElkLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuXG4vKlxuICogQW4gRWxlbWVudFJhbmdlIGlkZW50aWZpZXMgYSByYW5nZSBvZiBjaGlsZCBlbGVtZW50cyBvZiBhIGRhdGEgdmFsdWUuXG4gKiBzdGFydEluZGV4IHJlcHJlc2VudHMgdGhlIGluZGV4IG9mIHRoZSBmaXJzdCBlbGVtZW50IGluIHRoZSByYW5nZS5cbiAqIGNvdW50IHRoZSBudW1iZXIgb2YgZWxlbWVudHMgaW4gdGhlIHJhbmdlLlxuICogcGFnZXNpemUgaXMgYWx3YXlzIHRoZSBkZWJ1Z2dlZSBwYWdlc2l6ZSB3aGljaCBjdXJyZW50bHkgZGVmYXVsdHMgdG8gMzIuXG4gKlxuICogTm90ZSB0aGF0IHRoZSBjaGlsZHJlbiBvZiBhbiBFbGVtZW50UmFuZ2UgbWF5IGJlIGFnZ3JlZ2F0ZWQgaW50byByYW5nZXMgd2hvc2Ugc2l6ZVxuICogaXMgbGFyZ2VyIHRoYW4gdGhlIGRlYnVnZ2VlZSBwYWdlc2l6ZS4gRm9yIGV4YW1wbGUgZ2l2ZW4gYSByYW5nZSB3aXRoIHBhZ2VzaXplXG4gKiBvZiAzMiwgYW5kIGNvdW50IG9mIDMyXjUsIHRoZSBjaGlsZHJlbiBvZiB0aGUgcmFuZ2Ugd2lsbCBoYXZlIGEgcGFnZXNpemUgb2YgMzJcbiAqIGFuZCBjb3VudCBvZiAzMl40LlxuICovXG50eXBlIEVsZW1lbnRSYW5nZSA9IHtcbiAgcGFnZXNpemU6IG51bWJlcjtcbiAgc3RhcnRJbmRleDogbnVtYmVyO1xuICBjb3VudDogbnVtYmVyO1xufTtcblxuLypcbiAqIE9iamVjdElkcyBpZGVudGlmeSBkYXRhIHZhbHVlcyB3aXRoIGNoaWxkcmVuLlxuICpcbiAqIEluaXRpYWxseSB3aGVuIGRhdGEgd2l0aCBjaGlsZHJlbiBpcyByZXR1cm5lZCB0byB0aGUgQ2hyb21lXG4gKiBkZWJ1Z2dlciBvbmx5IHRoZSBPYmplY3RJZCBpcyByZXR1cm5lZC4gU3Vic2VxdWVudCBjYWxscyBieSB0aGUgZGVidWdnZXIgY2FuIHJlcXVlc3RcbiAqIHRoZSBjaGlsZCBwcm9wZXJ0aWVzIG9mIGFuIE9iamVjdElkLlxuICpcbiAqIFRoZXJlIGFyZSAzIHZhbGlkIGZvcm1zIG9mIE9iamVjdElkLlxuICpcbiAqIE9iamVjdElkcyBmb3Igc3RhY2sgZnJhbWUgY29udGV4dHMganVzdCBoYXZlIHRoZSAzIHJlcXVpcmVkIGZpZWxkcy5cbiAqIENvbnRleHRzIGFyZSBuZXZlciBwYWdlZCAtIGV2ZW4gd2l0aCBsYXJnZSBudW1iZXJzIG9mIHZhcmlhYmxlcy5cbiAqXG4gKiBBcnJheSBhbmQgT2JqZWN0IGNoaWxkcmVuIG1heSBiZSBwYWdlZC5cbiAqXG4gKiBTaW5nbGVQYWdlT2JqZWN0SWRzIGhhdmUgZnVsbG5hbWUgYW5kIHBhZ2Ugc2V0LiBUaGV5IHJlcHJlc2VudCBhIHNpbmdsZSBwYWdlIG9mXG4gKiBjaGlsZHJlbiBvZiB0aGUgdmFsdWUgcmVwcmVzZW50ZWQgYnkgZnVsbG5hbWUuXG4gKlxuICogUGFnZWRPYmplY3RJZHMgaGF2ZSBmdWxsbmFtZSBhbmQgZWxlbWVudFJhbmdlIHNldC4gVGhleSByZXByZXNlbnQgbXVsdGlwbGUgcGFnZXNcbiAqIG9mIGNoaWxkcmVuIG9mIHRoZSB2YWx1ZSByZXByZXNlbnRlZCBieSBmdWxsbmFtZS4gTm90ZSB0aGF0IHRoZSBjaGlsZHJlbiBvZlxuICogUGFnZWRPYmplY3RJZHMgbWF5IGJlIGEgY29tYmluYXRpb24gb2YgU2luZ2xlUGFnZU9iamVjdElkcyBhbmQgUGFnZWRPYmplY3RJZHMuXG4gKi9cbnR5cGUgT2JqZWN0SWQgPSB7XG4gIGVuYWJsZUNvdW50OiBudW1iZXI7XG4gIGZyYW1lSW5kZXg6IG51bWJlcjtcbiAgY29udGV4dElkOiBzdHJpbmc7XG4gIGZ1bGxuYW1lPzogc3RyaW5nO1xuICBwYWdlPzogbnVtYmVyO1xuICBlbGVtZW50UmFuZ2U/OiBFbGVtZW50UmFuZ2U7XG59O1xuXG5mdW5jdGlvbiByZW1vdGVPYmplY3RJZE9mT2JqZWN0SWQoaWQ6IE9iamVjdElkKTogUmVtb3RlT2JqZWN0SWQge1xuICByZXR1cm4gSlNPTi5zdHJpbmdpZnkoaWQpO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVDb250ZXh0T2JqZWN0SWQoZW5hYmxlQ291bnQ6IG51bWJlciwgZnJhbWVJbmRleDogbnVtYmVyLCBjb250ZXh0SWQ6IHN0cmluZyk6IE9iamVjdElkIHtcbiAgcmV0dXJuIHtcbiAgICBlbmFibGVDb3VudCxcbiAgICBmcmFtZUluZGV4LFxuICAgIGNvbnRleHRJZCxcbiAgfTtcbn1cblxuZnVuY3Rpb24gcGFnZWRPYmplY3RJZChvYmplY3RJZDogT2JqZWN0SWQsIGZ1bGxuYW1lOiBzdHJpbmcsIGVsZW1lbnRSYW5nZTogRWxlbWVudFJhbmdlKTogT2JqZWN0SWQge1xuICB2YXIgcmVzdWx0ID0gY29weU9iamVjdElkKG9iamVjdElkKTtcbiAgcmVzdWx0LmZ1bGxuYW1lID0gZnVsbG5hbWU7XG4gIHJlc3VsdC5lbGVtZW50UmFuZ2UgPSBlbGVtZW50UmFuZ2U7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIHNpbmdsZVBhZ2VPYmplY3RJZChvYmplY3RJZDogT2JqZWN0SWQsIGZ1bGxuYW1lOiBzdHJpbmcsIHBhZ2U6IG51bWJlcik6IE9iamVjdElkIHtcbiAgdmFyIHJlc3VsdCA9IGNvcHlPYmplY3RJZChvYmplY3RJZCk7XG4gIHJlc3VsdC5mdWxsbmFtZSA9IGZ1bGxuYW1lO1xuICByZXN1bHQucGFnZSA9IHBhZ2U7XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIGlzQ29udGV4dE9iamVjdElkKGlkOiBPYmplY3RJZCk6IGJvb2xlYW4ge1xuICByZXR1cm4gIWlkLmhhc093blByb3BlcnR5KCdmdWxsbmFtZScpO1xufVxuXG5mdW5jdGlvbiBpc1NpbmdsZVBhZ2VPYmplY3RJZChpZDogT2JqZWN0SWQpOiBib29sZWFuIHtcbiAgcmV0dXJuIGlkLmhhc093blByb3BlcnR5KCdwYWdlJyk7XG59XG5cbmZ1bmN0aW9uIGlzUGFnZWRPYmplY3RJZChpZDogT2JqZWN0SWQpOiBib29sZWFuIHtcbiAgcmV0dXJuIGlkLmhhc093blByb3BlcnR5KCdlbGVtZW50UmFuZ2UnKTtcbn1cblxuLyoqXG4gKiBFeHRyYWN0cyBqdXN0IHRoZSBzaGFyZWQgcGFydHMgZnJvbSBhbiBPYmplY3RJZC4gRG9lcyBub3QgdXNlIG9iamVjdC5hc3NpZ24gYXMgb2JqZWN0SWRcbiAqIG1heSBoYXZlIGZpZWxkcyB3aGljaCB3ZSBtdXN0IG5vdCBjb3B5LlxuICovXG5mdW5jdGlvbiBjb3B5T2JqZWN0SWQoaWQ6IE9iamVjdElkKTogT2JqZWN0SWQge1xuICByZXR1cm4gY3JlYXRlQ29udGV4dE9iamVjdElkKGlkLmVuYWJsZUNvdW50LCBpZC5mcmFtZUluZGV4LCBpZC5jb250ZXh0SWQpO1xufVxuXG5mdW5jdGlvbiBlbmRJbmRleE9mRWxlbWVudFJhbmdlKGVsZW1lbnRSYW5nZTogRWxlbWVudFJhbmdlKTogbnVtYmVyIHtcbiAgcmV0dXJuIGVsZW1lbnRSYW5nZS5zdGFydEluZGV4ICsgZWxlbWVudFJhbmdlLmNvdW50O1xufVxuXG5mdW5jdGlvbiBlbmRJbmRleE9mT2JqZWN0SWQoaWQ6IE9iamVjdElkKTogT2JqZWN0SWQge1xuICByZXR1cm4gZW5kSW5kZXhPZkVsZW1lbnRSYW5nZShpZC5lbGVtZW50UmFuZ2UpO1xufVxuXG5mdW5jdGlvbiBzdGFydEluZGV4T2ZPYmplY3RJZChpZDogT2JqZWN0SWQsIHBhZ2VzaXplOiBudW1iZXIpOiBudW1iZXIge1xuICBpZiAoaXNTaW5nbGVQYWdlT2JqZWN0SWQoaWQpKSB7XG4gICAgcmV0dXJuIGlkLnBhZ2UgKiBwYWdlc2l6ZTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaWQuZWxlbWVudFJhbmdlLnN0YXJ0SW5kZXg7XG4gIH1cbn1cblxuZnVuY3Rpb24gY291bnRPZk9iamVjdElkKGlkOiBPYmplY3RJZCwgcGFnZXNpemU6IG51bWJlciwgcGFyZW50RW5kSW5kZXg6IG51bWJlcik6IG51bWJlciB7XG4gIGlmIChpc1NpbmdsZVBhZ2VPYmplY3RJZChpZCkpIHtcbiAgICByZXR1cm4gTWF0aC5taW4ocGFnZXNpemUsIHBhcmVudEVuZEluZGV4IC0gc3RhcnRJbmRleE9mT2JqZWN0SWQoaWQsIHBhZ2VzaXplKSk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGlkLmVsZW1lbnRSYW5nZS5jb3VudDtcbiAgfVxufVxuXG4vKlxuICogR2l2ZW4gYSBQYWdlZE9iamVjdElkLCByZXR1cm4gYW4gYXJyYXkgb2YgT2JqZWN0SWRzIGZvciBpdHMgY2hpbGRyZW4uXG4gKiBOb3RlIHRoYXQgdGhlIGNoaWxkcmVuIG1heSBiZSBhIGNvbWJpbmF0aW9uIG9mIFBhZ2VkT2JqZWN0SWRzIGFuZCBTaW5nbGVQYWdlT2JqZWN0SWRzLlxuICovXG5mdW5jdGlvbiBnZXRDaGlsZElkcyhpZDogT2JqZWN0SWQpOiBBcnJheTxQcm9wZXJ0eURlc2NyaXB0b3I+IHtcbiAgdmFyIHBhZ2VzaXplID0gaWQuZWxlbWVudFJhbmdlLnBhZ2VzaXplO1xuXG4gIC8vIEhhbmRsZSBhIHBhZ2Ugb2YgcGFnZXMgKC4uLiBvZiBwYWdlcylcbiAgdmFyIGNoaWxkU2l6ZSA9IHBhZ2VzaXplO1xuICB3aGlsZSAoKGNoaWxkU2l6ZSAqIHBhZ2VzaXplKSA8IGlkLmVsZW1lbnRSYW5nZS5jb3VudCkge1xuICAgIGNoaWxkU2l6ZSAqPSBwYWdlc2l6ZTtcbiAgfVxuXG4gIHZhciByZXN1bHQgPSBbXTtcbiAgdmFyIGNoaWxkU3RhcnRJbmRleCA9IGlkLmVsZW1lbnRSYW5nZS5zdGFydEluZGV4O1xuICB2YXIgZW5kSW5kZXggPSBlbmRJbmRleE9mT2JqZWN0SWQoaWQpO1xuICB3aGlsZSAoY2hpbGRTdGFydEluZGV4IDwgZW5kSW5kZXgpIHtcbiAgICB2YXIgY2hpbGRDb3VudCA9IE1hdGgubWluKGNoaWxkU2l6ZSwgZW5kSW5kZXggLSBjaGlsZFN0YXJ0SW5kZXgpO1xuXG4gICAgdmFyIGNoaWxkSWQ7XG4gICAgaWYgKGNoaWxkQ291bnQgPD0gcGFnZXNpemUpIHtcbiAgICAgIGNoaWxkSWQgPSBzaW5nbGVQYWdlT2JqZWN0SWQoaWQsIGlkLmZ1bGxuYW1lLCBNYXRoLnRydW5jKGNoaWxkU3RhcnRJbmRleCAvIHBhZ2VzaXplKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNoaWxkSWQgPSBwYWdlZE9iamVjdElkKGlkLCBpZC5mdWxsbmFtZSwge3BhZ2VzaXplLCBzdGFydEluZGV4OiBjaGlsZFN0YXJ0SW5kZXgsIGNvdW50OiBjaGlsZENvdW50fSk7XG4gICAgfVxuXG4gICAgcmVzdWx0LnB1c2goY2hpbGRJZCk7XG5cbiAgICBjaGlsZFN0YXJ0SW5kZXggKz0gY2hpbGRDb3VudDtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIHJlbW90ZU9iamVjdElkT2ZPYmplY3RJZCxcbiAgY3JlYXRlQ29udGV4dE9iamVjdElkLFxuICBwYWdlZE9iamVjdElkLFxuICBzaW5nbGVQYWdlT2JqZWN0SWQsXG4gIGlzQ29udGV4dE9iamVjdElkLFxuICBpc1NpbmdsZVBhZ2VPYmplY3RJZCxcbiAgaXNQYWdlZE9iamVjdElkLFxuICBjb3B5T2JqZWN0SWQsXG4gIGVuZEluZGV4T2ZFbGVtZW50UmFuZ2UsXG4gIGVuZEluZGV4T2ZPYmplY3RJZCxcbiAgc3RhcnRJbmRleE9mT2JqZWN0SWQsXG4gIGNvdW50T2ZPYmplY3RJZCxcbiAgZ2V0Q2hpbGRJZHMsXG59O1xuIl19
