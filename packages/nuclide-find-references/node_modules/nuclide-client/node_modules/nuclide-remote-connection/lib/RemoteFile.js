var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

'use babel';

var pathUtil = require('path');
var crypto = require('crypto');

var _require = require('atom');

var Disposable = _require.Disposable;
var Emitter = _require.Emitter;

var remoteUri = require('nuclide-remote-uri');
var logger = require('nuclide-logging').getLogger();

/* Mostly implements https://atom.io/docs/api/latest/File */

var RemoteFile = (function () {
  function RemoteFile(remote, remotePath) {
    _classCallCheck(this, RemoteFile);

    this._remote = remote;

    var _remoteUri$parse = remoteUri.parse(remotePath);

    var localPath = _remoteUri$parse.path;

    this._localPath = localPath;
    this._path = remotePath;
    this._emitter = new Emitter();
    this._subscriptionCount = 0;
    this._cachedContents = null;
    this._deleted = false;
  }

  _createClass(RemoteFile, [{
    key: 'onDidChange',
    value: function onDidChange(callback) {
      this._willAddSubscription();
      return this._trackUnsubscription(this._emitter.on('did-change', callback));
    }
  }, {
    key: 'onDidRename',
    value: function onDidRename(callback) {
      this._willAddSubscription();
      return this._trackUnsubscription(this._emitter.on('did-rename', callback));
    }
  }, {
    key: 'onDidDelete',
    value: function onDidDelete(callback) {
      this._willAddSubscription();
      return this._trackUnsubscription(this._emitter.on('did-delete', callback));
    }
  }, {
    key: '_willAddSubscription',
    value: function _willAddSubscription() {
      this._subscriptionCount++;
      return this._subscribeToNativeChangeEvents();
    }
  }, {
    key: '_subscribeToNativeChangeEvents',
    value: _asyncToGenerator(function* () {
      var _this = this;

      if (this._watchSubscription) {
        return;
      }
      if (this._pendingSubscription) {
        return;
      }
      this._pendingSubscription = true;
      try {
        this._watchSubscription = yield this._remote.getClient().watchFile(this._localPath);
      } catch (err) {
        logger.error('Failed to subscribe RemoteFile:', this._path, err);
      } finally {
        this._pendingSubscription = false;
      }
      if (this._watchSubscription) {
        this._watchSubscription.on('change', function () {
          return _this._handleNativeChangeEvent();
        });
        this._watchSubscription.on('rename', function () {
          return _this._handleNativeRenameEvent();
        });
        this._watchSubscription.on('delete', function () {
          return _this._handleNativeDeleteEvent();
        });
      }
    })
  }, {
    key: '_handleNativeChangeEvent',
    value: _asyncToGenerator(function* () {
      var oldContents = this._cachedContents;
      try {
        var newContents = yield this.read( /*flushCache*/true);
        if (oldContents !== newContents) {
          this._emitter.emit('did-change');
        }
      } catch (error) {
        // We can't read the file, so we cancel the watcher subscription.
        yield this._unsubscribeFromNativeChangeEvents();
        var handled = false;
        var handle = function handle() {
          handled = true;
        };
        error.eventType = 'change';
        this._emitter.emit('will-throw-watch-error', { error: error, handle: handle });
        if (!handled) {
          var newError = new Error('Cannot read file after file change event: ' + this._path);
          newError.originalError = error;
          newError.code = 'ENOENT';
          throw newError;
        }
      }
    })
  }, {
    key: '_handleNativeRenameEvent',
    value: _asyncToGenerator(function* (newPath) {
      yield this._unsubscribeFromNativeChangeEvents();
      this._cachedContents = null;

      var _remoteUri$parse2 = remoteUri.parse(this._path);

      var protocol = _remoteUri$parse2.protocol;
      var host = _remoteUri$parse2.host;

      this._localPath = newPath;
      this._path = protocol + '//' + host + this._localPath;
      yield this._subscribeToNativeChangeEvents();
      this._emitter.emit('did-rename');
    })
  }, {
    key: '_handleNativeDeleteEvent',
    value: _asyncToGenerator(function* () {
      yield this._unsubscribeFromNativeChangeEvents();
      this._cachedContents = null;
      if (!this._deleted) {
        this._deleted = true;
        this._emitter.emit('did-delete');
      }
    })

    /*
     * Return a new Disposable that upon dispose, will remove the bound watch subscription.
     * When the number of subscriptions reach 0, the file is unwatched.
     */
  }, {
    key: '_trackUnsubscription',
    value: function _trackUnsubscription(subscription) {
      var _this2 = this;

      return new Disposable(function () {
        subscription.dispose();
        _this2._didRemoveSubscription();
      });
    }
  }, {
    key: '_didRemoveSubscription',
    value: _asyncToGenerator(function* () {
      this._subscriptionCount--;
      if (this._subscriptionCount === 0) {
        yield this._unsubscribeFromNativeChangeEvents();
      }
    })
  }, {
    key: '_unsubscribeFromNativeChangeEvents',
    value: _asyncToGenerator(function* () {
      if (this._watchSubscription) {
        yield this._remote.getClient().unwatchFile(this._localPath);
        this._watchSubscription = null;
      }
    })
  }, {
    key: 'onWillThrowWatchError',
    value: function onWillThrowWatchError(callback) {
      return this._emitter.on('will-throw-watch-error', callback);
    }
  }, {
    key: 'isFile',
    value: function isFile() {
      return true;
    }
  }, {
    key: 'isDirectory',
    value: function isDirectory() {
      return false;
    }
  }, {
    key: 'exists',
    value: function exists() {
      return this._remote.getClient().exists(this._localPath);
    }
  }, {
    key: 'existsSync',
    value: function existsSync() {
      return true;
    }
  }, {
    key: 'getDigestSync',
    value: function getDigestSync() {
      if (this._digest) {
        return this._digest;
      } else {
        throw new Error('getDigestSync is not supported in RemoteFile');
      }
    }
  }, {
    key: 'getDigest',
    value: _asyncToGenerator(function* () {
      if (this._digest) {
        return this._digest;
      }
      yield this.read();
      return this._digest;
    })
  }, {
    key: '_setDigest',
    value: function _setDigest(contents) {
      this._digest = crypto.createHash('sha1').update(contents || '').digest('hex');
    }
  }, {
    key: 'setEncoding',
    value: function setEncoding(encoding) {
      this._encoding = encoding;
    }
  }, {
    key: 'getEncoding',
    value: function getEncoding() {
      return this._encoding;
    }
  }, {
    key: 'getPath',
    value: function getPath() {
      return this._path;
    }
  }, {
    key: 'getLocalPath',
    value: function getLocalPath() {
      return this._localPath;
    }
  }, {
    key: 'getRealPathSync',
    value: function getRealPathSync() {
      return this._realpath || this._path;
    }
  }, {
    key: 'getRealPath',
    value: _asyncToGenerator(function* () {
      var realpath = this._realpath;
      if (!realpath) {
        var realpath = yield this._remote.getClient().realpath(this._localPath);
        this._realpath = realpath;
      }
      return realpath;
    })
  }, {
    key: 'getBaseName',
    value: function getBaseName() {
      return pathUtil.basename(this._path);
    }
  }, {
    key: 'create',
    value: _asyncToGenerator(function* () {
      var wasCreated = yield this._remote.getClient().newFile(this._localPath);
      if (this._subscriptionCount > 0) {
        this._subscribeToNativeChangeEvents();
      }
      return wasCreated;
    })
  }, {
    key: 'delete',
    value: _asyncToGenerator(function* () {
      try {
        yield this._remote.getClient().unlink(this._localPath);
        this._handleNativeDeleteEvent();
      } catch (error) {
        if (error.code !== 'ENOENT') {
          throw error;
        }
      }
    })
  }, {
    key: 'rename',
    value: _asyncToGenerator(function* (newPath) {
      yield this._remote.getClient().rename(this._localPath, newPath);
      yield this._handleNativeRenameEvent(newPath);
    })
  }, {
    key: 'read',
    value: _asyncToGenerator(function* (flushCache) {
      // TODO: return cachedContents if exists and !flushCache
      // This involves the reload scenario, where the same instance of the file is read(),
      // but the file contents should reload.
      var data = yield this._remote.getClient().readFile(this._localPath);
      var contents = data.toString();
      this._setDigest(contents);
      this._cachedContents = contents;
      // TODO: respect encoding
      return contents;
    })
  }, {
    key: 'readSync',
    value: function readSync(flushcache) {
      throw new Error('readSync is not supported in RemoteFile');
    }
  }, {
    key: 'write',
    value: _asyncToGenerator(function* (text) {
      var previouslyExisted = yield this.exists();
      yield this._remote.getClient().writeFile(this._localPath, text);
      this._cachedContents = text;
      if (!previouslyExisted && this._subscriptionCount > 0) {
        yield this._subscribeToNativeChangeEvents();
      }
    })
  }, {
    key: 'getParent',
    value: function getParent() {
      var _remoteUri$parse3 = remoteUri.parse(this._path);

      var localPath = _remoteUri$parse3.path;
      var protocol = _remoteUri$parse3.protocol;
      var host = _remoteUri$parse3.host;

      var directoryPath = protocol + '//' + host + pathUtil.dirname(localPath);
      return this._remote.createDirectory(directoryPath);
    }
  }]);

  return RemoteFile;
})();

module.exports = RemoteFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXJlbW90ZS1jb25uZWN0aW9uL2xpYi9SZW1vdGVGaWxlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O0FBQUEsV0FBVyxDQUFDOztBQWNaLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMvQixJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7O2VBQ0gsT0FBTyxDQUFDLE1BQU0sQ0FBQzs7SUFBdEMsVUFBVSxZQUFWLFVBQVU7SUFBRSxPQUFPLFlBQVAsT0FBTzs7QUFDeEIsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDOUMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7Ozs7SUFHOUMsVUFBVTtBQWNILFdBZFAsVUFBVSxDQWNGLE1BQXdCLEVBQUUsVUFBa0IsRUFBRTswQkFkdEQsVUFBVTs7QUFlWixRQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQzs7MkJBQ0UsU0FBUyxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7O1FBQXhDLFNBQVMsb0JBQWYsSUFBSTs7QUFDVCxRQUFJLENBQUMsVUFBVSxHQUFHLFNBQVMsQ0FBQztBQUM1QixRQUFJLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQztBQUN4QixRQUFJLENBQUMsUUFBUSxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7QUFDOUIsUUFBSSxDQUFDLGtCQUFrQixHQUFHLENBQUMsQ0FBQztBQUM1QixRQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQztBQUM1QixRQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztHQUN2Qjs7ZUF2QkcsVUFBVTs7V0F5QkgscUJBQUMsUUFB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RDs7OzZCQUVVLFdBQUMsSUFBWSxFQUFXO0FBQ2pDLFVBQUksaUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDNUMsWUFBTSxJQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQ2hFLFVBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO0FBQzVCLFVBQUksQ0FBQyxpQkFBaUIsSUFBSSxJQUFJLENBQUMsa0JBQWtCLEdBQUcsQ0FBQyxFQUFFO0FBQ3JELGNBQU0sSUFBSSxDQUFDLDhCQUE4QixFQUFFLENBQUM7T0FDN0M7S0FDRjs7O1dBRVEscUJBQW9COzhCQUNhLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQzs7VUFBeEQsU0FBUyxxQkFBZixJQUFJO1VBQWEsUUFBUSxxQkFBUixRQUFRO1VBQUUsSUFBSSxxQkFBSixJQUFJOztBQUNwQyxVQUFJLGFBQWEsR0FBRyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3pFLGFBQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7S0FDcEQ7OztTQXRRRyxVQUFVOzs7QUF5UWhCLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFBVSxDQUFDIiwiZmlsZSI6Ii92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXJlbW90ZS1jb25uZWN0aW9uL2xpYi9SZW1vdGVGaWxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxuaW1wb3J0IHR5cGUgUmVtb3RlQ29ubmVjdGlvbiBmcm9tICcuL1JlbW90ZUNvbm5lY3Rpb24nO1xuaW1wb3J0IHR5cGUgUmVtb3RlRGlyZWN0b3J5IGZyb20gJy4vUmVtb3RlRGlyZWN0b3J5JztcblxudmFyIHBhdGhVdGlsID0gcmVxdWlyZSgncGF0aCcpO1xudmFyIGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xudmFyIHtEaXNwb3NhYmxlLCBFbWl0dGVyfSA9IHJlcXVpcmUoJ2F0b20nKTtcbnZhciByZW1vdGVVcmkgPSByZXF1aXJlKCdudWNsaWRlLXJlbW90ZS11cmknKTtcbnZhciBsb2dnZXIgPSByZXF1aXJlKCdudWNsaWRlLWxvZ2dpbmcnKS5nZXRMb2dnZXIoKTtcblxuLyogTW9zdGx5IGltcGxlbWVudHMgaHR0cHM6Ly9hdG9tLmlvL2RvY3MvYXBpL2xhdGVzdC9GaWxlICovXG5jbGFzcyBSZW1vdGVGaWxlIHtcblxuICBfY2FjaGVkQ29udGVudHM6ID9zdHJpbmc7XG4gIF9kZWxldGVkOiBib29sZWFuO1xuICBfZW1pdHRlcjogRW1pdHRlcjtcbiAgX2VuY29kaW5nOiA/c3RyaW5nO1xuICBfbG9jYWxQYXRoOiBzdHJpbmc7XG4gIF9wYXRoOiBzdHJpbmc7XG4gIF9wZW5kaW5nU3Vic2NyaXB0aW9uOiBib29sZWFuO1xuICBfcmVhbHBhdGg6ID9zdHJpbmc7XG4gIF9yZW1vdGU6IFJlbW90ZUNvbm5lY3Rpb247XG4gIF9zdWJzY3JpcHRpb25Db3VudDogbnVtYmVyO1xuICBfd2F0Y2hTdWJzY3JpcHRpb246ID9Gc1dhdGNoZXI7XG5cbiAgY29uc3RydWN0b3IocmVtb3RlOiBSZW1vdGVDb25uZWN0aW9uLCByZW1vdGVQYXRoOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9yZW1vdGUgPSByZW1vdGU7XG4gICAgdmFyIHtwYXRoOiBsb2NhbFBhdGh9ID0gcmVtb3RlVXJpLnBhcnNlKHJlbW90ZVBhdGgpO1xuICAgIHRoaXMuX2xvY2FsUGF0aCA9IGxvY2FsUGF0aDtcbiAgICB0aGlzLl9wYXRoID0gcmVtb3RlUGF0aDtcbiAgICB0aGlzLl9lbWl0dGVyID0gbmV3IEVtaXR0ZXIoKTtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25Db3VudCA9IDA7XG4gICAgdGhpcy5fY2FjaGVkQ29udGVudHMgPSBudWxsO1xuICAgIHRoaXMuX2RlbGV0ZWQgPSBmYWxzZTtcbiAgfVxuXG4gIG9uRGlkQ2hhbmdlKGNhbGxiYWNrOiAoKSA9PiBtaXhlZCk6IERpc3Bvc2FibGUge1xuICAgIHRoaXMuX3dpbGxBZGRTdWJzY3JpcHRpb24oKTtcbiAgICByZXR1cm4gdGhpcy5fdHJhY2tVbnN1YnNjcmlwdGlvbih0aGlzLl9lbWl0dGVyLm9uKCdkaWQtY2hhbmdlJywgY2FsbGJhY2spKTtcbiAgfVxuXG4gIG9uRGlkUmVuYW1lKGNhbGxiYWNrOiAoKSA9PiBtaXhlZCk6IERpc3Bvc2FibGUge1xuICAgIHRoaXMuX3dpbGxBZGRTdWJzY3JpcHRpb24oKTtcbiAgICByZXR1cm4gdGhpcy5fdHJhY2tVbnN1YnNjcmlwdGlvbih0aGlzLl9lbWl0dGVyLm9uKCdkaWQtcmVuYW1lJywgY2FsbGJhY2spKTtcbiAgfVxuXG4gIG9uRGlkRGVsZXRlKGNhbGxiYWNrOiAoKSA9PiBtaXhlZCk6IERpc3Bvc2FibGUge1xuICAgIHRoaXMuX3dpbGxBZGRTdWJzY3JpcHRpb24oKTtcbiAgICByZXR1cm4gdGhpcy5fdHJhY2tVbnN1YnNjcmlwdGlvbih0aGlzLl9lbWl0dGVyLm9uKCdkaWQtZGVsZXRlJywgY2FsbGJhY2spKTtcbiAgfVxuXG4gIF93aWxsQWRkU3Vic2NyaXB0aW9uKCk6IFByb21pc2Uge1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbkNvdW50Kys7XG4gICAgcmV0dXJuIHRoaXMuX3N1YnNjcmliZVRvTmF0aXZlQ2hhbmdlRXZlbnRzKCk7XG4gIH1cblxuICBhc3luYyBfc3Vic2NyaWJlVG9OYXRpdmVDaGFuZ2VFdmVudHMoKTogUHJvbWlzZSB7XG4gICAgaWYgKHRoaXMuX3dhdGNoU3Vic2NyaXB0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGlmICh0aGlzLl9wZW5kaW5nU3Vic2NyaXB0aW9uKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMuX3BlbmRpbmdTdWJzY3JpcHRpb24gPSB0cnVlO1xuICAgIHRyeSB7XG4gICAgICB0aGlzLl93YXRjaFN1YnNjcmlwdGlvbiA9IGF3YWl0IHRoaXMuX3JlbW90ZS5nZXRDbGllbnQoKS53YXRjaEZpbGUodGhpcy5fbG9jYWxQYXRoKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci5lcnJvcignRmFpbGVkIHRvIHN1YnNjcmliZSBSZW1vdGVGaWxlOicsIHRoaXMuX3BhdGgsIGVycik7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX3BlbmRpbmdTdWJzY3JpcHRpb24gPSBmYWxzZTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX3dhdGNoU3Vic2NyaXB0aW9uKSB7XG4gICAgICB0aGlzLl93YXRjaFN1YnNjcmlwdGlvbi5vbignY2hhbmdlJywgKCkgPT4gdGhpcy5faGFuZGxlTmF0aXZlQ2hhbmdlRXZlbnQoKSk7XG4gICAgICB0aGlzLl93YXRjaFN1YnNjcmlwdGlvbi5vbigncmVuYW1lJywgKCkgPT4gdGhpcy5faGFuZGxlTmF0aXZlUmVuYW1lRXZlbnQoKSk7XG4gICAgICB0aGlzLl93YXRjaFN1YnNjcmlwdGlvbi5vbignZGVsZXRlJywgKCkgPT4gdGhpcy5faGFuZGxlTmF0aXZlRGVsZXRlRXZlbnQoKSk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX2hhbmRsZU5hdGl2ZUNoYW5nZUV2ZW50KCk6IFByb21pc2Uge1xuICAgIHZhciBvbGRDb250ZW50cyA9IHRoaXMuX2NhY2hlZENvbnRlbnRzO1xuICAgIHRyeSB7XG4gICAgICB2YXIgbmV3Q29udGVudHMgPSBhd2FpdCB0aGlzLnJlYWQoLypmbHVzaENhY2hlKi8gdHJ1ZSk7XG4gICAgICBpZiAob2xkQ29udGVudHMgIT09IG5ld0NvbnRlbnRzKSB7XG4gICAgICAgIHRoaXMuX2VtaXR0ZXIuZW1pdCgnZGlkLWNoYW5nZScpO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBXZSBjYW4ndCByZWFkIHRoZSBmaWxlLCBzbyB3ZSBjYW5jZWwgdGhlIHdhdGNoZXIgc3Vic2NyaXB0aW9uLlxuICAgICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmVGcm9tTmF0aXZlQ2hhbmdlRXZlbnRzKCk7XG4gICAgICB2YXIgaGFuZGxlZCA9IGZhbHNlO1xuICAgICAgdmFyIGhhbmRsZSA9ICgpID0+IHtcbiAgICAgICAgaGFuZGxlZCA9IHRydWU7XG4gICAgICB9O1xuICAgICAgZXJyb3IuZXZlbnRUeXBlID0gJ2NoYW5nZSc7XG4gICAgICB0aGlzLl9lbWl0dGVyLmVtaXQoJ3dpbGwtdGhyb3ctd2F0Y2gtZXJyb3InLCB7ZXJyb3IsIGhhbmRsZX0pO1xuICAgICAgaWYgKCFoYW5kbGVkKSB7XG4gICAgICAgIHZhciBuZXdFcnJvciA9IG5ldyBFcnJvcihgQ2Fubm90IHJlYWQgZmlsZSBhZnRlciBmaWxlIGNoYW5nZSBldmVudDogJHt0aGlzLl9wYXRofWApO1xuICAgICAgICBuZXdFcnJvci5vcmlnaW5hbEVycm9yID0gZXJyb3I7XG4gICAgICAgIG5ld0Vycm9yLmNvZGUgPSAnRU5PRU5UJztcbiAgICAgICAgdGhyb3cgbmV3RXJyb3I7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX2hhbmRsZU5hdGl2ZVJlbmFtZUV2ZW50KG5ld1BhdGg6IHN0cmluZyk6IFByb21pc2Uge1xuICAgIGF3YWl0IHRoaXMuX3Vuc3Vic2NyaWJlRnJvbU5hdGl2ZUNoYW5nZUV2ZW50cygpO1xuICAgIHRoaXMuX2NhY2hlZENvbnRlbnRzID0gbnVsbDtcbiAgICB2YXIge3Byb3RvY29sLCBob3N0fSA9IHJlbW90ZVVyaS5wYXJzZSh0aGlzLl9wYXRoKTtcbiAgICB0aGlzLl9sb2NhbFBhdGggPSBuZXdQYXRoO1xuICAgIHRoaXMuX3BhdGggPSBwcm90b2NvbCArICcvLycgKyBob3N0ICsgdGhpcy5fbG9jYWxQYXRoO1xuICAgIGF3YWl0IHRoaXMuX3N1YnNjcmliZVRvTmF0aXZlQ2hhbmdlRXZlbnRzKCk7XG4gICAgdGhpcy5fZW1pdHRlci5lbWl0KCdkaWQtcmVuYW1lJyk7XG4gIH1cblxuICBhc3luYyBfaGFuZGxlTmF0aXZlRGVsZXRlRXZlbnQoKTogUHJvbWlzZSB7XG4gICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmVGcm9tTmF0aXZlQ2hhbmdlRXZlbnRzKCk7XG4gICAgdGhpcy5fY2FjaGVkQ29udGVudHMgPSBudWxsO1xuICAgIGlmICghdGhpcy5fZGVsZXRlZCkge1xuICAgICAgdGhpcy5fZGVsZXRlZCA9IHRydWU7XG4gICAgICB0aGlzLl9lbWl0dGVyLmVtaXQoJ2RpZC1kZWxldGUnKTtcbiAgICB9XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm4gYSBuZXcgRGlzcG9zYWJsZSB0aGF0IHVwb24gZGlzcG9zZSwgd2lsbCByZW1vdmUgdGhlIGJvdW5kIHdhdGNoIHN1YnNjcmlwdGlvbi5cbiAgICogV2hlbiB0aGUgbnVtYmVyIG9mIHN1YnNjcmlwdGlvbnMgcmVhY2ggMCwgdGhlIGZpbGUgaXMgdW53YXRjaGVkLlxuICAgKi9cbiAgX3RyYWNrVW5zdWJzY3JpcHRpb24oc3Vic2NyaXB0aW9uOiBEaXNwb3NhYmxlKTogRGlzcG9zYWJsZSB7XG4gICAgcmV0dXJuIG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7XG4gICAgICB0aGlzLl9kaWRSZW1vdmVTdWJzY3JpcHRpb24oKTtcbiAgICB9KTtcbiAgfVxuXG4gIGFzeW5jIF9kaWRSZW1vdmVTdWJzY3JpcHRpb24oKTogUHJvbWlzZSB7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9uQ291bnQtLTtcbiAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uQ291bnQgPT09IDApIHtcbiAgICAgIGF3YWl0IHRoaXMuX3Vuc3Vic2NyaWJlRnJvbU5hdGl2ZUNoYW5nZUV2ZW50cygpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIF91bnN1YnNjcmliZUZyb21OYXRpdmVDaGFuZ2VFdmVudHMoKTogUHJvbWlzZSB7XG4gICAgaWYgKHRoaXMuX3dhdGNoU3Vic2NyaXB0aW9uKSB7XG4gICAgICBhd2FpdCB0aGlzLl9yZW1vdGUuZ2V0Q2xpZW50KCkudW53YXRjaEZpbGUodGhpcy5fbG9jYWxQYXRoKTtcbiAgICAgIHRoaXMuX3dhdGNoU3Vic2NyaXB0aW9uID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBvbldpbGxUaHJvd1dhdGNoRXJyb3IoY2FsbGJhY2s6ICgpID0+IG1peGVkKTogRGlzcG9zYWJsZSB7XG4gICAgcmV0dXJuIHRoaXMuX2VtaXR0ZXIub24oJ3dpbGwtdGhyb3ctd2F0Y2gtZXJyb3InLCBjYWxsYmFjayk7XG4gIH1cblxuICBpc0ZpbGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBpc0RpcmVjdG9yeSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBleGlzdHMoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuX3JlbW90ZS5nZXRDbGllbnQoKS5leGlzdHModGhpcy5fbG9jYWxQYXRoKTtcbiAgfVxuXG4gIGV4aXN0c1N5bmMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBnZXREaWdlc3RTeW5jKCk6IHN0cmluZyB7XG4gICAgaWYgKHRoaXMuX2RpZ2VzdCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2RpZ2VzdDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdnZXREaWdlc3RTeW5jIGlzIG5vdCBzdXBwb3J0ZWQgaW4gUmVtb3RlRmlsZScpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldERpZ2VzdCgpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGlmICh0aGlzLl9kaWdlc3QpIHtcbiAgICAgIHJldHVybiB0aGlzLl9kaWdlc3Q7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMucmVhZCgpO1xuICAgIHJldHVybiB0aGlzLl9kaWdlc3Q7XG4gIH1cblxuICBfc2V0RGlnZXN0KGNvbnRlbnRzOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9kaWdlc3QgPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpLnVwZGF0ZShjb250ZW50cyB8fCAnJykuZGlnZXN0KCdoZXgnKTtcbiAgfVxuXG4gIHNldEVuY29kaW5nKGVuY29kaW5nOiBzdHJpbmcpIHtcbiAgICB0aGlzLl9lbmNvZGluZyA9IGVuY29kaW5nO1xuICB9XG5cbiAgZ2V0RW5jb2RpbmcoKTogP3N0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2VuY29kaW5nO1xuICB9XG5cbiAgZ2V0UGF0aCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9wYXRoO1xuICB9XG5cbiAgZ2V0TG9jYWxQYXRoKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMuX2xvY2FsUGF0aDtcbiAgfVxuXG4gIGdldFJlYWxQYXRoU3luYygpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9yZWFscGF0aCB8fCB0aGlzLl9wYXRoO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmVhbFBhdGgoKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB2YXIgcmVhbHBhdGggPSB0aGlzLl9yZWFscGF0aDtcbiAgICBpZiAoIXJlYWxwYXRoKSB7XG4gICAgICB2YXIgcmVhbHBhdGggPSBhd2FpdCB0aGlzLl9yZW1vdGUuZ2V0Q2xpZW50KCkucmVhbHBhdGgodGhpcy5fbG9jYWxQYXRoKTtcbiAgICAgIHRoaXMuX3JlYWxwYXRoID0gcmVhbHBhdGg7XG4gICAgfVxuICAgIHJldHVybiByZWFscGF0aDtcbiAgfVxuXG4gIGdldEJhc2VOYW1lKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHBhdGhVdGlsLmJhc2VuYW1lKHRoaXMuX3BhdGgpO1xuICB9XG5cbiAgYXN5bmMgY3JlYXRlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHZhciB3YXNDcmVhdGVkID0gYXdhaXQgdGhpcy5fcmVtb3RlLmdldENsaWVudCgpLm5ld0ZpbGUodGhpcy5fbG9jYWxQYXRoKTtcbiAgICBpZiAodGhpcy5fc3Vic2NyaXB0aW9uQ291bnQgPiAwKSB7XG4gICAgICB0aGlzLl9zdWJzY3JpYmVUb05hdGl2ZUNoYW5nZUV2ZW50cygpO1xuICAgIH1cbiAgICByZXR1cm4gd2FzQ3JlYXRlZDtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZSgpOiBQcm9taXNlIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5fcmVtb3RlLmdldENsaWVudCgpLnVubGluayh0aGlzLl9sb2NhbFBhdGgpO1xuICAgICAgdGhpcy5faGFuZGxlTmF0aXZlRGVsZXRlRXZlbnQoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgaWYgKGVycm9yLmNvZGUgIT09ICdFTk9FTlQnKSB7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJlbmFtZShuZXdQYXRoOiBzdHJpbmcpOiBQcm9taXNlIHtcbiAgICBhd2FpdCB0aGlzLl9yZW1vdGUuZ2V0Q2xpZW50KCkucmVuYW1lKHRoaXMuX2xvY2FsUGF0aCwgbmV3UGF0aCk7XG4gICAgYXdhaXQgdGhpcy5faGFuZGxlTmF0aXZlUmVuYW1lRXZlbnQobmV3UGF0aCk7XG4gIH1cblxuICBhc3luYyByZWFkKGZsdXNoQ2FjaGU6IGJvb2xlYW4pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIC8vIFRPRE86IHJldHVybiBjYWNoZWRDb250ZW50cyBpZiBleGlzdHMgYW5kICFmbHVzaENhY2hlXG4gICAgLy8gVGhpcyBpbnZvbHZlcyB0aGUgcmVsb2FkIHNjZW5hcmlvLCB3aGVyZSB0aGUgc2FtZSBpbnN0YW5jZSBvZiB0aGUgZmlsZSBpcyByZWFkKCksXG4gICAgLy8gYnV0IHRoZSBmaWxlIGNvbnRlbnRzIHNob3VsZCByZWxvYWQuXG4gICAgdmFyIGRhdGEgPSBhd2FpdCB0aGlzLl9yZW1vdGUuZ2V0Q2xpZW50KCkucmVhZEZpbGUodGhpcy5fbG9jYWxQYXRoKTtcbiAgICB2YXIgY29udGVudHMgPSBkYXRhLnRvU3RyaW5nKCk7XG4gICAgdGhpcy5fc2V0RGlnZXN0KGNvbnRlbnRzKTtcbiAgICB0aGlzLl9jYWNoZWRDb250ZW50cyA9IGNvbnRlbnRzO1xuICAgIC8vIFRPRE86IHJlc3BlY3QgZW5jb2RpbmdcbiAgICByZXR1cm4gY29udGVudHM7XG4gIH1cblxuICByZWFkU3luYyhmbHVzaGNhY2hlOiBib29sZWFuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3JlYWRTeW5jIGlzIG5vdCBzdXBwb3J0ZWQgaW4gUmVtb3RlRmlsZScpO1xuICB9XG5cbiAgYXN5bmMgd3JpdGUodGV4dDogc3RyaW5nKTogUHJvbWlzZSB7XG4gICAgdmFyIHByZXZpb3VzbHlFeGlzdGVkID0gYXdhaXQgdGhpcy5leGlzdHMoKTtcbiAgICBhd2FpdCB0aGlzLl9yZW1vdGUuZ2V0Q2xpZW50KCkud3JpdGVGaWxlKHRoaXMuX2xvY2FsUGF0aCwgdGV4dCk7XG4gICAgdGhpcy5fY2FjaGVkQ29udGVudHMgPSB0ZXh0O1xuICAgIGlmICghcHJldmlvdXNseUV4aXN0ZWQgJiYgdGhpcy5fc3Vic2NyaXB0aW9uQ291bnQgPiAwKSB7XG4gICAgICBhd2FpdCB0aGlzLl9zdWJzY3JpYmVUb05hdGl2ZUNoYW5nZUV2ZW50cygpO1xuICAgIH1cbiAgfVxuXG4gIGdldFBhcmVudCgpOiBSZW1vdGVEaXJlY3Rvcnkge1xuICAgIHZhciB7cGF0aDogbG9jYWxQYXRoLCBwcm90b2NvbCwgaG9zdH0gPSByZW1vdGVVcmkucGFyc2UodGhpcy5fcGF0aCk7XG4gICAgdmFyIGRpcmVjdG9yeVBhdGggPSBwcm90b2NvbCArICcvLycgKyBob3N0ICsgcGF0aFV0aWwuZGlybmFtZShsb2NhbFBhdGgpO1xuICAgIHJldHVybiB0aGlzLl9yZW1vdGUuY3JlYXRlRGlyZWN0b3J5KGRpcmVjdG9yeVBhdGgpO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gUmVtb3RlRmlsZTtcbiJdfQ==
