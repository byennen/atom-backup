
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var watchman = require('fb-watchman');
var WatchmanSubscription = require('./WatchmanSubscription');

var ensureTrailingSeparator = require('nuclide-commons').paths.ensureTrailingSeparator;

var logger = require('nuclide-logging').getLogger();

var _require = require('./main');

var getWatchmanBinaryPath = _require.getWatchmanBinaryPath;

var WatchmanClient = (function () {
  function WatchmanClient() {
    _classCallCheck(this, WatchmanClient);

    this._initWatchmanClient();
    this._subscriptions = {};
    this._watchmanVersionPromise = this.version();
  }

  _createClass(WatchmanClient, [{
    key: 'dispose',
    value: function dispose() {
      if (this._clientPromise) {
        this._clientPromise.then(function (client) {
          return client.end();
        });
      }
    }
  }, {
    key: '_initWatchmanClient',
    value: function _initWatchmanClient() {
      var _this = this;

      this._clientPromise = this._createClientPromise();
      this._clientPromise.then(function (client) {
        client.on('end', function () {
          return _this._onClientEnd();
        });
        client.on('error', function (error) {
          return logger.error('Error while talking to watchman: ', error);
        });
        client.on('subscription', function (response) {
          return _this._onSubscriptionResult(response);
        });
      });
    }
  }, {
    key: '_createClientPromise',
    value: _asyncToGenerator(function* () {
      return new watchman.Client({
        watchmanBinaryPath: yield getWatchmanBinaryPath()
      });
    })
  }, {
    key: '_onClientEnd',
    value: function _onClientEnd() {
      logger.warn('Watchman client ended, creating a new client!');
      this._clientPromise.then(function (client) {
        client.removeAllListeners('end');
        client.removeAllListeners('error');
        client.removeAllListeners('subscription');
      });
      this._initWatchmanClient();
      this._restoreSubscriptions();
    }
  }, {
    key: '_restoreSubscriptions',
    value: _asyncToGenerator(function* () {
      var _this2 = this;

      var watchPromises = [];
      for (var key in this._subscriptions) {
        watchPromises.push(this._subscriptions[key]);
      }
      yield Promise.all(watchPromises.map(_asyncToGenerator(function* (subscription) {
        subscription.options.since = yield _this2._clock(subscription.root);
        yield _this2._watchProject(subscription.path);
        yield _this2._subscribe(subscription.root, subscription.name, subscription.options);
      })));
    })
  }, {
    key: '_onSubscriptionResult',
    value: function _onSubscriptionResult(response) {
      var subscription = this._subscriptions[response.subscription];
      if (!subscription) {
        return logger.error('Subscription not found for response:!', response);
      }
      subscription.emit('change', response.files);
    }
  }, {
    key: 'watchDirectoryRecursive',
    value: _asyncToGenerator(function* (localDirectoryPath) {
      var directoryPath = ensureTrailingSeparator(localDirectoryPath);
      var existingSubscription = this._subscriptions[directoryPath];
      if (existingSubscription) {
        existingSubscription.subscriptionCount++;
        return existingSubscription;
      } else {
        var _ref = yield this._watchProject(directoryPath);

        var watchRoot = _ref.watch;
        var relativePath = _ref.relative_path;

        var clock = yield this._clock(watchRoot);
        var options = {
          fields: ['name', 'new', 'exists', 'mode'],
          since: clock
        };
        if (relativePath) {
          // Passing an 'undefined' expression causes an exception in fb-watchman.
          options.expression = ['dirname', relativePath];
        }
        // relativePath is undefined if watchRoot is the same as directoryPath.
        var subscription = this._subscriptions[directoryPath] = new WatchmanSubscription(
        /*subscriptionRoot*/watchRoot,
        /*pathFromSubscriptionRootToSubscriptionPath*/relativePath,
        /*subscriptionPath*/directoryPath,
        /*subscriptionCount*/1,
        /*subscriptionOptions*/options);
        yield this._subscribe(watchRoot, directoryPath, options);
        return subscription;
      }
    })
  }, {
    key: 'hasSubscription',
    value: function hasSubscription(entryPath) {
      return !!this._subscriptions[entryPath];
    }
  }, {
    key: 'unwatch',
    value: _asyncToGenerator(function* (entryPath) {
      if (!this._subscriptions[entryPath]) {
        return logger.error('No watcher entity found with path:', entryPath);
      }
      var subscription = this._subscriptions[entryPath];
      if (--subscription.subscriptionCount === 0) {

        yield this._unsubscribe(subscription.path, subscription.name);
        // Don't delete the watcher if there are other users for it.
        if (!subscription.pathFromSubscriptionRootToSubscriptionPath) {
          yield this._deleteWatcher(entryPath);
        }
        delete this._subscriptions[entryPath];
      }
    })
  }, {
    key: '_watchList',
    value: _asyncToGenerator(function* () {
      var _ref2 = yield this._command('watch-list');

      var roots = _ref2.roots;

      return roots;
    })
  }, {
    key: '_deleteWatcher',
    value: function _deleteWatcher(entryPath) {
      return this._command('watch-del', entryPath);
    }
  }, {
    key: '_unsubscribe',
    value: function _unsubscribe(subscriptionPath, subscriptionName) {
      return this._command('unsubscribe', subscriptionPath, subscriptionName);
    }
  }, {
    key: '_watch',
    value: _asyncToGenerator(function* (directoryPath) {
      var response = yield this._command('watch', directoryPath);
      if (response.warning) {
        logger.log('watchman warning: ', response.warning);
      }
    })
  }, {
    key: '_watchProject',
    value: _asyncToGenerator(function* (directoryPath) {
      var watchmanVersion = yield this._watchmanVersionPromise;
      if (!watchmanVersion || watchmanVersion < '3.1.0') {
        throw new Error('Watchman version: ' + watchmanVersion + ' does not support watch-project');
      }
      var response = yield this._command('watch-project', directoryPath);
      if (response.warning) {
        logger.log('watchman warning: ', response.warning);
      }
      return response;
    })
  }, {
    key: '_clock',
    value: _asyncToGenerator(function* (directoryPath) {
      var _ref3 = yield this._command('clock', directoryPath);

      var clock = _ref3.clock;

      return clock;
    })
  }, {
    key: 'version',
    value: _asyncToGenerator(function* () {
      var _ref4 = yield this._command('version');

      var version = _ref4.version;

      return version;
    })
  }, {
    key: '_subscribe',
    value: function _subscribe(watchRoot, subscriptionName) {
      var options = arguments.length <= 2 || arguments[2] === undefined ? {} : arguments[2];

      return this._command('subscribe', watchRoot, subscriptionName, options);
    }

    /*
     * Promisify calls to watchman client.
     */
  }, {
    key: '_command',
    value: function _command() {
      var _this3 = this;

      for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      return new Promise(function (resolve, reject) {
        _this3._clientPromise.then(function (client) {
          client.command(args, function (error, response) {
            return error ? reject(error) : resolve(response);
          });
        })['catch'](reject);
      });
    }
  }]);

  return WatchmanClient;
})();

module.exports = WatchmanClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLXdhdGNobWFuLWhlbHBlcnMvbGliL1dhdGNobWFuQ2xpZW50LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7OztBQVdaLElBQUksUUFBUSxHQUFHLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN0QyxJQUFJLG9CQUFvQixHQUFHLE9BQU8sQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDOztJQUN4RCx1QkFBdUIsR0FBSSxPQUFPLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxLQUFLLENBQTNELHVCQUF1Qjs7QUFDNUIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7O2VBQ3RCLE9BQU8sQ0FBQyxRQUFRLENBQUM7O0lBQTFDLHFCQUFxQixZQUFyQixxQkFBcUI7O0lBZXBCLGNBQWM7QUFDUCxXQURQLGNBQWMsR0FDSjswQkFEVixjQUFjOztBQUVoQixRQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztBQUMzQixRQUFJLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztBQUN6QixRQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0dBQy9DOztlQUxHLGNBQWM7O1dBT1gsbUJBQUc7QUFDUixVQUFJLElBQUksQ0FBQyxjQUFjLEVBQUU7QUFDdkIsWUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsVUFBQSxNQUFNO2lCQUFJLE1BQU0sQ0FBQyxHQUFHLEVBQUU7U0FBQSxDQUFDLENBQUM7T0FDbEQ7S0FDRjs7O1dBRWtCLCtCQUFHOzs7QUFDcEIsVUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztBQUNsRCxVQUFJLENBQUMsY0FBYyxDQUFD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ci9mb2xkZXJzL3hmL3JzcGg0X2M1NzMxNXJzNTd4eHNkc2tyeG52MzZ0MC9UL3RtcGVtbTJIdXB1Ymxpc2hfcGFja2FnZXMvbnBtL251Y2xpZGUtd2F0Y2htYW4taGVscGVycy9saWIvV2F0Y2htYW5DbGllbnQuanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG52YXIgd2F0Y2htYW4gPSByZXF1aXJlKCdmYi13YXRjaG1hbicpO1xudmFyIFdhdGNobWFuU3Vic2NyaXB0aW9uID0gcmVxdWlyZSgnLi9XYXRjaG1hblN1YnNjcmlwdGlvbicpO1xudmFyIHtlbnN1cmVUcmFpbGluZ1NlcGFyYXRvcn0gPSByZXF1aXJlKCdudWNsaWRlLWNvbW1vbnMnKS5wYXRocztcbnZhciBsb2dnZXIgPSByZXF1aXJlKCdudWNsaWRlLWxvZ2dpbmcnKS5nZXRMb2dnZXIoKTtcbnZhciB7Z2V0V2F0Y2htYW5CaW5hcnlQYXRofSA9IHJlcXVpcmUoJy4vbWFpbicpO1xuXG50eXBlIFdhdGNobWFuU3Vic2NyaXB0aW9uUmVzcG9uc2UgPSB7XG4gIHJvb3Q6IHN0cmluZztcbiAgc3Vic2NyaXB0aW9uOiBzdHJpbmc7XG4gIGZpbGVzOiBBcnJheTxGaWxlQ2hhbmdlPjtcbn07XG5cbnR5cGUgRmlsZUNoYW5nZSA9IHtcbiAgbmFtZTogc3RyaW5nO1xuICBuZXc6IGJvb2xlYW47XG4gIGV4aXN0czogYm9vbGVhbjtcbiAgbW9kZTogbnVtYmVyO1xufTtcblxuY2xhc3MgV2F0Y2htYW5DbGllbnQge1xuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLl9pbml0V2F0Y2htYW5DbGllbnQoKTtcbiAgICB0aGlzLl9zdWJzY3JpcHRpb25zID0ge307XG4gICAgdGhpcy5fd2F0Y2htYW5WZXJzaW9uUHJvbWlzZSA9IHRoaXMudmVyc2lvbigpO1xuICB9XG5cbiAgZGlzcG9zZSgpIHtcbiAgICBpZiAodGhpcy5fY2xpZW50UHJvbWlzZSkge1xuICAgICAgdGhpcy5fY2xpZW50UHJvbWlzZS50aGVuKGNsaWVudCA9PiBjbGllbnQuZW5kKCkpO1xuICAgIH1cbiAgfVxuXG4gIF9pbml0V2F0Y2htYW5DbGllbnQoKSB7XG4gICAgdGhpcy5fY2xpZW50UHJvbWlzZSA9IHRoaXMuX2NyZWF0ZUNsaWVudFByb21pc2UoKTtcbiAgICB0aGlzLl9jbGllbnRQcm9taXNlLnRoZW4oY2xpZW50ID0+IHtcbiAgICAgIGNsaWVudC5vbignZW5kJywgKCkgPT4gdGhpcy5fb25DbGllbnRFbmQoKSk7XG4gICAgICBjbGllbnQub24oJ2Vycm9yJywgZXJyb3IgPT4gbG9nZ2VyLmVycm9yKCdFcnJvciB3aGlsZSB0YWxraW5nIHRvIHdhdGNobWFuOiAnLCBlcnJvcikpO1xuICAgICAgY2xpZW50Lm9uKCdzdWJzY3JpcHRpb24nLCByZXNwb25zZSA9PiB0aGlzLl9vblN1YnNjcmlwdGlvblJlc3VsdChyZXNwb25zZSkpO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgX2NyZWF0ZUNsaWVudFByb21pc2UoKTogUHJvbWlzZTx3YXRjaG1hbi5DbGllbnQ+IHtcbiAgICByZXR1cm4gbmV3IHdhdGNobWFuLkNsaWVudCh7XG4gICAgICB3YXRjaG1hbkJpbmFyeVBhdGg6IGF3YWl0IGdldFdhdGNobWFuQmluYXJ5UGF0aCgpLFxuICAgIH0pO1xuICB9XG5cbiAgX29uQ2xpZW50RW5kKCkge1xuICAgIGxvZ2dlci53YXJuKCdXYXRjaG1hbiBjbGllbnQgZW5kZWQsIGNyZWF0aW5nIGEgbmV3IGNsaWVudCEnKTtcbiAgICB0aGlzLl9jbGllbnRQcm9taXNlLnRoZW4oY2xpZW50ID0+IHtcbiAgICAgIGNsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2VuZCcpO1xuICAgICAgY2xpZW50LnJlbW92ZUFsbExpc3RlbmVycygnZXJyb3InKTtcbiAgICAgIGNsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ3N1YnNjcmlwdGlvbicpO1xuICAgIH0pO1xuICAgIHRoaXMuX2luaXRXYXRjaG1hbkNsaWVudCgpO1xuICAgIHRoaXMuX3Jlc3RvcmVTdWJzY3JpcHRpb25zKCk7XG4gIH1cblxuICBhc3luYyBfcmVzdG9yZVN1YnNjcmlwdGlvbnMoKSB7XG4gICAgdmFyIHdhdGNoUHJvbWlzZXMgPSBbXTtcbiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5fc3Vic2NyaXB0aW9ucykge1xuICAgICAgd2F0Y2hQcm9taXNlcy5wdXNoKHRoaXMuX3N1YnNjcmlwdGlvbnNba2V5XSk7XG4gICAgfVxuICAgIGF3YWl0IFByb21pc2UuYWxsKHdhdGNoUHJvbWlzZXMubWFwKGFzeW5jIChzdWJzY3JpcHRpb24pID0+IHtcbiAgICAgIHN1YnNjcmlwdGlvbi5vcHRpb25zLnNpbmNlID0gYXdhaXQgdGhpcy5fY2xvY2soc3Vic2NyaXB0aW9uLnJvb3QpO1xuICAgICAgYXdhaXQgdGhpcy5fd2F0Y2hQcm9qZWN0KHN1YnNjcmlwdGlvbi5wYXRoKTtcbiAgICAgIGF3YWl0IHRoaXMuX3N1YnNjcmliZShzdWJzY3JpcHRpb24ucm9vdCwgc3Vic2NyaXB0aW9uLm5hbWUsIHN1YnNjcmlwdGlvbi5vcHRpb25zKTtcbiAgICB9KSk7XG4gIH1cblxuICBfb25TdWJzY3JpcHRpb25SZXN1bHQocmVzcG9uc2U6IFdhdGNobWFuU3Vic2NyaXB0aW9uUmVzcG9uc2UpIHtcbiAgICB2YXIgc3Vic2NyaXB0aW9uID0gdGhpcy5fc3Vic2NyaXB0aW9uc1tyZXNwb25zZS5zdWJzY3JpcHRpb25dO1xuICAgIGlmICghc3Vic2NyaXB0aW9uKSB7XG4gICAgICByZXR1cm4gbG9nZ2VyLmVycm9yKCdTdWJzY3JpcHRpb24gbm90IGZvdW5kIGZvciByZXNwb25zZTohJywgcmVzcG9uc2UpO1xuICAgIH1cbiAgICBzdWJzY3JpcHRpb24uZW1pdCgnY2hhbmdlJywgcmVzcG9uc2UuZmlsZXMpO1xuICB9XG5cbiAgYXN5bmMgd2F0Y2hEaXJlY3RvcnlSZWN1cnNpdmUobG9jYWxEaXJlY3RvcnlQYXRoOiBzdHJpbmcpIDogUHJvbWlzZTxXYXRjaG1hblN1YnNjcmlwdGlvbj4ge1xuICAgIHZhciBkaXJlY3RvcnlQYXRoID0gZW5zdXJlVHJhaWxpbmdTZXBhcmF0b3IobG9jYWxEaXJlY3RvcnlQYXRoKTtcbiAgICB2YXIgZXhpc3RpbmdTdWJzY3JpcHRpb24gPSB0aGlzLl9zdWJzY3JpcHRpb25zW2RpcmVjdG9yeVBhdGhdO1xuICAgIGlmIChleGlzdGluZ1N1YnNjcmlwdGlvbikge1xuICAgICAgZXhpc3RpbmdTdWJzY3JpcHRpb24uc3Vic2NyaXB0aW9uQ291bnQrKztcbiAgICAgIHJldHVybiBleGlzdGluZ1N1YnNjcmlwdGlvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIHt3YXRjaDogd2F0Y2hSb290LCByZWxhdGl2ZV9wYXRoOiByZWxhdGl2ZVBhdGh9ID0gYXdhaXQgdGhpcy5fd2F0Y2hQcm9qZWN0KGRpcmVjdG9yeVBhdGgpO1xuICAgICAgdmFyIGNsb2NrID0gYXdhaXQgdGhpcy5fY2xvY2sod2F0Y2hSb290KTtcbiAgICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgICBmaWVsZHM6IFsnbmFtZScsICduZXcnLCAnZXhpc3RzJywgJ21vZGUnXSxcbiAgICAgICAgc2luY2U6IGNsb2NrLFxuICAgICAgfTtcbiAgICAgIGlmIChyZWxhdGl2ZVBhdGgpIHtcbiAgICAgICAgLy8gUGFzc2luZyBhbiAndW5kZWZpbmVkJyBleHByZXNzaW9uIGNhdXNlcyBhbiBleGNlcHRpb24gaW4gZmItd2F0Y2htYW4uXG4gICAgICAgIG9wdGlvbnMuZXhwcmVzc2lvbiA9IFsnZGlybmFtZScsIHJlbGF0aXZlUGF0aF07XG4gICAgICB9XG4gICAgICAvLyByZWxhdGl2ZVBhdGggaXMgdW5kZWZpbmVkIGlmIHdhdGNoUm9vdCBpcyB0aGUgc2FtZSBhcyBkaXJlY3RvcnlQYXRoLlxuICAgICAgdmFyIHN1YnNjcmlwdGlvbiA9IHRoaXMuX3N1YnNjcmlwdGlvbnNbZGlyZWN0b3J5UGF0aF0gPVxuICAgICAgICAgIG5ldyBXYXRjaG1hblN1YnNjcmlwdGlvbihcbiAgICAgICAgICAgIC8qc3Vic2NyaXB0aW9uUm9vdCovIHdhdGNoUm9vdCxcbiAgICAgICAgICAgIC8qcGF0aEZyb21TdWJzY3JpcHRpb25Sb290VG9TdWJzY3JpcHRpb25QYXRoKi8gcmVsYXRpdmVQYXRoLFxuICAgICAgICAgICAgLypzdWJzY3JpcHRpb25QYXRoKi8gZGlyZWN0b3J5UGF0aCxcbiAgICAgICAgICAgIC8qc3Vic2NyaXB0aW9uQ291bnQqLyAxLFxuICAgICAgICAgICAgLypzdWJzY3JpcHRpb25PcHRpb25zKi8gb3B0aW9uc1xuICAgICAgICAgICk7XG4gICAgICBhd2FpdCB0aGlzLl9zdWJzY3JpYmUod2F0Y2hSb290LCBkaXJlY3RvcnlQYXRoLCBvcHRpb25zKTtcbiAgICAgIHJldHVybiBzdWJzY3JpcHRpb247XG4gICAgfVxuICB9XG5cbiAgaGFzU3Vic2NyaXB0aW9uKGVudHJ5UGF0aDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5fc3Vic2NyaXB0aW9uc1tlbnRyeVBhdGhdO1xuICB9XG5cbiAgYXN5bmMgdW53YXRjaChlbnRyeVBhdGg6IHN0cmluZyk6IFByb21pc2Uge1xuICAgIGlmICghdGhpcy5fc3Vic2NyaXB0aW9uc1tlbnRyeVBhdGhdKSB7XG4gICAgICByZXR1cm4gbG9nZ2VyLmVycm9yKCdObyB3YXRjaGVyIGVudGl0eSBmb3VuZCB3aXRoIHBhdGg6JywgZW50cnlQYXRoKTtcbiAgICB9XG4gICAgdmFyIHN1YnNjcmlwdGlvbiA9IHRoaXMuX3N1YnNjcmlwdGlvbnNbZW50cnlQYXRoXTtcbiAgICBpZiAoLS1zdWJzY3JpcHRpb24uc3Vic2NyaXB0aW9uQ291bnQgPT09IDApIHtcblxuICAgICAgYXdhaXQgdGhpcy5fdW5zdWJzY3JpYmUoc3Vic2NyaXB0aW9uLnBhdGgsIHN1YnNjcmlwdGlvbi5uYW1lKTtcbiAgICAgIC8vIERvbid0IGRlbGV0ZSB0aGUgd2F0Y2hlciBpZiB0aGVyZSBhcmUgb3RoZXIgdXNlcnMgZm9yIGl0LlxuICAgICAgaWYgKCFzdWJzY3JpcHRpb24ucGF0aEZyb21TdWJzY3JpcHRpb25Sb290VG9TdWJzY3JpcHRpb25QYXRoKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuX2RlbGV0ZVdhdGNoZXIoZW50cnlQYXRoKTtcbiAgICAgIH1cbiAgICAgIGRlbGV0ZSB0aGlzLl9zdWJzY3JpcHRpb25zW2VudHJ5UGF0aF07XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX3dhdGNoTGlzdCgpOiBQcm9taXNlPEFycmF5PHN0cmluZz4+IHtcbiAgICB2YXIge3Jvb3RzfSA9IGF3YWl0IHRoaXMuX2NvbW1hbmQoJ3dhdGNoLWxpc3QnKTtcbiAgICByZXR1cm4gcm9vdHM7XG4gIH1cblxuICBfZGVsZXRlV2F0Y2hlcihlbnRyeVBhdGg6IHN0cmluZyk6IFByb21pc2Uge1xuICAgIHJldHVybiB0aGlzLl9jb21tYW5kKCd3YXRjaC1kZWwnLCBlbnRyeVBhdGgpO1xuICB9XG5cbiAgX3Vuc3Vic2NyaWJlKHN1YnNjcmlwdGlvblBhdGg6IHN0cmluZywgc3Vic2NyaXB0aW9uTmFtZTogc3RyaW5nKSB7XG4gICAgcmV0dXJuIHRoaXMuX2NvbW1hbmQoJ3Vuc3Vic2NyaWJlJywgc3Vic2NyaXB0aW9uUGF0aCwgc3Vic2NyaXB0aW9uTmFtZSk7XG4gIH1cblxuICBhc3luYyBfd2F0Y2goZGlyZWN0b3J5UGF0aDogc3RyaW5nKTogUHJvbWlzZSB7XG4gICAgdmFyIHJlc3BvbnNlID0gYXdhaXQgdGhpcy5fY29tbWFuZCgnd2F0Y2gnLCBkaXJlY3RvcnlQYXRoKTtcbiAgICBpZiAocmVzcG9uc2Uud2FybmluZykge1xuICAgICAgbG9nZ2VyLmxvZygnd2F0Y2htYW4gd2FybmluZzogJywgcmVzcG9uc2Uud2FybmluZyk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgX3dhdGNoUHJvamVjdChkaXJlY3RvcnlQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGFueT4ge1xuICAgIHZhciB3YXRjaG1hblZlcnNpb24gPSBhd2FpdCB0aGlzLl93YXRjaG1hblZlcnNpb25Qcm9taXNlO1xuICAgIGlmICghd2F0Y2htYW5WZXJzaW9uIHx8IHdhdGNobWFuVmVyc2lvbiA8ICczLjEuMCcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignV2F0Y2htYW4gdmVyc2lvbjogJyArIHdhdGNobWFuVmVyc2lvbiArICcgZG9lcyBub3Qgc3VwcG9ydCB3YXRjaC1wcm9qZWN0Jyk7XG4gICAgfVxuICAgIHZhciByZXNwb25zZSA9IGF3YWl0IHRoaXMuX2NvbW1hbmQoJ3dhdGNoLXByb2plY3QnLCBkaXJlY3RvcnlQYXRoKTtcbiAgICBpZiAocmVzcG9uc2Uud2FybmluZykge1xuICAgICAgbG9nZ2VyLmxvZygnd2F0Y2htYW4gd2FybmluZzogJywgcmVzcG9uc2Uud2FybmluZyk7XG4gICAgfVxuICAgIHJldHVybiByZXNwb25zZTtcbiAgfVxuXG4gIGFzeW5jIF9jbG9jayhkaXJlY3RvcnlQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIHZhciB7Y2xvY2t9ID0gYXdhaXQgdGhpcy5fY29tbWFuZCgnY2xvY2snLCBkaXJlY3RvcnlQYXRoKTtcbiAgICByZXR1cm4gY2xvY2s7XG4gIH1cblxuICBhc3luYyB2ZXJzaW9uKCk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgdmFyIHt2ZXJzaW9ufSA9IGF3YWl0IHRoaXMuX2NvbW1hbmQoJ3ZlcnNpb24nKTtcbiAgICByZXR1cm4gdmVyc2lvbjtcbiAgfVxuXG4gIF9zdWJzY3JpYmUoXG4gICAgICAgIHdhdGNoUm9vdDogc3RyaW5nLFxuICAgICAgICBzdWJzY3JpcHRpb25OYW1lOiA/c3RyaW5nLFxuICAgICAgICBvcHRpb25zOiA/V2F0Y2htYW5TdWJzY3JpcHRpb25PcHRpb25zID0ge31cbiAgICAgICk6IFByb21pc2U8V2F0Y2htYW5TdWJzY3JpcHRpb24+IHtcbiAgICByZXR1cm4gdGhpcy5fY29tbWFuZCgnc3Vic2NyaWJlJywgd2F0Y2hSb290LCBzdWJzY3JpcHRpb25OYW1lLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qXG4gICAqIFByb21pc2lmeSBjYWxscyB0byB3YXRjaG1hbiBjbGllbnQuXG4gICAqL1xuICBfY29tbWFuZCguLi5hcmdzKTogUHJvbWlzZTxhbnk+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgdGhpcy5fY2xpZW50UHJvbWlzZS50aGVuKGNsaWVudCA9PiB7XG4gICAgICAgIGNsaWVudC5jb21tYW5kKGFyZ3MsIChlcnJvciwgcmVzcG9uc2UpID0+XG4gICAgICAgICAgICBlcnJvciA/IHJlamVjdChlcnJvcikgOiByZXNvbHZlKHJlc3BvbnNlKSk7XG4gICAgICB9KS5jYXRjaChyZWplY3QpO1xuICAgIH0pO1xuICB9XG59XG5cbm1vZHVsZS5leHBvcnRzID0gV2F0Y2htYW5DbGllbnQ7XG4iXX0=
