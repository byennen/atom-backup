
/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;
var Disposable = _require.Disposable;
var Emitter = _require.Emitter;
var Point = _require.Point;

var DEBOUNCE_TIME = 200;

var WindowMouseListener = (function () {
  function WindowMouseListener() {
    var _this = this;

    _classCallCheck(this, WindowMouseListener);

    this._subscriptions = new CompositeDisposable();

    var _require2 = require('nuclide-commons');

    var debounce = _require2.debounce;

    var handler = debounce(function (event) {
      return _this._handleMouseMove(event);
    }, DEBOUNCE_TIME,
    /* immediate */true);
    window.addEventListener('mousemove', handler);
    this._mouseMoveListener = new Disposable(function () {
      window.removeEventListener('mousemove', handler);
    });

    this._textEditorMouseListenersMap = new Map();
    this._textEditorMouseListenersCountMap = new Map();
    this._subscriptions.add(new Disposable(function () {
      _this._textEditorMouseListenersMap.forEach(function (listener) {
        return listener.dispose();
      });
      _this._textEditorMouseListenersMap.clear();
      _this._textEditorMouseListenersCountMap.clear();
    }));
  }

  _createClass(WindowMouseListener, [{
    key: 'mouseListenerForTextEditor',
    value: function mouseListenerForTextEditor(textEditor) {
      var _this2 = this;

      // Keep track of how many mouse listeners were returned for the text editor
      // so we know when it's safe to actually dispose it.
      var count = this._textEditorMouseListenersCountMap.get(textEditor) || 0;
      this._textEditorMouseListenersCountMap.set(textEditor, count + 1);

      var mouseListener = this._textEditorMouseListenersMap.get(textEditor);
      if (!mouseListener) {
        mouseListener = new TextEditorMouseListener(textEditor, /* shouldDispose */function () {
          var currentCount = _this2._textEditorMouseListenersCountMap.get(textEditor) || 0;
          if (currentCount === 1) {
            _this2._textEditorMouseListenersCountMap['delete'](textEditor);
            _this2._textEditorMouseListenersMap['delete'](textEditor);
            return true;
          } else {
            _this2._textEditorMouseListenersCountMap.set(textEditor, currentCount - 1);
            return false;
          }
        });
        this._textEditorMouseListenersMap.set(textEditor, mouseListener);

        var destroySubscription = textEditor.onDidDestroy(function () {
          mouseListener.dispose();
          _this2._textEditorMouseListenersMap['delete'](textEditor);
          _this2._textEditorMouseListenersCountMap['delete'](textEditor);
          destroySubscription.dispose();
          destroySubscription = null;
        });
      }
      return mouseListener;
    }
  }, {
    key: '_handleMouseMove',
    value: function _handleMouseMove(event) {
      this._textEditorMouseListenersMap.forEach(function (mouseListener) {
        return mouseListener._handleMouseMove(event);
      });
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      this._subscriptions.dispose();
      if (this._mouseMoveListener) {
        this._mouseMoveListener.dispose();
      }
    }
  }]);

  return WindowMouseListener;
})();

var TextEditorMouseListener = (function () {
  function TextEditorMouseListener(textEditor, shouldDispose) {
    _classCallCheck(this, TextEditorMouseListener);

    this._textEditor = textEditor;
    this._textEditorView = atom.views.getView(this._textEditor);

    this._shouldDispose = shouldDispose;
    this._subscriptions = new CompositeDisposable();

    this._emitter = new Emitter();
    this._subscriptions.add(this._emitter);

    this._lastPosition = new Point(0, 0);
  }

  /**
   * Returns the last known text editor screen position under the mouse,
   * initialized to (0, 0).
   */

  _createClass(TextEditorMouseListener, [{
    key: 'getLastPosition',
    value: function getLastPosition() {
      return this._lastPosition;
    }

    /**
     * Calls `fn` when the mouse moves onto another text editor screen position,
     * not pixel position.
     */
  }, {
    key: 'onDidPositionChange',
    value: function onDidPositionChange(fn) {
      return this._emitter.on('did-position-change', fn);
    }
  }, {
    key: 'screenPositionForMouseEvent',
    value: function screenPositionForMouseEvent(event) {
      return this._textEditorView.component.screenPositionForMouseEvent(event);
    }
  }, {
    key: '_handleMouseMove',
    value: function _handleMouseMove(event) {
      var position = this.screenPositionForMouseEvent(event);
      if (position.compare(this._lastPosition) !== 0) {
        this._lastPosition = position;
        this._emitter.emit('did-position-change', {
          nativeEvent: event,
          position: position
        });
      }
    }
  }, {
    key: 'dispose',
    value: function dispose() {
      if (this._shouldDispose()) {
        this._subscriptions.dispose();
      }
    }
  }]);

  return TextEditorMouseListener;
})();

module.exports =
/**
 * Returns an object that tracks the mouse position in a text editor.
 *
 * The positions are in text editor screen coordinates and are rounded down
 * to the last position on each line.
 */
function mouseListenerForTextEditor(textEditor) {
  atom.nuclide = atom.nuclide || {};
  atom.nuclide.windowMouseListener = atom.nuclide.windowMouseListener || new WindowMouseListener();
  return atom.nuclide.windowMouseListener.mouseListenerForTextEditor(textEditor);
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi92YXIvZm9sZGVycy94Zi9yc3BoNF9jNTczMTVyczU3eHhzZHNrcnhudjM2dDAvVC90bXBlbW0ySHVwdWJsaXNoX3BhY2thZ2VzL25wbS9udWNsaWRlLWF0b20taGVscGVycy9saWIvbW91c2UtbGlzdGVuZXItZm9yLXRleHQtZWRpdG9yLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7Ozs7ZUFXNEMsT0FBTyxDQUFDLE1BQU0sQ0FBQzs7SUFBbEUsbUJBQW1CLFlBQW5CLG1CQUFtQjtJQUFFLFVBQVUsWUFBVixVQUFVO0lBQUUsT0FBTyxZQUFQLE9BQU87SUFBRSxLQUFLLFlBQUwsS0FBSzs7QUFPcEQsSUFBSSxhQUFhLEdBQUcsR0FBRyxDQUFDOztJQUVsQixtQkFBbUI7QUFDWixXQURQLG1CQUFtQixHQUNUOzs7MEJBRFYsbUJBQW1COztBQUVyQixRQUFJLENBQUMsY0FBYyxHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQzs7b0JBRS9CLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQzs7UUFBdEMsUUFBUSxhQUFSLFFBQVE7O0FBQ2IsUUFBSSxPQUFPLEdBQUcsUUFBUSxDQUNsQixVQUFBLEtBQUs7YUFBSSxNQUFLLGdCQUFnQixDQUFDLEtBQUssQ0FBQztLQUFBLEVBQ3JDLGFBQWE7bUJBQ0csSUFBSSxDQUFDLENBQUM7QUFDMUIsVUFBTSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUM5QyxRQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxVQUFVLENBQUMsWUFBTTtBQUM3QyxZQUFNLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ2xELENBQUMsQ0FBQzs7QUFFSCxRQUFJLENBQUMsNEJBQTRCLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUM5QyxRQUFJLENBQUMsaUNBQWlDLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUNuRCxRQUFJLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxZQUFNO0FBQzNDLFlBQUssNEJBQTRCLENBQUMsT0FBTyxDQUFDLFVBQUEsUUFBUTtlQUFJLFFBQVEsQ0FBQyxPQUFPLEVBQUU7T0FBQSxDQUFDLENBQUM7QUFDMUUsWUFBSyw0QkFBNEIsQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUMxQyxZQUFLLGlDQUFpQyxDQUFDLEtBQUssRUFBRSxDQUFDO0tBQ2hELENBQUMsQ0FBQyxDQUFDO0dBQ0w7O2VBckJHLG1CQUFtQjs7V0F1Qkcsb0NBQUMsVUFBc0IsRUFBMkI7Ozs7O0FBRzFFLFVBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3hFLFVBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQzs7QUFFbEUsVUFBSSxhQUFhLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUN0RSxVQUFJLENBQUMsYUFBYSxFQUFFO0FBQ2xCLHFCQUFhLEdBQUcsSUFBSSx1QkFBdUIsQ0FBQyxVQUFVLHFCQUFzQixZQUFNO0FBQ2hGLGNBQUksWUFBWSxHQUFHLE9BQUssaUNBQWlDLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUMvRSxjQUFJLFlBQVksS0FBSyxDQUFDLEVBQUU7QUFDdEIsbUJBQUssaUNBQWlDLFVBQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMxRCxtQkFBSyw0QkFBNEIsVUFBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3JELG1CQUFPLElBQUksQ0FBQztXQUNiLE1BQU07QUFDTCxtQkFBSyxpQ0FBaUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQztBQUN6RSxtQkFBTyxLQUFLLENBQUM7V0FDZDtTQUNGLENBQUMsQ0FBQztBQUNILFlBQUksQ0FBQyw0QkFBNEIsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLGFBQWEsQ0FBQyxDQUFDOztBQUVqRSxZQUFJLG1CQUFtQixHQUFHLFVBQVUsQ0FBQyxZQUFZLENBQUMsWUFBTTtBQUN0RCx1QkFBYSxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3hCLGlCQUFLLDRCQUE0QixVQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDckQsaUJBQUssaUNBQWlDLFVBQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUMxRCw2QkFBbUIsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUM5Qiw2QkFBbUIsR0FBRyxJQUFJLENBQUM7U0FDNUIsQ0FBQyxDQUFDO09BQ0o7QUFDRCxhQUFPLGFBQWEsQ0FBQztLQUN0Qjs7O1dBRWUsMEJBQUMsS0FBaUIsRUFBUTtBQUN4QyxVQUFJLENBQUMsNEJBQTRCLENBQUMsT0FBTyxDQUNyQyxVQUFBLGFBQWE7ZUFBSSxhQUFhLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDO09BQUEsQ0FBQyxDQUFDO0tBQzdEOzs7V0FFTSxtQkFBUztBQUNkLFVBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDOUIsVUFBSSxJQUFJLENBQUMsa0JBQWtCLEVBQUU7QUFDM0IsWUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxDQUFDO09BQ25DO0tBQ0Y7OztTQWpFRyxtQkFBbUI7OztJQW9FbkIsdUJBQXVCO0FBQ2hCLFdBRFAsdUJBQXVCLENBQ2YsVUFBc0IsRUFBRSxhQUE0QixFQUFFOzBCQUQ5RCx1QkFBdUI7O0FBRXpCLFFBQUksQ0FBQyxXQUFXLEdBQUcsVUFBVSxDQUFDO0FBQzlCLFFBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDOztBQUU1RCxRQUFJLENBQUMsY0FBYyxHQUFHLGFBQWEsQ0FBQztBQUNwQyxRQUFJLENBQUMsY0FBYyxHQUFHLElBQUksbUJBQW1CLEVBQUUsQ0FBQzs7QUFFaEQsUUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO0FBQzlCLFFBQUksQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQzs7QUFFdkMsUUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7R0FDdEM7Ozs7Ozs7ZUFaRyx1QkFBdUI7O1dBa0JaLDJCQUFVO0FBQ3ZCLGFBQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztLQUMzQjs7Ozs7Ozs7V0FNa0IsNkJBQUMsRUFBd0MsRUFBYztBQUN4RSxhQUFPLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLHFCQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDO0tBQ3BEOzs7V0FFMEIscUNBQUMsS0FBaUIsRUFBUztBQUNwRCxhQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxDQUFDLDJCQUEyQixDQUFDLEtBQUssQ0FBQyxDQUFDO0tBQzFFOzs7V0FFZSwwQkFBQyxLQUFpQixFQUFRO0FBQ3hDLFVBQUksUUFBUSxHQUFHLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN2RCxVQUFJLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUM5QyxZQUFJLENBQUMsYUFBYSxHQUFHLFFBQVEsQ0FBQztBQUM5QixZQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsRUFBRTtBQUN4QyxxQkFBVyxFQUFFLEtBQUs7QUFDbEIsa0JBQVEsRUFBUixRQUFRO1NBQ1QsQ0FBQyxDQUFDO09BQ0o7S0FDRjs7O1dBRU0sbUJBQVM7QUFDZCxVQUFJLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRTtBQUN6QixZQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sRUFBRSxDQUFDO09BQy9CO0tBQ0Y7OztTQWpERyx1QkFBdUI7OztBQW9EN0IsTUFBTSxDQUFDLE9BQU87Ozs7Ozs7QUFPZCxTQUFTLDBCQUEwQixDQUFDLFVBQXNCLEVBQTJCO0FBQ25GLE1BQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUM7QUFDbEMsTUFBSSxDQUFDLE9BQU8sQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixJQUFJLElBQUksbUJBQW1CLEVBQUUsQ0FBQztBQUNqRyxTQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsMEJBQTBCLENBQUMsVUFBVSxDQUFDLENBQUM7Q0FDaEYsQ0FBQyIsImZpbGUiOiIvdmFyL2ZvbGRlcnMveGYvcnNwaDRfYzU3MzE1cnM1N3h4c2Rza3J4bnYzNnQwL1QvdG1wZW1tMkh1cHVibGlzaF9wYWNrYWdlcy9ucG0vbnVjbGlkZS1hdG9tLWhlbHBlcnMvbGliL21vdXNlLWxpc3RlbmVyLWZvci10ZXh0LWVkaXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbnZhciB7Q29tcG9zaXRlRGlzcG9zYWJsZSwgRGlzcG9zYWJsZSwgRW1pdHRlciwgUG9pbnR9ID0gcmVxdWlyZSgnYXRvbScpO1xuXG50eXBlIFBvc2l0aW9uQ2hhbmdlRXZlbnQgPSB7XG4gIG5hdGl2ZUV2ZW50OiBNb3VzZUV2ZW50O1xuICBwb3NpdGlvbjogUG9pbnQ7XG59O1xuXG52YXIgREVCT1VOQ0VfVElNRSA9IDIwMDtcblxuY2xhc3MgV2luZG93TW91c2VMaXN0ZW5lciB7XG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gICAgdmFyIHtkZWJvdW5jZX0gPSByZXF1aXJlKCdudWNsaWRlLWNvbW1vbnMnKTtcbiAgICB2YXIgaGFuZGxlciA9IGRlYm91bmNlKFxuICAgICAgICBldmVudCA9PiB0aGlzLl9oYW5kbGVNb3VzZU1vdmUoZXZlbnQpLFxuICAgICAgICBERUJPVU5DRV9USU1FLFxuICAgICAgICAvKiBpbW1lZGlhdGUgKi8gdHJ1ZSk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZXIpO1xuICAgIHRoaXMuX21vdXNlTW92ZUxpc3RlbmVyID0gbmV3IERpc3Bvc2FibGUoKCkgPT4ge1xuICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIGhhbmRsZXIpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzTWFwID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc0NvdW50TWFwID0gbmV3IE1hcCgpO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMuYWRkKG5ldyBEaXNwb3NhYmxlKCgpID0+IHtcbiAgICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc01hcC5mb3JFYWNoKGxpc3RlbmVyID0+IGxpc3RlbmVyLmRpc3Bvc2UoKSk7XG4gICAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNNYXAuY2xlYXIoKTtcbiAgICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc0NvdW50TWFwLmNsZWFyKCk7XG4gICAgfSkpO1xuICB9XG5cbiAgbW91c2VMaXN0ZW5lckZvclRleHRFZGl0b3IodGV4dEVkaXRvcjogVGV4dEVkaXRvcik6IFRleHRFZGl0b3JNb3VzZUxpc3RlbmVyIHtcbiAgICAvLyBLZWVwIHRyYWNrIG9mIGhvdyBtYW55IG1vdXNlIGxpc3RlbmVycyB3ZXJlIHJldHVybmVkIGZvciB0aGUgdGV4dCBlZGl0b3JcbiAgICAvLyBzbyB3ZSBrbm93IHdoZW4gaXQncyBzYWZlIHRvIGFjdHVhbGx5IGRpc3Bvc2UgaXQuXG4gICAgdmFyIGNvdW50ID0gdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzQ291bnRNYXAuZ2V0KHRleHRFZGl0b3IpIHx8IDA7XG4gICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzQ291bnRNYXAuc2V0KHRleHRFZGl0b3IsIGNvdW50ICsgMSk7XG5cbiAgICB2YXIgbW91c2VMaXN0ZW5lciA9IHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc01hcC5nZXQodGV4dEVkaXRvcik7XG4gICAgaWYgKCFtb3VzZUxpc3RlbmVyKSB7XG4gICAgICBtb3VzZUxpc3RlbmVyID0gbmV3IFRleHRFZGl0b3JNb3VzZUxpc3RlbmVyKHRleHRFZGl0b3IsIC8qIHNob3VsZERpc3Bvc2UgKi8gKCkgPT4ge1xuICAgICAgICB2YXIgY3VycmVudENvdW50ID0gdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzQ291bnRNYXAuZ2V0KHRleHRFZGl0b3IpIHx8IDA7XG4gICAgICAgIGlmIChjdXJyZW50Q291bnQgPT09IDEpIHtcbiAgICAgICAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNDb3VudE1hcC5kZWxldGUodGV4dEVkaXRvcik7XG4gICAgICAgICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzTWFwLmRlbGV0ZSh0ZXh0RWRpdG9yKTtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLl90ZXh0RWRpdG9yTW91c2VMaXN0ZW5lcnNDb3VudE1hcC5zZXQodGV4dEVkaXRvciwgY3VycmVudENvdW50IC0gMSk7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHRoaXMuX3RleHRFZGl0b3JNb3VzZUxpc3RlbmVyc01hcC5zZXQodGV4dEVkaXRvciwgbW91c2VMaXN0ZW5lcik7XG5cbiAgICAgIHZhciBkZXN0cm95U3Vic2NyaXB0aW9uID0gdGV4dEVkaXRvci5vbkRpZERlc3Ryb3koKCkgPT4ge1xuICAgICAgICBtb3VzZUxpc3RlbmVyLmRpc3Bvc2UoKTtcbiAgICAgICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzTWFwLmRlbGV0ZSh0ZXh0RWRpdG9yKTtcbiAgICAgICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzQ291bnRNYXAuZGVsZXRlKHRleHRFZGl0b3IpO1xuICAgICAgICBkZXN0cm95U3Vic2NyaXB0aW9uLmRpc3Bvc2UoKTtcbiAgICAgICAgZGVzdHJveVN1YnNjcmlwdGlvbiA9IG51bGw7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIG1vdXNlTGlzdGVuZXI7XG4gIH1cblxuICBfaGFuZGxlTW91c2VNb3ZlKGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XG4gICAgdGhpcy5fdGV4dEVkaXRvck1vdXNlTGlzdGVuZXJzTWFwLmZvckVhY2goXG4gICAgICAgIG1vdXNlTGlzdGVuZXIgPT4gbW91c2VMaXN0ZW5lci5faGFuZGxlTW91c2VNb3ZlKGV2ZW50KSk7XG4gIH1cblxuICBkaXNwb3NlKCk6IHZvaWQge1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMuZGlzcG9zZSgpO1xuICAgIGlmICh0aGlzLl9tb3VzZU1vdmVMaXN0ZW5lcikge1xuICAgICAgdGhpcy5fbW91c2VNb3ZlTGlzdGVuZXIuZGlzcG9zZSgpO1xuICAgIH1cbiAgfVxufVxuXG5jbGFzcyBUZXh0RWRpdG9yTW91c2VMaXN0ZW5lciB7XG4gIGNvbnN0cnVjdG9yKHRleHRFZGl0b3I6IFRleHRFZGl0b3IsIHNob3VsZERpc3Bvc2U6ICgpID0+IGJvb2xlYW4pIHtcbiAgICB0aGlzLl90ZXh0RWRpdG9yID0gdGV4dEVkaXRvcjtcbiAgICB0aGlzLl90ZXh0RWRpdG9yVmlldyA9IGF0b20udmlld3MuZ2V0Vmlldyh0aGlzLl90ZXh0RWRpdG9yKTtcblxuICAgIHRoaXMuX3Nob3VsZERpc3Bvc2UgPSBzaG91bGREaXNwb3NlO1xuICAgIHRoaXMuX3N1YnNjcmlwdGlvbnMgPSBuZXcgQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gICAgdGhpcy5fZW1pdHRlciA9IG5ldyBFbWl0dGVyKCk7XG4gICAgdGhpcy5fc3Vic2NyaXB0aW9ucy5hZGQodGhpcy5fZW1pdHRlcik7XG5cbiAgICB0aGlzLl9sYXN0UG9zaXRpb24gPSBuZXcgUG9pbnQoMCwgMCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJucyB0aGUgbGFzdCBrbm93biB0ZXh0IGVkaXRvciBzY3JlZW4gcG9zaXRpb24gdW5kZXIgdGhlIG1vdXNlLFxuICAgKiBpbml0aWFsaXplZCB0byAoMCwgMCkuXG4gICAqL1xuICBnZXRMYXN0UG9zaXRpb24oKTogUG9pbnQge1xuICAgIHJldHVybiB0aGlzLl9sYXN0UG9zaXRpb247XG4gIH1cblxuICAvKipcbiAgICogQ2FsbHMgYGZuYCB3aGVuIHRoZSBtb3VzZSBtb3ZlcyBvbnRvIGFub3RoZXIgdGV4dCBlZGl0b3Igc2NyZWVuIHBvc2l0aW9uLFxuICAgKiBub3QgcGl4ZWwgcG9zaXRpb24uXG4gICAqL1xuICBvbkRpZFBvc2l0aW9uQ2hhbmdlKGZuOiAoZXZlbnQ6IFBvc2l0aW9uQ2hhbmdlRXZlbnQpID0+IHZvaWQpOiBEaXNwb3NhYmxlIHtcbiAgICByZXR1cm4gdGhpcy5fZW1pdHRlci5vbignZGlkLXBvc2l0aW9uLWNoYW5nZScsIGZuKTtcbiAgfVxuXG4gIHNjcmVlblBvc2l0aW9uRm9yTW91c2VFdmVudChldmVudDogTW91c2VFdmVudCk6IFBvaW50IHtcbiAgICByZXR1cm4gdGhpcy5fdGV4dEVkaXRvclZpZXcuY29tcG9uZW50LnNjcmVlblBvc2l0aW9uRm9yTW91c2VFdmVudChldmVudCk7XG4gIH1cblxuICBfaGFuZGxlTW91c2VNb3ZlKGV2ZW50OiBNb3VzZUV2ZW50KTogdm9pZCB7XG4gICAgdmFyIHBvc2l0aW9uID0gdGhpcy5zY3JlZW5Qb3NpdGlvbkZvck1vdXNlRXZlbnQoZXZlbnQpO1xuICAgIGlmIChwb3NpdGlvbi5jb21wYXJlKHRoaXMuX2xhc3RQb3NpdGlvbikgIT09IDApIHtcbiAgICAgIHRoaXMuX2xhc3RQb3NpdGlvbiA9IHBvc2l0aW9uO1xuICAgICAgdGhpcy5fZW1pdHRlci5lbWl0KCdkaWQtcG9zaXRpb24tY2hhbmdlJywge1xuICAgICAgICBuYXRpdmVFdmVudDogZXZlbnQsXG4gICAgICAgIHBvc2l0aW9uLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgZGlzcG9zZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5fc2hvdWxkRGlzcG9zZSgpKSB7XG4gICAgICB0aGlzLl9zdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPVxuLyoqXG4gKiBSZXR1cm5zIGFuIG9iamVjdCB0aGF0IHRyYWNrcyB0aGUgbW91c2UgcG9zaXRpb24gaW4gYSB0ZXh0IGVkaXRvci5cbiAqXG4gKiBUaGUgcG9zaXRpb25zIGFyZSBpbiB0ZXh0IGVkaXRvciBzY3JlZW4gY29vcmRpbmF0ZXMgYW5kIGFyZSByb3VuZGVkIGRvd25cbiAqIHRvIHRoZSBsYXN0IHBvc2l0aW9uIG9uIGVhY2ggbGluZS5cbiAqL1xuZnVuY3Rpb24gbW91c2VMaXN0ZW5lckZvclRleHRFZGl0b3IodGV4dEVkaXRvcjogVGV4dEVkaXRvcik6IFRleHRFZGl0b3JNb3VzZUxpc3RlbmVyIHtcbiAgYXRvbS5udWNsaWRlID0gYXRvbS5udWNsaWRlIHx8IHt9O1xuICBhdG9tLm51Y2xpZGUud2luZG93TW91c2VMaXN0ZW5lciA9IGF0b20ubnVjbGlkZS53aW5kb3dNb3VzZUxpc3RlbmVyIHx8IG5ldyBXaW5kb3dNb3VzZUxpc3RlbmVyKCk7XG4gIHJldHVybiBhdG9tLm51Y2xpZGUud2luZG93TW91c2VMaXN0ZW5lci5tb3VzZUxpc3RlbmVyRm9yVGV4dEVkaXRvcih0ZXh0RWRpdG9yKTtcbn07XG4iXX0=
